# Story 7.1: Liquidity Analysis API Integration (Frontend)

## Status
Draft

**Backend Request**: [`docs/request-backend/55-liquidity-api-endpoint.md`](../request-backend/55-liquidity-api-endpoint.md)
**Backend Status**: üü° Pending Implementation

---

## Story

**As a** frontend developer,
**I want** to integrate with the Liquidity Analysis API endpoint,
**so that** I can display turnover data, frozen capital, and liquidation recommendations.

> **Note**: Backend implementation details are in Request #55. This story covers frontend integration work.

---

## Acceptance Criteria

### Frontend Integration Requirements

1. **TypeScript Types**: Create types matching API response contract
2. **API Client Function**: Add `getLiquidity()` and `getLiquidityTrends()` to API client
3. **TanStack Query Hook**: Create `useLiquidity()` hook with:
   - Query parameters: `categoryFilter`, `sortBy`, `sortOrder`, `limit`
   - Caching: `staleTime: 5 min`
   - Error handling
4. **Trends Hook**: Create `useLiquidityTrends()` for historical data
5. **Loading States**: Hook returns `isLoading`, `isError`, `error`
6. **Data Transformation**: Helper functions for liquidity status colors, labels, recommendations

### Integration Testing

7. **Mock API**: MSW handlers for liquidity endpoints
8. **Hook Tests**: Test `useLiquidity` with various parameters
9. **Error Handling**: Test 400, 401, 403, 404, 500, 503 responses

### Blocked Until

10. ‚è≥ Backend implements Request #55
11. ‚è≥ Backend provides test data / staging environment

---

## Tasks / Subtasks

### TypeScript Types (AC: 1)

- [ ] Create types file `src/types/liquidity.ts`
  - [ ] `LiquidityResponse` - full API response
  - [ ] `LiquiditySummary` - summary object
  - [ ] `LiquidityDistribution` - distribution breakdown
  - [ ] `LiquidityBenchmarks` - benchmarks comparison
  - [ ] `LiquidityData` - single SKU data
  - [ ] `LiquidityCategory` - enum type
  - [ ] `ActionType` - enum for actions
  - [ ] `LiquidationScenario` - scenario object
  - [ ] `LiquidityQueryParams` - query parameters
  - [ ] `LiquidityTrendsResponse` - trends response
  - [ ] `TrendDataPoint` - single trend point
  - [ ] `TrendInsight` - insight object

### API Client (AC: 2)

- [ ] Add functions to `src/lib/api.ts`
  ```typescript
  export async function getLiquidity(
    params: LiquidityQueryParams
  ): Promise<LiquidityResponse>

  export async function getLiquidityTrends(
    period?: number
  ): Promise<LiquidityTrendsResponse>
  ```

### TanStack Query Hooks (AC: 3, 4, 5)

- [ ] Create `src/hooks/useLiquidity.ts`
  - [ ] Implement `useLiquidity(options)` hook
  - [ ] Query key: `['liquidity', categoryFilter, sortBy, sortOrder]`
  - [ ] `staleTime: 5 * 60 * 1000` (5 minutes)
  - [ ] Return `{ data, isLoading, isError, error, refetch }`

- [ ] Create `src/hooks/useLiquidityTrends.ts`
  - [ ] Implement `useLiquidityTrends(period)` hook
  - [ ] Query key: `['liquidity-trends', period]`
  - [ ] `staleTime: 30 * 60 * 1000` (30 minutes - historical data changes slowly)

### Helper Functions (AC: 6)

- [ ] Create `src/lib/liquidity-utils.ts`
  - [ ] `getLiquidityStatusColor()` - category to color mapping
  - [ ] `getLiquidityStatusBgColor()` - category to background color
  - [ ] `getLiquidityStatusLabel()` - category to Russian label
  - [ ] `getLiquidityStatusIcon()` - category to emoji
  - [ ] `getLiquidityActionLabel()` - action type to Russian label
  - [ ] `formatTurnoverDays()` - formatting helper
  - [ ] `formatFrozenCapital()` - currency formatting with warning
  - [ ] `getLiquidationRecommendation()` - scenario recommendation text

### MSW Mock Handlers (AC: 7)

- [ ] Create `src/mocks/handlers/liquidity.ts`
  - [ ] Handler for successful response
  - [ ] Handler for trends response
  - [ ] Handler for error responses

### Tests (AC: 8, 9)

- [ ] Create `src/hooks/__tests__/useLiquidity.test.ts`

---

## Dev Notes

### TypeScript Types

```typescript
// src/types/liquidity.ts

export type LiquidityCategory = 'highly_liquid' | 'medium_liquid' | 'low_liquid' | 'illiquid';
export type ActionType = 'MAXIMIZE' | 'MAINTAIN' | 'REDUCE' | 'LIQUIDATE';
export type BenchmarkStatus = 'excellent' | 'good' | 'warning' | 'critical';

export interface LiquidationScenario {
  target_days: number;
  required_velocity: number;
  velocity_multiplier: number;
  suggested_discount_pct: number;
  new_price: number;
  expected_revenue: number;
  expected_profit: number;
  is_profitable: boolean;
}

export interface LiquidityData {
  sku_id: string;
  product_name: string;
  category: string;
  brand: string;

  current_stock_qty: number;
  avg_stock_qty_30d: number;
  stock_value: number;

  units_sold_30d: number;
  velocity_per_day: number;

  turnover_days: number;
  liquidity_category: LiquidityCategory;

  current_price: number;
  cogs_per_unit: number;

  recommendation: string;
  action_type: ActionType;

  liquidation_scenarios: LiquidationScenario[] | null;
}

export interface LiquidityDistributionItem {
  count: number;
  value: number;
  pct: number;
  avg_turnover_days: number;
}

export interface LiquidityDistribution {
  highly_liquid: LiquidityDistributionItem;
  medium_liquid: LiquidityDistributionItem;
  low_liquid: LiquidityDistributionItem;
  illiquid: LiquidityDistributionItem;
}

export interface LiquidityBenchmarks {
  your_avg_turnover: number;
  target_avg_turnover: number;
  industry_avg_turnover: number;
  highly_liquid_pct: number;
  target_highly_liquid_pct: number;
  illiquid_pct: number;
  target_illiquid_pct: number;
  overall_status: BenchmarkStatus;
}

export interface LiquiditySummary {
  total_inventory_value: number;
  total_sku_count: number;
  frozen_capital: number;
  frozen_capital_pct: number;
  avg_turnover_days: number;
  distribution: LiquidityDistribution;
  benchmarks: LiquidityBenchmarks;
}

export interface LiquidityResponse {
  meta: {
    cabinet_id: string;
    analysis_period_days: number;
    generated_at: string;
    stock_data_updated_at: string;
  };
  summary: LiquiditySummary;
  data: LiquidityData[];
}

export interface LiquidityQueryParams {
  category_filter?: LiquidityCategory | 'all';
  sort_by?: string;
  sort_order?: 'asc' | 'desc';
  limit?: number;
  include_liquidation_scenarios?: boolean;
}

// Trends Types
export interface TrendDistribution {
  highly_liquid_pct: number;
  medium_liquid_pct: number;
  low_liquid_pct: number;
  illiquid_pct: number;
}

export interface TrendDataPoint {
  date: string;
  distribution: TrendDistribution;
  frozen_capital: number;
  avg_turnover_days: number;
}

export interface TrendInsight {
  type: 'improvement' | 'warning' | 'info';
  message: string;
}

export interface LiquidityTrendsResponse {
  meta: {
    cabinet_id: string;
    period_days: number;
    generated_at: string;
  };
  trends: TrendDataPoint[];
  insights: TrendInsight[];
}
```

### Hook Implementation

```typescript
// src/hooks/useLiquidity.ts
import { useQuery } from '@tanstack/react-query';
import { apiClient } from '@/lib/api';
import type { LiquidityResponse, LiquidityQueryParams } from '@/types/liquidity';

export function useLiquidity(params: LiquidityQueryParams = {}) {
  return useQuery<LiquidityResponse>({
    queryKey: [
      'liquidity',
      params.category_filter,
      params.sort_by,
      params.sort_order,
      params.limit
    ],
    queryFn: async () => {
      const searchParams = new URLSearchParams();
      if (params.category_filter) searchParams.set('category_filter', params.category_filter);
      if (params.sort_by) searchParams.set('sort_by', params.sort_by);
      if (params.sort_order) searchParams.set('sort_order', params.sort_order);
      if (params.limit) searchParams.set('limit', String(params.limit));
      if (params.include_liquidation_scenarios !== undefined) {
        searchParams.set('include_liquidation_scenarios', String(params.include_liquidation_scenarios));
      }

      return apiClient.get(`/v1/analytics/liquidity?${searchParams}`);
    },
    staleTime: 5 * 60 * 1000, // 5 minutes
    gcTime: 30 * 60 * 1000, // 30 minutes
  });
}
```

```typescript
// src/hooks/useLiquidityTrends.ts
import { useQuery } from '@tanstack/react-query';
import { apiClient } from '@/lib/api';
import type { LiquidityTrendsResponse } from '@/types/liquidity';

export function useLiquidityTrends(period: number = 90) {
  return useQuery<LiquidityTrendsResponse>({
    queryKey: ['liquidity-trends', period],
    queryFn: async () => {
      return apiClient.get(`/v1/analytics/liquidity/trends?period=${period}`);
    },
    staleTime: 30 * 60 * 1000, // 30 minutes (historical data)
    gcTime: 60 * 60 * 1000, // 1 hour
  });
}
```

### Helper Functions

```typescript
// src/lib/liquidity-utils.ts
import type { LiquidityCategory, ActionType, BenchmarkStatus } from '@/types/liquidity';

export function getLiquidityStatusColor(category: LiquidityCategory): string {
  const colors: Record<LiquidityCategory, string> = {
    highly_liquid: '#22C55E', // green-500
    medium_liquid: '#EAB308', // yellow-500
    low_liquid: '#F97316',    // orange-500
    illiquid: '#EF4444',      // red-500
  };
  return colors[category];
}

export function getLiquidityStatusBgColor(category: LiquidityCategory): string {
  const colors: Record<LiquidityCategory, string> = {
    highly_liquid: '#D1FAE5', // green-100
    medium_liquid: '#FEF9C3', // yellow-100
    low_liquid: '#FED7AA',    // orange-200
    illiquid: '#FEE2E2',      // red-100
  };
  return colors[category];
}

export function getLiquidityStatusLabel(category: LiquidityCategory): string {
  const labels: Record<LiquidityCategory, string> = {
    highly_liquid: '–í—ã—Å–æ–∫–æ–ª–∏–∫–≤–∏–¥–Ω—ã–π',
    medium_liquid: '–°—Ä–µ–¥–Ω—è—è –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å',
    low_liquid: '–ù–∏–∑–∫–∞—è –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å',
    illiquid: '–ù–µ–ª–∏–∫–≤–∏–¥',
  };
  return labels[category];
}

export function getLiquidityStatusIcon(category: LiquidityCategory): string {
  const icons: Record<LiquidityCategory, string> = {
    highly_liquid: 'üü¢',
    medium_liquid: 'üü°',
    low_liquid: 'üü†',
    illiquid: 'üî¥',
  };
  return icons[category];
}

export function getLiquidityActionLabel(action: ActionType): string {
  const labels: Record<ActionType, string> = {
    MAXIMIZE: '–ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞—Ç—å',
    MAINTAIN: '–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å',
    REDUCE: '–°–æ–∫—Ä–∞—Ç–∏—Ç—å',
    LIQUIDATE: '–õ–∏–∫–≤–∏–¥–∏—Ä–æ–≤–∞—Ç—å',
  };
  return labels[action];
}

export function getLiquidityActionButtonLabel(action: ActionType): string {
  const labels: Record<ActionType, string> = {
    MAXIMIZE: '–£–≤–µ–ª–∏—á–∏—Ç—å –∑–∞–∫—É–ø–∫–∏',
    MAINTAIN: '–û–ö',
    REDUCE: '–°–æ–∫—Ä–∞—Ç–∏—Ç—å',
    LIQUIDATE: '–°–∫–∏–¥–∫–∞',
  };
  return labels[action];
}

export function getBenchmarkStatusColor(status: BenchmarkStatus): string {
  const colors: Record<BenchmarkStatus, string> = {
    excellent: '#22C55E',
    good: '#84CC16',
    warning: '#F97316',
    critical: '#EF4444',
  };
  return colors[status];
}

export function getBenchmarkStatusLabel(status: BenchmarkStatus): string {
  const labels: Record<BenchmarkStatus, string> = {
    excellent: '–û—Ç–ª–∏—á–Ω–æ',
    good: '–•–æ—Ä–æ—à–æ',
    warning: '–í–Ω–∏–º–∞–Ω–∏–µ',
    critical: '–ö—Ä–∏—Ç–∏—á–Ω–æ',
  };
  return labels[status];
}

export function formatTurnoverDays(days: number): string {
  if (days >= 999) return '–ù–µ—Ç –ø—Ä–æ–¥–∞–∂';
  if (days === 1) return '1 –¥–µ–Ω—å';
  if (days < 5) return `${days} –¥–Ω—è`;
  return `${days} –¥–Ω–µ–π`;
}

export function formatFrozenCapitalWarning(pct: number): string | null {
  if (pct > 10) return 'üö® –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤—ã—Å–æ–∫–∏–π —É—Ä–æ–≤–µ–Ω—å';
  if (pct > 5) return '‚ö†Ô∏è –í—ã—à–µ –Ω–æ—Ä–º—ã';
  return null;
}

export function getTargetShare(category: LiquidityCategory): string {
  const shares: Record<LiquidityCategory, string> = {
    highly_liquid: '> 50%',
    medium_liquid: '30-40%',
    low_liquid: '< 15%',
    illiquid: '< 5%',
  };
  return shares[category];
}
```

### File Structure

```
src/
‚îú‚îÄ‚îÄ types/
‚îÇ   ‚îî‚îÄ‚îÄ liquidity.ts              ‚Üê NEW
‚îú‚îÄ‚îÄ hooks/
‚îÇ   ‚îú‚îÄ‚îÄ useLiquidity.ts           ‚Üê NEW
‚îÇ   ‚îî‚îÄ‚îÄ useLiquidityTrends.ts     ‚Üê NEW
‚îú‚îÄ‚îÄ lib/
‚îÇ   ‚îú‚îÄ‚îÄ api.ts                    ‚Üê Add getLiquidity, getLiquidityTrends
‚îÇ   ‚îî‚îÄ‚îÄ liquidity-utils.ts        ‚Üê NEW
‚îî‚îÄ‚îÄ mocks/
    ‚îî‚îÄ‚îÄ handlers/
        ‚îî‚îÄ‚îÄ liquidity.ts          ‚Üê NEW
```

---

## Definition of Done

### Frontend (This Story)
- [ ] TypeScript types created and exported
- [ ] `useLiquidity` hook implemented
- [ ] `useLiquidityTrends` hook implemented
- [ ] API client functions added
- [ ] Helper functions created (12 functions)
- [ ] MSW mock handlers created
- [ ] Unit tests for hooks pass
- [ ] Types match API contract from Request #55

### Backend (Request #55) - Tracked Separately
- [ ] ‚è≥ Backend implements endpoint
- [ ] ‚è≥ Backend implements trends endpoint
- [ ] ‚è≥ Backend provides staging environment
- [ ] ‚è≥ Integration tested with real API

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-09 | 1.0 | Initial story creation | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used
_(To be populated by dev agent)_

### Completion Notes List
_(To be populated by dev agent)_

### File List
_(To be populated by dev agent)_

---

## QA Results
_(To be populated by QA)_
