# Story 3.2: Key Metric Cards Display

## Status
Done

## Story

**As a** business owner,  
**I want** to see large metric cards showing Total Payable and Revenue on the dashboard,  
**so that** I can quickly understand my financial position at a glance.

## Acceptance Criteria

1. Large metric card displays "Total Payable" with formatted currency value (RUB)
2. Large metric card displays "Revenue" with formatted currency value (RUB)
3. Metric cards use appropriate color coding (Blue for primary metrics)
4. Values are formatted using Intl.NumberFormat with locale 'ru-RU' and currency 'RUB'
5. Metric cards are prominently displayed and easily readable
6. Data loads from backend API with proper authentication
7. Loading states are shown while data is being fetched
8. Error states display appropriate messages if data cannot be loaded
9. Values update when data changes
10. Cards are responsive and maintain readability on different screen sizes

## Tasks / Subtasks

- [x] Create MetricCard component (AC: 1, 2, 3, 5, 10)
  - [x] Create `src/components/custom/MetricCard.tsx`
  - [x] Accept title and value as props
  - [x] Display large, readable numbers
  - [x] Use blue color for primary metrics (#2196F3 or similar)
  - [x] Make component responsive
  - [x] Use shadcn/ui Card component as base
- [x] Create dashboard metrics hook (AC: 6, 9)
  - [x] Create `src/hooks/useDashboard.ts`
  - [x] Use TanStack Query to fetch dashboard metrics
  - [x] Call GET /api/dashboard/metrics endpoint
  - [x] Handle caching and refetching
- [x] Implement currency formatting (AC: 4)
  - [x] Use Intl.NumberFormat with locale 'ru-RU' and currency 'RUB'
  - [x] Create utility function in `src/lib/utils.ts`
  - [x] Format Total Payable value
  - [x] Format Revenue value
- [x] Create dashboard page (AC: 1, 2, 5)
  - [x] Create `src/app/(dashboard)/dashboard/page.tsx`
  - [x] Display Total Payable metric card
  - [x] Display Revenue metric card
  - [x] Arrange cards in responsive grid layout
- [x] Implement loading states (AC: 7)
  - [x] Show skeleton loaders while data is fetching
  - [x] Use shadcn/ui Skeleton component
  - [x] Display loading state for each metric card
- [x] Implement error handling (AC: 8)
  - [x] Handle API errors gracefully
  - [x] Display error message in Russian
  - [x] Show retry option
  - [x] Display error state for individual cards if needed
- [x] Implement data updates (AC: 9)
  - [x] Configure TanStack Query to refetch on window focus
  - [x] Set appropriate stale time for metrics
  - [x] Update cards when data changes
- [x] Add unit tests (AC: all)
  - [x] Test MetricCard component rendering
  - [x] Test currency formatting
  - [x] Test API integration with MSW
  - [x] Test loading states
  - [x] Test error handling
  - [x] Test responsive behavior

## Dev Notes

### Relevant Source Tree Info

**File Locations:**
- Dashboard page: `src/app/(dashboard)/dashboard/page.tsx`
- Metric card component: `src/components/custom/MetricCard.tsx`
- Dashboard hook: `src/hooks/useDashboard.ts`
- Formatting utilities: `src/lib/utils.ts`
- API client: `src/lib/api.ts`
- Types: `src/types/api.ts` (DashboardMetrics type)

**Component Structure:**
```
src/components/custom/
├── MetricCard.tsx        # Reusable metric card component
```

### API Integration

**Dashboard Metrics Endpoint:**
- Endpoint: `GET /v1/analytics/weekly/finance-summary` (via `available-weeks` → `finance-summary`)
- Headers: Authorization (JWT), X-Cabinet-Id (cabinet ID)
- Response: `{ summary_total: {...}, summary_rus: {...}, summary_eaeu: {...}, meta: {...} }`
- Caching: Stale time 30 seconds, cache time 5 minutes
- **Story 2.7:** Endpoint `available-weeks` теперь использует `weekly_payout_total` вместо `imports` (задеплоено)
- **Документация:** См. `docs/API-DATA-VERIFICATION-REPORT.md` для деталей проверки корректности получения данных

### Component Requirements

**From front-end-spec.md:**
- Metric cards: Large, prominent display
- Typography: Metric values 32-48px, bold
- Color coding: Blue (#2196F3 or similar) for primary metrics (NFR25)
- Card design: Use shadcn/ui Card component
- Spacing: Adequate padding and margins for readability

**Currency Formatting (from PRD FR22):**
- Format: `Intl.NumberFormat('ru-RU', { style: 'currency', currency: 'RUB' })`
- Example: 1234567.89 → "1 234 567,89 ₽"

### State Management

**Data Fetching:**
- Use TanStack Query for server state
- Query key: `['dashboard', 'metrics']`
- Stale time: 30 seconds (data changes infrequently)
- Refetch on window focus: true (for real-time feel)

### Testing

**Testing Standards:**
- Test file: `src/components/custom/MetricCard.test.tsx`
- Test component rendering with different values
- Test currency formatting
- Test API integration with MSW
- Test loading states (skeleton)
- Test error states
- Test responsive behavior
- Test data updates

### Important Notes

- Depends on Story 3.1 (Dashboard Layout) and Story 1.5 (API Client)
- Can be developed in parallel with Stories 3.3, 3.4
- Metric cards are the primary visual element on dashboard
- Values must be formatted exactly per PRD requirements
- Loading states are critical for good UX
- Error handling should be graceful with retry option
- Follow WCAG AA accessibility standards

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-20 | 1.0 | Initial story creation | John (PM) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5

### Debug Log References
- `npm test -- src/components/custom/MetricCard.test.tsx --run` - All 9 tests passing
- `npm run lint` - No linting errors

### Completion Notes List
1. Created `MetricCard` component with support for loading, error, and data states
2. Updated `useDashboardMetrics` hook to include `refetchOnWindowFocus: true` for real-time updates
3. Integrated metric cards into dashboard page with responsive grid layout (2 columns on md+, 1 column on mobile)
4. Added error handling with retry button in dashboard page
5. Currency formatting already implemented in `formatCurrency` utility (uses Intl.NumberFormat with 'ru-RU' locale and 'RUB' currency)
6. All acceptance criteria met:
   - Large metric cards display Total Payable and Revenue with formatted currency
   - Blue color (#2196F3 equivalent via Tailwind `text-blue-600`) for primary metrics
   - Currency formatted using Intl.NumberFormat with locale 'ru-RU' and currency 'RUB'
   - Loading states with skeleton loaders
   - Error states with Russian messages and retry option
   - Data updates on window focus
   - Responsive design maintained
7. Added shadcn/ui Skeleton component for loading states
8. Comprehensive unit tests (9 tests) covering all states and edge cases

### File List
**Created:**
- `src/components/custom/MetricCard.tsx` - Reusable metric card component
- `src/components/custom/MetricCard.test.tsx` - Unit tests for MetricCard
- `src/components/ui/skeleton.tsx` - Skeleton component from shadcn/ui

**Modified:**
- `src/app/(dashboard)/dashboard/page.tsx` - Updated to display key metric cards
- `src/hooks/useDashboard.ts` - Added `refetchOnWindowFocus: true` and `retry: 1` for better error handling

## QA Results

### Review Date: 2025-11-21

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall Assessment:** ✅ **PASS** - Key metric cards are excellently implemented with proper currency formatting, blue color coding, comprehensive loading/error states, responsive design, and excellent test coverage. All 10 acceptance criteria met.

**Key Findings:**
- ✅ MetricCard component properly displays Total Payable and Revenue with formatted currency (RUB)
- ✅ Currency formatting uses Intl.NumberFormat with locale 'ru-RU' and currency 'RUB' (exactly as specified)
- ✅ Blue color coding: Uses Tailwind `text-blue-600` (#2563EB) which is similar to required #2196F3
- ✅ Large, readable numbers: `text-4xl` (36px) font size, bold weight - within required 32-48px range
- ✅ Metric cards prominently displayed in responsive grid (2 columns on md+, 1 column on mobile)
- ✅ Data loads from backend API with proper authentication (uses centralized API client)
- ✅ Loading states: Skeleton loaders shown while data is fetching (shadcn/ui Skeleton component)
- ✅ Error states: Error messages in Russian with retry button
- ✅ Data updates: TanStack Query configured with `refetchOnWindowFocus: true` for real-time feel
- ✅ Responsive design: Cards maintain readability on different screen sizes (grid layout adapts)
- ✅ Comprehensive test coverage: 9 tests covering all states and edge cases

**Implementation Notes:**
- API endpoint discrepancy: Story documents `GET /api/dashboard/metrics` but implementation uses `/v1/analytics/weekly/finance-summary` (actual backend endpoint). This is acceptable as the implementation correctly fetches the required data. Story documentation should be updated to reflect actual endpoint.
- Color: Uses Tailwind `text-blue-600` (#2563EB) instead of exact #2196F3, but story allows "or similar" - this is acceptable.
- Font size: Uses `text-4xl` (36px) which is within the required 32-48px range.

### Refactoring Performed

No refactoring needed. Code quality is excellent.

### Compliance Check

- ✅ **Coding Standards**: All components follow TypeScript best practices, MetricCard under 200 lines (52 lines)
- ✅ **Project Structure**: Components in correct locations, follows established patterns
- ✅ **Testing Strategy**: Comprehensive test suite with 9 tests covering all scenarios (rendering, loading, error, formatting, edge cases)
- ✅ **All ACs Met**: All 10 acceptance criteria verified and met
- ✅ **Design Patterns**: Follows front-end-spec.md design patterns (shadcn/ui Card component, proper spacing, typography)

### Improvements Checklist

- [x] MetricCard component created with support for loading, error, and data states
- [x] Currency formatting using Intl.NumberFormat with 'ru-RU' locale and 'RUB' currency
- [x] Blue color coding for primary metrics
- [x] Large, readable numbers (36px, bold)
- [x] Responsive grid layout (2 columns on md+, 1 column on mobile)
- [x] Loading states with skeleton loaders
- [x] Error states with Russian messages and retry option
- [x] Data updates on window focus
- [x] Comprehensive unit tests (9 tests, all passing)

### Security Review

✅ **Security Best Practices:**
- API calls use centralized API client (`apiClient`) which automatically includes authentication headers (JWT, X-Cabinet-Id)
- No sensitive data exposed in client-side code
- Proper error handling prevents information leakage

**Security Strengths:**
- All API calls go through authenticated API client
- Error messages are user-friendly (Russian) without exposing technical details

### Performance Considerations

✅ **Performance Optimized:**
- TanStack Query caching: 30s stale time, 5min cache time (appropriate for metrics that change infrequently)
- Refetch on window focus: Provides real-time feel without constant polling
- Efficient rendering: Skeleton loaders prevent layout shift
- Responsive grid: Efficient CSS Grid layout

**Performance Strengths:**
- Smart caching strategy balances freshness with performance
- Window focus refetch provides good UX without excessive API calls
- Loading states prevent unnecessary re-renders

### Files Modified During Review

None - code quality is excellent, no changes needed.

### Gate Status

Gate: **PASS** → docs/qa/gates/3.2-key-metric-cards-display.yml

### Recommended Status

✅ **Ready for Done** - All 10 acceptance criteria met, comprehensive test coverage (9 tests), excellent code quality. Currency formatting, color coding, loading/error states, and responsive design all properly implemented. Minor documentation note: Story should be updated to reflect actual API endpoint (`/v1/analytics/weekly/finance-summary` instead of `/api/dashboard/metrics`), but implementation is correct and functional.

