# Story 6.4: Supply Planning Integration & Testing

## Status
Draft

---

## Story

**As a** QA engineer,
**I want** comprehensive test coverage for the Supply Planning feature,
**so that** we can ensure stockout predictions and recommendations are accurate.

---

## Acceptance Criteria

### Integration Testing

1. **Frontend-Backend Integration**: API calls work correctly
2. **Data Accuracy**: Displayed values match backend calculations
3. **Status Classification**: Critical/Warning/Monitor/Safe correct
4. **Calculations**: Days until stockout, reorder qty accurate
5. **Error Handling**: All error scenarios handled gracefully

### End-to-End Testing

6. **Happy Path**: User views supply planning page with data
7. **Planning Horizon**: Changing horizon updates calculations
8. **Status Filter**: Card clicks filter table correctly
9. **Table Sorting**: All sortable columns work
10. **Detail Panel**: Expand/collapse works with correct data
11. **Search**: Search by SKU/name works

### Performance Testing

12. **Response Time**: Page loads in <3s with 100 SKUs
13. **Large Dataset**: Page handles 500 SKUs without issues
14. **Real-time Feel**: Status cards update without page refresh

### Edge Case Testing

15. **Zero Velocity**: Products with no recent sales
16. **Out of Stock**: Products with stock_qty = 0
17. **New Products**: Products with <7 days history
18. **No COGS**: Products without cost data

---

## Tasks / Subtasks

### Unit Tests

- [ ] Test `useSupplyPlanning` hook
  - [ ] Successful data fetch
  - [ ] Different planning horizons
  - [ ] Error handling
  - [ ] Caching behavior

- [ ] Test helper functions
  - [ ] `getStockoutStatusColor()`
  - [ ] `getStockoutStatusLabel()`
  - [ ] `formatDaysUntilStockout()`

- [ ] Test components
  - [ ] `SupplyRiskCards` - renders 4 cards with correct data
  - [ ] `SupplyPlanningTable` - renders columns, sorts
  - [ ] `SupplyPlanningDetail` - renders all sections

### Integration Tests

- [ ] API endpoint with MSW
  - [ ] GET with default parameters
  - [ ] GET with planning_horizon variations
  - [ ] GET with status_filter
  - [ ] Error responses (401, 403, 404, 500, 503)

### E2E Tests (Playwright)

- [ ] Happy path test
  ```typescript
  test('Supply Planning page displays data', async ({ page }) => {
    await page.goto('/analytics/supply-planning');
    await expect(page.locator('h1')).toContainText('ÐŸÐ»Ð°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¿Ð¾ÑÑ‚Ð°Ð²Ð¾Ðº');
    await expect(page.locator('[data-testid="risk-cards"]')).toBeVisible();
    await expect(page.locator('table tbody tr')).toHaveCount(greaterThan(0));
  });
  ```

- [ ] Planning horizon test
  ```typescript
  test('Changing planning horizon updates data', async ({ page }) => {
    await page.goto('/analytics/supply-planning');
    await page.click('[data-testid="horizon-selector"]');
    await page.click('text=7 Ð´Ð½ÐµÐ¹');
    await expect(page.locator('[data-testid="horizon-display"]')).toContainText('7');
    // Verify reorder quantities changed
  });
  ```

- [ ] Status filter test
  ```typescript
  test('Clicking critical card filters table', async ({ page }) => {
    await page.goto('/analytics/supply-planning');
    await page.click('[data-testid="card-critical"]');
    // All visible rows should have critical status
    const rows = page.locator('table tbody tr');
    for (const row of await rows.all()) {
      await expect(row.locator('[data-testid="status-icon"]')).toHaveText('ðŸ”´');
    }
  });
  ```

- [ ] Detail panel test
  ```typescript
  test('Clicking row expands detail panel', async ({ page }) => {
    await page.goto('/analytics/supply-planning');
    await page.click('table tbody tr:first-child');
    await expect(page.locator('[data-testid="detail-panel"]')).toBeVisible();
    await expect(page.locator('[data-testid="forecast-section"]')).toBeVisible();
  });
  ```

### Edge Case Tests

- [ ] Zero velocity handling
  ```typescript
  test('Products with no sales show "ÐÐµÑ‚ Ð¿Ñ€Ð¾Ð´Ð°Ð¶"', async ({ page }) => {
    // Mock product with velocity = 0
    await page.goto('/analytics/supply-planning');
    const zeroVelocityRow = page.locator('tr:has-text("No Sales Product")');
    await expect(zeroVelocityRow.locator('[data-testid="days-stockout"]'))
      .toContainText('ÐÐµÑ‚ Ð¿Ñ€Ð¾Ð´Ð°Ð¶');
  });
  ```

- [ ] Out of stock handling
  ```typescript
  test('Out of stock products show correctly', async ({ page }) => {
    // Mock product with stock_qty = 0
    await page.goto('/analytics/supply-planning');
    const outOfStockRow = page.locator('tr:has-text("Out of Stock Product")');
    await expect(outOfStockRow.locator('[data-testid="stock-qty"]'))
      .toContainText('0');
    await expect(outOfStockRow.locator('[data-testid="status-icon"]'))
      .toHaveText('ðŸ”´');
  });
  ```

### Performance Tests

- [ ] Page load time
  ```typescript
  test('Page loads within 3 seconds', async ({ page }) => {
    const start = Date.now();
    await page.goto('/analytics/supply-planning');
    await page.waitForSelector('table tbody tr');
    const loadTime = Date.now() - start;
    expect(loadTime).toBeLessThan(3000);
  });
  ```

### Accessibility Tests

- [ ] Axe accessibility audit
- [ ] Keyboard navigation
- [ ] Screen reader compatibility

---

## Test Data Fixtures

### Mock Data for MSW

```typescript
// src/mocks/fixtures/supply-planning.json
{
  "summary": {
    "critical_count": 5,
    "warning_count": 12,
    "monitor_count": 20,
    "safe_count": 63,
    "total_sku_count": 100,
    "total_potential_loss_7d": 525000,
    "total_recommended_capital": 1250000
  },
  "data": [
    {
      "sku_id": "12345",
      "product_name": "Widget Pro",
      "stock_qty": 15,
      "in_transit_qty": 0,
      "velocity_units_per_day": 8.2,
      "days_until_stockout": 2,
      "stockout_status": "critical",
      "recommended_reorder_qty": 293,
      "recommended_reorder_value": 131850
    },
    {
      "sku_id": "99999",
      "product_name": "No Sales Product",
      "stock_qty": 50,
      "in_transit_qty": 0,
      "velocity_units_per_day": 0,
      "days_until_stockout": 999,
      "stockout_status": "safe",
      "recommended_reorder_qty": 0,
      "recommended_reorder_value": 0
    }
  ]
}
```

---

## Definition of Done

- [ ] All unit tests pass (>80% coverage)
- [ ] Integration tests pass
- [ ] E2E tests pass on Chrome, Firefox, Safari
- [ ] Edge case tests pass
- [ ] Performance tests pass (<3s load)
- [ ] Accessibility audit passes
- [ ] Test results documented
- [ ] CI pipeline updated

---

## Related Documentation

- **Epic Overview**: `6.0.supply-planning-epic.md`
- **API Story**: `6.1.supply-planning-api-integration.md`
- **Page Story**: `6.2.supply-planning-page-structure.md`
- **Table Story**: `6.3.supply-planning-stockout-table.md`
- **Backend Request**: `docs/request-backend/54-supply-planning-api-endpoint.md`

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-09 | 1.0 | Initial story creation | Sarah (PO) |

---

## Dev Agent Record

_(To be populated by dev agent)_

---

## QA Results

### Review Date: 2025-12-13

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall**: Story **NOT IMPLEMENTED**. Status is "Draft".

### Evidence Search

| Search | Result |
|--------|--------|
| `*supply-planning*.test.ts` | No files |
| `e2e/*supply-planning*.spec.ts` | No files |

### Requirements Traceability

All 18 ACs: âŒ NOT STARTED

### Gate Status

Gate: **FAIL** â†’ `docs/qa/gates/6.4-supply-planning-integration-testing.yml`

### Priority Actions

1. Create hook tests
2. Create component tests
3. Create E2E tests
