# Epic 6: Supply Planning & Stockout Prevention

## Status
üü° In Progress

**Backend Request**: [`docs/request-backend/54-supply-planning-api-endpoint.md`](../request-backend/54-supply-planning-api-endpoint.md)
**Backend Status**: ‚úÖ **COMPLETE** (Epic 28 - completed 2025-12-10)
**Frontend Clarification**: [`docs/request-backend/54-supply-planning-api-endpoint-frontend-clarification.md`](../request-backend/54-supply-planning-api-endpoint-frontend-clarification.md)

---

## Epic Overview

**Priority**: P0 - CRITICAL (Prevents Revenue Loss!)
**Estimated Effort**: 2 weeks
**Business Impact**: üî¥ Prevents 10-20% revenue loss from stockouts
**Source PRD**: `../our_service_full_analytics/phase_one/PAGE_07_SUPPLY_PLANNING.md`

---

## Epic Goal

Provide sellers with predictive stockout alerts and reorder recommendations to prevent revenue loss from out-of-stock situations.

## Business Value

**The Problem**:
```
Scenario: Bestselling SKU runs out of stock

Day 1: Out of stock ‚Üí 10 lost orders √ó 1,000‚ÇΩ = 10,000‚ÇΩ lost
Day 2: Still out ‚Üí 10 orders √ó 1,000‚ÇΩ = 10,000‚ÇΩ lost
Day 3: Still out ‚Üí 10 orders √ó 1,000‚ÇΩ = 10,000‚ÇΩ lost
...
Week 1: 70,000‚ÇΩ lost revenue

Plus hidden costs:
- WB algorithm penalty (lower search ranking)
- Lost customer trust (they buy from competitor)
- Difficult to recover momentum after restock
```

**The Solution**:
- Predictive alerts: "SKU X will run out in 3 days"
- Reorder recommendations: "Order 240 units to avoid stockout"
- Visual dashboard: See all stockout risks at a glance
- In-transit tracking: Know what's coming

**ROI**:
- Prevents 10-20% revenue loss
- Reduces panic orders (expensive rush shipping)
- Optimizes cash flow (don't order too early)
- **Pays for itself in first month**

---

## Stories Breakdown

| Story | Title | Scope | Effort | UX Required | Status |
|-------|-------|-------|--------|-------------|--------|
| 6.1 | API Integration (Frontend) | Frontend | 1-2 days | No | ‚úÖ **COMPLETE** |
| 6.2 | Page Structure & Risk Dashboard | Frontend | 2-3 days | **Yes** | üìã Ready |
| 6.3 | Stockout Table & Detail Panel | Frontend | 2-3 days | **Yes** | üìã Ready |
| 6.4 | Integration & Testing | Full-stack | 2 days | No | üìã Ready |

### Backend Request

| Request | Title | Status |
|---------|-------|--------|
| **#54** | [Supply Planning API Endpoint](../request-backend/54-supply-planning-api-endpoint.md) | ‚úÖ **COMPLETE** (Epic 28) |

---

## Technical Architecture

### Data Flow

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ WB API (Stocks)             ‚îÇ  ‚Üê Real-time stock levels
‚îÇ + inventory_snapshot        ‚îÇ
‚îÇ + orders history            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
            ‚îÇ
            ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ SupplyPlanningService       ‚îÇ  ‚Üê NEW service
‚îÇ - Calculate order velocity  ‚îÇ
‚îÇ - Days until stockout       ‚îÇ
‚îÇ - Reorder recommendations   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
            ‚îÇ
            ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ GET /v1/analytics/          ‚îÇ  ‚Üê NEW endpoint
‚îÇ     supply-planning         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
            ‚îÇ
            ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Frontend Page               ‚îÇ  ‚Üê NEW page
‚îÇ /analytics/supply-planning  ‚îÇ
‚îÇ - Risk summary cards        ‚îÇ
‚îÇ - Stockout table            ‚îÇ
‚îÇ - Detail panels             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Key Formulas

**Order Velocity (7-day rolling average)**:
```javascript
velocity = total_units_sold_last_7_days / 7;
```

**Days Until Stockout**:
```javascript
days_until_stockout = (current_stock + in_transit) / velocity;
```

**Recommended Reorder Quantity**:
```javascript
expected_demand = velocity √ó planning_horizon;
target_stock = expected_demand √ó (1 + safety_buffer);
reorder_qty = target_stock - (current_stock + in_transit);
```

### Risk Status Classification (Backend Epic 28)

| Status | Days Until Stockout | Color | Icon | Label (RU) |
|--------|---------------------|-------|------|------------|
| `out_of_stock` | N/A (stock=0) | Black (#000000) | ‚ö´ | –ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏ |
| `critical` | 0-7 days | Red (#EF4444) | üî¥ | –ö—Ä–∏—Ç–∏—á–Ω–æ |
| `warning` | 7-14 days | Orange (#F97316) | üü† | –í–Ω–∏–º–∞–Ω–∏–µ |
| `low` | 14-30 days | Yellow (#EAB308) | üü° | –ù–∏–∑–∫–∏–π —Ä–∏—Å–∫ |
| `healthy` | >30 days | Green (#22C55E) | üü¢ | –í –Ω–æ—Ä–º–µ |

> **Note**: Status names updated per Backend Epic 28 implementation (differs from original design).

---

## Data Dependencies

### Required from Backend (Request #54)

**New Tables**:
- `in_transit_shipments` - Track incoming shipments
- Or: Extend existing `inventory_snapshot`

**Required Data**:
- Current stock levels (from WB API)
- Order history (for velocity calculation)
- COGS (for reorder value calculation)

### Existing Data We Can Use

| Data | Source | Available |
|------|--------|-----------|
| Order history | `wb_finance_raw` / sales data | ‚ö†Ô∏è Partial |
| Stock levels | WB API `/stocks` | ‚ö†Ô∏è Needs integration |
| COGS | `cogs` table | ‚úÖ Yes |
| Product info | `products` table | ‚úÖ Yes |

---

## API Contract Summary

### Endpoint: `GET /v1/analytics/supply-planning`

**Query Parameters**:
| Parameter | Type | Default | Description |
|-----------|------|---------|-------------|
| `planning_horizon` | number | 30 | Days: 7, 14, 30, 60 |
| `safety_buffer` | number | 25 | Percent: 15-50 |
| `status_filter` | enum | "all" | out_of_stock, critical, warning, low, healthy, all |
| `sort_by` | string | "days_until_stockout" | Sort field |
| `sort_order` | enum | "asc" | asc, desc |

**Response Summary** (5 —Å—Ç–∞—Ç—É—Å–æ–≤):
```json
{
  "summary": {
    "out_of_stock_count": 3,
    "critical_count": 5,
    "warning_count": 12,
    "low_count": 20,
    "healthy_count": 63,
    "total_potential_loss_7d": 525000,
    "total_recommended_capital": 1250000
  },
  "data": [/* SKU-level data */]
}
```

Full API spec in **Request #54**.

---

## Compatibility Requirements

- [ ] Existing APIs remain unchanged
- [ ] Database changes are additive (new table only)
- [ ] UI follows existing design patterns
- [ ] Performance: <800ms response time for p95
- [ ] No breaking changes to existing analytics

---

## Risk Mitigation

**Primary Risk**: WB API stock data not available or delayed
**Mitigation**:
- Use cached data with timestamp
- Show "Last updated" indicator
- Allow manual refresh

**Secondary Risk**: Order velocity inaccurate for new products
**Mitigation**:
- Minimum 7 days of data required
- Show "Insufficient data" for new products
- Allow manual velocity override

**Rollback Plan**: Feature flag `FEATURE_SUPPLY_PLANNING=false`

---

## Definition of Done

- [ ] All 4 stories completed with acceptance criteria met
- [ ] Backend API responds in <800ms
- [ ] Risk summary cards display correctly
- [ ] Stockout table with all columns functional
- [ ] Detail panel shows forecast
- [ ] Export to CSV functional
- [ ] Unit tests coverage >80%
- [ ] E2E tests for critical flows
- [ ] No regression in existing analytics

---

## Dependencies

| Dependency | Status | Notes |
|------------|--------|-------|
| Epic 5 (Unit Economics) | üü° In Progress | Can develop in parallel |
| WB API stock integration | ‚ö†Ô∏è Required | Need `/stocks` endpoint |
| Order history data | ‚ö†Ô∏è Partial | May need additional import |

---

## UX/UI Expert Sections

> **‚úÖ UX REVIEW COMPLETE (2025-12-12)** ‚Äî —Å–º. [`6.UX-ANSWERS-SUPPLY-PLANNING.md`](./6.UX-ANSWERS-SUPPLY-PLANNING.md)

### UX Deliverables Status

| Deliverable | Status | Location |
|-------------|--------|----------|
| Risk dashboard cards design (5 cards) | ‚úÖ Complete | Story 6.2 |
| Stockout table layout | ‚úÖ Complete | Story 6.3 |
| Detail panel design | ‚úÖ Complete | Story 6.3 |
| Color palette (5 statuses) | ‚úÖ Complete | UX Answers Q1-Q2 |
| Mobile responsive breakpoints | ‚úÖ Complete | Stories 6.2, 6.3 |
| Empty states | ‚úÖ Complete | Story 6.2 |
| Action buttons design | ‚úÖ Complete | Story 6.3 |
| Warehouse tooltip (Q4) | ‚úÖ Complete | Story 6.3 |
| COGS missing indicator (Q5) | ‚úÖ Complete | Story 6.3 |
| Velocity trend icons (Q6) | ‚úÖ Complete | Story 6.3 |

### Design Questions ‚Äî Resolved

| Question | Decision |
|----------|----------|
| Detail panel: expandable row or modal? | **Expandable row** (multiple open allowed) |
| Shopping cart sidebar - MVP? | **No** ‚Äî Future v2 |
| Alert badges design | **Red badge** —Å —á–∏—Å–ª–æ–º (critical + out_of_stock count) |
| Risk card click behavior | **Filter** (click again = clear filter) |

---

## Related Documentation

### Backend Request
- **Request #54**: `docs/request-backend/54-supply-planning-api-endpoint.md`

### Source Documents
- **Source PRD**: `../our_service_full_analytics/phase_one/PAGE_07_SUPPLY_PLANNING.md`
- **API Plan**: `../our_service_full_analytics/phase_one/API_INTEGRATION_PLAN.md`

### Related Epics
- **Epic 5**: Unit Economics (parallel development)
- **Epic 7**: Liquidity Analysis (next priority)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-09 | 1.0 | Initial epic creation | Sarah (PO) |
| 2025-12-12 | 1.1 | Backend Epic 28 complete, Story 6.1 complete, risk statuses updated | Claude Opus 4.5 |
| 2025-12-12 | 2.0 | **UX Review Complete**: All 9 UX questions answered, Stories 6.2 & 6.3 updated with 5 statuses, new designs | Sally (UX Expert) |

---

**Next Steps**:
1. ‚úÖ ~~Review stories 6.1-6.4~~
2. ‚úÖ ~~UX Expert to provide design specifications~~ (—Å–º. `6.UX-ANSWERS-SUPPLY-PLANNING.md`)
3. ‚úÖ ~~Backend team to implement Request #54~~ (Epic 28 complete)
4. üî≤ Frontend to implement Stories 6.2, 6.3, 6.4

---

## QA Results

### Review Date: 2025-12-13

### Reviewed By: Quinn (Test Architect)

### Epic Structure Assessment

**Overall Status**: ‚úÖ **WELL-STRUCTURED & IMPLEMENTATION IN PROGRESS**

**Validated Components**:
1. ‚úÖ Backend API complete (Epic 28)
2. ‚úÖ Frontend types created (`src/types/supply-planning.ts`)
3. ‚úÖ API client implemented (`src/lib/api/supply-planning.ts`)
4. ‚úÖ Hooks implemented (`src/hooks/useSupplyPlanning.ts`)
5. ‚úÖ Utils library complete (`src/lib/supply-planning-utils.ts`)
6. ‚úÖ Page structure created (`/analytics/supply-planning/page.tsx`)
7. ‚úÖ Components: Header, RiskCards, MetricsBar, Table, Row, Detail, Loading, Empty
8. ‚úÖ Navigation added to Sidebar with badge

### Implementation Validation

| Story | Status | Gate |
|-------|--------|------|
| 6.1 API Integration | ‚úÖ Complete | PASS |
| 6.2 Page Structure | ‚úÖ Complete | PASS |
| 6.3 Stockout Table | ‚úÖ Complete | PASS |
| 6.4 Integration Testing | ‚ùå Not Started | FAIL |

### Risk Assessment

- **Business Risk**: LOW - Core functionality implemented
- **Technical Risk**: MEDIUM - No tests, similar to Epic 5

### Gate Status

Gate: **CONCERNS** ‚Üí `docs/qa/gates/6.0-supply-planning-epic.yml`

**Reason**: Stories 6.1-6.3 complete, but 6.4 (testing) not implemented.
