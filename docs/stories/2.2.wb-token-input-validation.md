# Story 2.2: WB Token Input & Validation

**üìù –í–∞–∂–Ω–æ:** –°–º. [CHANGELOG: WB Token Key Name Fix](../CHANGELOG-wb-token-key-name.md) –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –∏–º–µ–Ω–∏ –∫–ª—é—á–∞ —Ç–æ–∫–µ–Ω–∞ (`wb_api_token`).

## Status
Done

## Story

**As a** new user,  
**I want** to input and save my Wildberries API token,  
**so that** the system can automatically fetch and process my financial data.

## Acceptance Criteria

1. WB token input form displays with clear instructions
2. Token input field accepts the required token format
3. Form validates token format before submission (if format validation is possible)
4. Token is saved via API endpoint with proper authentication headers
5. Success confirmation displays when token is saved
6. Error messages display for invalid tokens or API failures
7. Loading state is shown during token save operation
8. User is informed that automatic data processing will begin
9. Form prevents multiple submissions while processing
10. Token input is masked or secured appropriately

## Tasks / Subtasks

- [x] Create WB token input page route (AC: 1)
  - [x] Create `src/app/(onboarding)/wb-token/page.tsx`
  - [x] Set up onboarding wizard step 2 with step indicator
- [x] Create WB token input form component (AC: 1, 2, 10)
  - [x] Create `src/components/custom/WbTokenForm.tsx`
  - [x] Add token input field (password type for masking)
  - [x] Add clear instructions for obtaining token with link to Wildberries Seller Portal
  - [x] Use React Hook Form for form state
  - [x] Use shadcn/ui Form, Input, Button components
- [x] Implement form validation (AC: 3)
  - [x] Validate token format (JWT structure: 3 parts separated by dots)
  - [x] Check minimum length (50 characters)
  - [x] Show real-time validation feedback (onBlur mode)
  - [x] Prevent submission with invalid format
- [x] Integrate with token save API (AC: 4, 5)
  - [x] API endpoint function exists in `src/lib/api.ts` (updateWbToken)
  - [x] Calls PUT /v1/cabinets/{cabinetId}/keys/{keyName} endpoint via apiClient
  - [x] Automatically includes JWT token and Cabinet ID in headers (via apiClient)
  - [x] Handles successful response
  - [x] Displays success message (toast)
- [x] Implement success flow (AC: 5, 8)
  - [x] Display success confirmation (toast in Russian)
  - [x] Inform user that data processing will begin (in instructions text)
  - [x] Navigate to data processing status page (/onboarding/processing)
  - [x] Use Next.js router for navigation
- [x] Implement error handling (AC: 6)
  - [x] Handle invalid token format errors (frontend validation)
  - [x] Handle backend validation failures (invalid, expired tokens)
  - [x] Handle network errors
  - [x] Display user-friendly error messages in Russian
  - [x] Special handling for missing cabinetId (shows error message)
- [x] Implement loading and submission states (AC: 7, 9)
  - [x] Show loading state ("–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...") during API call
  - [x] Disable form submission button during processing
  - [x] Prevent multiple form submissions (disabled state)
- [x] Implement token security (AC: 10)
  - [x] Mask token input (type="password")
  - [x] Do not store token in frontend (backend handles storage)
  - [x] Clear token from form after successful submission (form.reset())
- [x] Add unit tests (AC: all)
  - [x] Test form validation (min length, JWT format)
  - [x] Test API integration (updateWbToken call)
  - [x] Test error handling (invalid token, network errors)
  - [x] Test token masking/security (password type)
  - [x] Test navigation flow (to processing page)
  - [x] Test loading states
  - [x] Test missing cabinetId scenario
  - [x] All tests have explicit timeouts (5000-10000ms)

## Dev Notes

### Relevant Source Tree Info

**File Locations:**
- WB token page: `src/app/(onboarding)/wb-token/page.tsx`
- Token form component: `src/components/custom/WbTokenForm.tsx`
- API client: `src/lib/api.ts` (add token save method)
- Types: `src/types/api.ts` (if needed)

**Route Structure:**
```
src/app/
‚îú‚îÄ‚îÄ (onboarding)/
‚îÇ   ‚îú‚îÄ‚îÄ cabinet/
‚îÇ   ‚îú‚îÄ‚îÄ wb-token/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îÇ   ‚îî‚îÄ‚îÄ processing/
```

### API Integration

**WB Token Save Endpoint:**
- Endpoint: `POST /api/cabinets/{cabinetId}/wb-token`
- Request body: `{ token: string }`
- Headers: Authorization (JWT), X-Cabinet-Id (cabinet ID)
- Response: `{ data: { success: boolean }, message?: string }`
- Error responses: 400 (invalid token), 401 (unauthorized), 500 (server error)

**Token Format:**
- Check backend documentation for token format requirements
- May be alphanumeric string of specific length
- Validate format if known, otherwise rely on backend validation

### Component Requirements

**From front-end-spec.md:**
- Use shadcn/ui Form components
- Use shadcn/ui Input with type="password" for token masking
- Use shadcn/ui Button (Primary variant, red #E53935)
- Use shadcn/ui Toast for success/error messages
- Show clear instructions: "Enter your Wildberries API token. You can find this in your Wildberries seller account settings."
- Show help text or link to documentation if available

**Form Validation:**
- Token: Required, non-empty
- Format validation if token format is known
- Real-time validation feedback
- Submit button disabled until valid

### State Management

**Form State:**
- React Hook Form for local form state
- TanStack Query mutation for API call
- Do NOT store token in frontend state (security)

### Testing

**Testing Standards:**
- Test file: `src/components/custom/WbTokenForm.test.tsx`
- Test form validation
- Test API integration with MSW
- Test error handling (invalid token, network errors)
- Test token masking/security
- Test navigation to processing page
- Test loading states

### Important Notes

- Depends on Story 2.1 (Cabinet Creation) - requires cabinet ID
- Token should be masked for security (password input type)
- Do not store token in frontend - backend handles secure storage
- Error messages should be in Russian for UI
- User should be informed that data processing will begin after token save
- Consider allowing skip option if backend supports adding token later
- Follow WCAG AA accessibility standards

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-20 | 1.0 | Initial story creation | John (PM) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (via Cursor)

### Debug Log References
- `npm test -- src/components/custom/WbTokenForm.test.tsx --run` - All 9 tests passing
- `npm run lint` - No linting errors

### Completion Notes List
1. Created onboarding WB token page at `src/app/(onboarding)/wb-token/page.tsx` with step indicator
2. Created `WbTokenForm` component specifically for onboarding flow:
   - Automatically uses cabinetId from auth store (no prop needed)
   - Validates token format (JWT structure: 3 parts, min 50 chars)
   - Masks token input with password type
   - Shows clear instructions with link to Wildberries Seller Portal
   - Informs user that data processing will begin after token save
3. Form validation implemented with Zod schema:
   - Required field
   - Minimum 50 characters
   - JWT format validation (3 parts separated by dots)
4. API integration via existing `updateWbToken` function:
   - Uses new apiClient from Story 1.5 (automatic headers)
   - Automatically includes JWT and X-Cabinet-Id headers
   - Handles all error cases with user-friendly Russian messages
5. Success flow: toast notification + navigation to `/onboarding/processing`
6. Error handling: comprehensive error messages in Russian for:
   - Invalid/expired tokens
   - Permission errors
   - Missing cabinet
   - Rate limiting
   - Network errors
7. Loading states: button shows "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ..." and is disabled during submission
8. Security: token masked (password type), cleared after submission, not stored in frontend
9. Missing cabinetId handling: shows error message if cabinetId not found in store
10. All tests passing (9/9) with explicit timeouts (5000-10000ms)
11. Component follows accessibility standards (aria-required, aria-invalid, aria-busy)

### File List
**Created:**
- `src/app/(onboarding)/wb-token/page.tsx` - Onboarding WB token input page (28 lines)
- `src/components/custom/WbTokenForm.tsx` - WB token form component for onboarding (165 lines)
- `src/components/custom/WbTokenForm.test.tsx` - Comprehensive unit tests with timeouts (306 lines)

**Verified (already existed and working):**
- `src/lib/api.ts` - Already has updateWbToken function (uses new apiClient)
- `src/stores/authStore.ts` - Already has cabinetId support

**No files deleted**

## QA Results

### Review Date: 2025-01-20

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall Assessment:** ‚úÖ **PASS** - WB token input functionality is excellently implemented with proper token validation, security measures, comprehensive error handling, and excellent test coverage.

**Key Findings:**
- ‚úÖ WB token form properly structured with React Hook Form and Zod validation
- ‚úÖ JWT format validation (3 parts separated by dots, min 50 characters)
- ‚úÖ Token input masked with password type for security
- ‚úÖ Token cleared from form after successful submission
- ‚úÖ Comprehensive error handling for various scenarios (invalid, expired, permission, missing cabinet, rate limiting, network)
- ‚úÖ User-friendly Russian error messages
- ‚úÖ Clear instructions with link to Wildberries Seller Portal
- ‚úÖ User informed that data processing will begin after token save
- ‚úÖ Missing cabinetId handled gracefully with error message
- ‚úÖ Success flow with toast notification and navigation to processing page
- ‚úÖ Comprehensive test coverage (9 tests, all passing)
- ‚úÖ Onboarding page with step indicator (Step 2 of 3)

### Refactoring Performed

No refactoring needed. Code quality is excellent.

### Compliance Check

- ‚úÖ **Coding Standards**: Component follows TypeScript best practices, under 200 lines (172 lines)
- ‚úÖ **Project Structure**: Component in correct location (`src/components/custom/WbTokenForm.tsx`)
- ‚úÖ **Testing Strategy**: Comprehensive test suite with 9 tests covering all scenarios
- ‚úÖ **All ACs Met**: All 10 acceptance criteria verified and met

### Improvements Checklist

- [x] Form validation implemented correctly (JWT format, min length)
- [x] Token masking with password type
- [x] API integration with automatic header injection
- [x] Token cleared after submission
- [x] Loading states and disabled states
- [x] Success flow with redirect
- [x] Comprehensive error handling
- [x] User informed about data processing
- [x] Missing cabinetId handling
- [x] Test coverage comprehensive

### Security Review

‚úÖ **Security Best Practices:**
- Token input masked with password type (prevents shoulder surfing)
- Token cleared from form after successful submission
- Token not stored in frontend state (security best practice)
- Proper authentication headers included automatically via apiClient
- Error messages don't expose sensitive information
- Missing cabinetId handled securely

**Security Strengths:**
- Token masking prevents visual exposure
- Form reset after submission prevents token persistence in DOM
- Backend handles secure token storage
- Automatic header injection ensures proper authentication

### Performance Considerations

‚úÖ **Performance Optimized:**
- Client-side validation reduces unnecessary API calls
- Form validation is efficient (onBlur mode)
- Loading states prevent multiple submissions
- TanStack Query handles caching and retries

### Files Modified During Review

None - code quality is excellent, no changes needed.

### Gate Status

Gate: **PASS** ‚Üí docs/qa/gates/2.2-wb-token-input-validation.yml

### Recommended Status

‚úÖ **Ready for Done** - All acceptance criteria met, comprehensive test coverage, excellent code quality. Security measures properly implemented.

---

### Review Date: 2025-11-21

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall Assessment:** ‚úÖ **PASS** - WB token input functionality remains excellently implemented. Code review confirms all acceptance criteria are met with proper token validation, security measures, comprehensive error handling, and excellent test coverage.

**Key Findings:**
- ‚úÖ WB token form properly structured with React Hook Form and Zod validation
- ‚úÖ JWT format validation (3 parts separated by dots, min 50 characters)
- ‚úÖ Token input masked with password type for security
- ‚úÖ Token cleared from form after successful submission
- ‚úÖ Comprehensive error handling for various scenarios (invalid, expired, permission, missing cabinet, rate limiting, network)
- ‚úÖ User-friendly Russian error messages
- ‚úÖ Clear instructions with link to Wildberries Seller Portal
- ‚úÖ User informed that data processing will begin after token save
- ‚úÖ Missing cabinetId handled gracefully with error message
- ‚úÖ Success flow with toast notification and navigation to processing page
- ‚úÖ Comprehensive test coverage (9 tests, all passing)
- ‚úÖ Onboarding page with step indicator (Step 2 of 3)

### Refactoring Performed

No refactoring needed. Code quality remains excellent.

### Compliance Check

- ‚úÖ **Coding Standards**: Component follows TypeScript best practices, under 200 lines (172 lines)
- ‚úÖ **Project Structure**: Component in correct location (`src/components/custom/WbTokenForm.tsx`)
- ‚úÖ **Testing Strategy**: Comprehensive test suite with 9 tests covering all scenarios
- ‚úÖ **All ACs Met**: All 10 acceptance criteria verified and met

### Gate Status

Gate: **PASS** ‚Üí docs/qa/gates/2.2-wb-token-input-validation.yml

### Recommended Status

‚úÖ **Ready for Done** - All acceptance criteria met, comprehensive test coverage, excellent code quality. Security measures properly implemented.

