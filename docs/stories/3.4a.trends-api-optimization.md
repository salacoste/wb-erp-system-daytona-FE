# Story 3.4a: Trends API Optimization

## Status
✅ Done (QA PASS)

## Story

**As a** frontend developer,
**I want** to use the dedicated trends endpoint instead of N separate requests,
**so that** the TrendGraph component loads 50-70% faster with better UX.

## Background

**Request #28** (QA Recommendation from Story 3.4) identified that the current implementation makes N separate API requests for N weeks of trend data. Backend implemented **Story 6.6** with a dedicated endpoint that returns all trend data in a single request.

**Previous Implementation:**
```typescript
// N+1 parallel requests (inefficient)
const weeks = ['2025-W44', '2025-W45', '2025-W46', '2025-W47'];
const results = await Promise.all(
  weeks.map(week => api.get(`/v1/analytics/weekly/finance-summary?week=${week}`))
);
```

**New Implementation:**
```typescript
// Single request (optimized)
const { from, to } = getWeekRange(limit);
const response = await apiClient.get<WeeklyTrendsResponse>(
  `/v1/analytics/weekly/trends?from=${from}&to=${to}&metrics=sale_gross,to_pay_goods`
);
```

## Acceptance Criteria

1. ✅ `useTrends` hook updated to use `GET /v1/analytics/weekly/trends` endpoint
2. ✅ Single API request instead of N requests
3. ✅ Support for `from`, `to`, and `metrics` parameters
4. ✅ Response parsing for new format (`period`, `data`, `summary`)
5. ✅ Backward compatibility - TrendGraph component works without changes
6. ✅ Loading and error states preserved
7. ✅ Performance improvement measurable (network tab: 1 request vs N)
8. ✅ Unit tests updated for new hook behavior (11 tests passing)

## Technical Details

### New Endpoint (Story 6.6)

```http
GET /v1/analytics/weekly/trends
Authorization: Bearer <token>
X-Cabinet-Id: <cabinet-uuid>

Query Parameters:
- from: string (required) - Start week (ISO format: YYYY-Www)
- to: string (required) - End week (ISO format: YYYY-Www)
- metrics: string (optional) - Comma-separated list (default: all)
- report_type: string (optional) - Filter by report type
- include_summary: boolean (optional) - Include trend summary (default: true)
```

### Response Format

```json
{
  "period": {
    "from": "2025-W44",
    "to": "2025-W47",
    "weeks_count": 4
  },
  "data": [
    {
      "week": "2025-W44",
      "payout_total": 125000.50,
      "sale_gross": 450000.00,
      "to_pay_goods": 320000.00
    }
  ],
  "summary": {
    "payout_total": { "min": 125000.50, "max": 145000.00, "avg": 132625.38, "trend": "+16%" },
    "sale_gross": { "min": 450000.00, "max": 520000.00, "avg": 478750.00, "trend": "+15.5%" }
  }
}
```

### Files Updated

| File | Changes |
|------|---------|
| `src/hooks/useTrends.ts` | Refactored to use single endpoint |
| `src/types/api.ts` | Added `WeeklyTrendDataPoint`, `TrendMetricSummary`, `WeeklyTrendsResponse` types |
| `src/hooks/useTrends.test.tsx` | Updated tests for new behavior (11 tests) |

## Tasks / Subtasks

- [x] Update types (AC: 4)
  - [x] Add `WeeklyTrendDataPoint` interface
  - [x] Add `TrendMetricSummary` interface
  - [x] Add `WeeklyTrendsResponse` interface

- [x] Refactor useTrends hook (AC: 1, 2, 3, 5)
  - [x] Replace N parallel requests with single endpoint call
  - [x] Update query parameters (`from`, `to`, `metrics`)
  - [x] Parse new response format
  - [x] Maintain backward compatibility with TrendGraph component
  - [x] Update query key for proper caching

- [x] Preserve UX patterns (AC: 6)
  - [x] Keep loading state behavior
  - [x] Keep error handling behavior (graceful degradation)
  - [x] Keep retry functionality

- [x] Update tests (AC: 8)
  - [x] Update mock responses for new format
  - [x] Test single request behavior
  - [x] Test error handling (API errors, 404, 400)
  - [x] Test empty data handling (empty array, null)
  - [x] Test data sorting (ascending by week)
  - [x] Test data mapping (sale_gross → revenue, to_pay_goods → totalPayable)

- [x] Verify performance (AC: 7)
  - [x] Check Network tab: 1 request instead of N
  - [x] Document performance gain

## Performance Results

| Metric | Before | After | Improvement |
|--------|--------|-------|-------------|
| API Requests | N (8 by default) | 1 | **87.5% reduction** |
| Estimated Latency | N × RTT | 1 × RTT | **~50-70% faster** |

## Dependencies

- **Backend:** Story 6.6 (Dedicated Trends Endpoint) - ✅ Deployed
- **Documentation:** [28-dedicated-trends-api-endpoint-backend.md](../request-backend/28-dedicated-trends-api-endpoint-backend.md)

## Test Results

```
✓ src/hooks/useTrends.test.tsx (11 tests) 602ms

Story 3.4a: Single Endpoint Optimization
  ✓ makes only one API call to /v1/analytics/weekly/trends
  ✓ fetches trend data for multiple weeks
  ✓ returns summary statistics from API

Empty data handling
  ✓ handles empty data array from API
  ✓ handles null data from API

Error handling
  ✓ handles API errors gracefully
  ✓ handles 404 errors gracefully
  ✓ handles 400 errors gracefully

Data sorting
  ✓ sorts trends by week in ascending order

Data mapping
  ✓ maps sale_gross to revenue and to_pay_goods to totalPayable
  ✓ handles null metric values by defaulting to 0
```

## Definition of Done

- [x] Hook uses single `GET /v1/analytics/weekly/trends` request
- [x] TrendGraph component renders correctly (no UI changes required)
- [x] All unit tests pass (11/11)
- [x] Network tab shows 1 request instead of N
- [x] Performance improvement documented
- [ ] Code reviewed and merged
