# Epic 5: Unit Economics Analytics

## Status
Draft

## Epic Overview

**Priority**: P0 - CRITICAL ("Killer Feature")
**Estimated Effort**: 2 weeks
**Business Impact**: Visibility into true profitability per SKU
**Source PRD**: `../our_service_full_analytics/phase_one/PAGE_03_UNIT_ECONOMICS.md`
**API Integration Plan**: `../our_service_full_analytics/phase_one/API_INTEGRATION_PLAN.md`

---

## Epic Goal

Enable sellers to understand the true unit economics of each product by visualizing all 12 WB cost categories as percentages of revenue, revealing which products are actually profitable and which are "margin killers."

## Business Value

**The Problem**:
```
SKU A: 100,000â‚½ revenue, 20,000â‚½ profit â†’ "Great!"
SKU B: 50,000â‚½ revenue, 15,000â‚½ profit â†’ "Worse"

BUT! SKU A = 20% margin, SKU B = 30% margin
â†’ SKU B is 1.5x more efficient!
```

**The Solution**:
- Waterfall visualization showing cost breakdown as % of revenue
- Identify "margin killers" (high logistics, high commission SKUs)
- Actionable insights: "Reduce returns to save 5% margin"

**ROI Example**:
```
Before: Average margin 18%, no visibility into cost structure
After: Average margin 25% (+7 points) by optimizing worst performers
For 10Mâ‚½/month seller: +700Kâ‚½/month pure profit
```

---

## Stories Breakdown

| Story | Title | Scope | Effort | UX Required | Backend Dep |
|-------|-------|-------|--------|-------------|-------------|
| 5.1 | API Integration (Frontend) | Frontend | 1-2 days | No | **Request #53** |
| 5.2 | Frontend Page Structure | Frontend | 2 days | **Yes** | Request #53 |
| 5.3 | Cost Breakdown Visualization | Frontend | 3 days | **Yes** | Request #53 |
| 5.4 | Integration & Testing | Full-stack | 2 days | No | Request #53 |

### Backend Request

| Request | Title | Status |
|---------|-------|--------|
| **#53** | [Unit Economics API Endpoint](../request-backend/53-unit-economics-api-endpoint.md) | ðŸŸ¡ Pending |

---

## Technical Architecture

### Data Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ weekly_payout_summary   â”‚  â† Existing table
â”‚ + wb_finance_raw        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚ Aggregate by SKU
            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ UnitEconomicsService    â”‚  â† NEW service
â”‚ - Calculate % per cost  â”‚
â”‚ - Map 12 WB categories  â”‚
â”‚ - Classify profitabilityâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ GET /v1/analytics/      â”‚  â† NEW endpoint
â”‚     unit-economics      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Frontend Page           â”‚  â† NEW page
â”‚ /analytics/unit-econ    â”‚
â”‚ - Waterfall chart       â”‚
â”‚ - Comparison table      â”‚
â”‚ - Export functionality  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Cost Categories Mapping (12 WB Categories)

| # | Category | Source Field | Description |
|---|----------|--------------|-------------|
| 1 | COGS | `cogs` table | Cost of Goods Sold |
| 2 | WB Commission | `total_commission_rub` | Sales commission |
| 3 | Logistics Delivery | `logistics_delivery` | Delivery to customer |
| 4 | Logistics Return | `logistics_return` | Return shipping |
| 5 | Storage | `storage_cost` | Warehouse storage |
| 6 | Paid Acceptance | `paid_acceptance_cost` | Warehouse acceptance |
| 7 | Advertising | *Future* | Ad spend (not in MVP) |
| 8 | Penalties | `penalties_total` | Fines and penalties |
| 9 | Other Deductions | `other_adjustments_net` | Miscellaneous |
| 10 | Acquiring | *included in commission* | Payment processing |
| 11 | Defects | *part of returns* | Product defects |
| 12 | Packaging | *part of logistics* | Packaging costs |

**MVP Scope**: Categories 1-9 (available in current data model)

---

## API Contract

### Endpoint: `GET /v1/analytics/unit-economics`

**Query Parameters**:
```
week: string (ISO week, e.g., "2025-W47") - required
view_by: "sku" | "category" | "brand" | "total" - default: "sku"
sort_by: "revenue" | "net_margin_pct" | "cogs_pct" - default: "revenue"
sort_order: "asc" | "desc" - default: "desc"
limit: number - default: 100
```

**Response**:
```json
{
  "meta": {
    "week": "2025-W47",
    "cabinet_id": "uuid",
    "generated_at": "2025-12-09T10:00:00Z"
  },
  "summary": {
    "total_revenue": 1500000,
    "avg_cogs_pct": 35.2,
    "avg_wb_fees_pct": 44.8,
    "avg_net_margin_pct": 20.0,
    "sku_count": 85,
    "profitable_sku_count": 72,
    "loss_making_sku_count": 13
  },
  "data": [
    {
      "sku_id": "12345",
      "product_name": "Widget Pro",
      "category": "Electronics",
      "brand": "BrandX",
      "revenue": 100000,

      "costs_pct": {
        "cogs": 30.0,
        "commission": 15.0,
        "logistics_delivery": 8.0,
        "logistics_return": 2.0,
        "storage": 3.0,
        "paid_acceptance": 1.5,
        "penalties": 0.5,
        "other_deductions": 1.0,
        "advertising": 0.0
      },

      "costs_rub": {
        "cogs": 30000,
        "commission": 15000,
        "logistics_delivery": 8000,
        "logistics_return": 2000,
        "storage": 3000,
        "paid_acceptance": 1500,
        "penalties": 500,
        "other_deductions": 1000,
        "advertising": 0
      },

      "total_costs_pct": 61.0,
      "net_margin_pct": 39.0,
      "net_profit": 39000,

      "profitability_status": "excellent",
      "insights": [
        "High margin - consider increasing stock",
        "Logistics costs below average"
      ]
    }
  ]
}
```

### Profitability Classification

| Status | Net Margin % | Color |
|--------|--------------|-------|
| `excellent` | > 25% | Green |
| `good` | 15-25% | Light Green |
| `warning` | 5-15% | Yellow |
| `critical` | 0-5% | Orange |
| `loss` | < 0% | Red |

---

## Existing Infrastructure to Leverage

### Backend (from CLAUDE.md)

**Tables**:
- `weekly_payout_summary` - aggregated weekly data
- `wb_finance_raw` - raw transaction data
- `cogs` - cost of goods sold

**Existing Services**:
- `WeeklyAnalyticsService` - extend for unit economics
- `IsoWeekService` - week calculations

**Existing Endpoints**:
- `GET /v1/analytics/weekly/by-sku` - base data (60% reusable)

### Frontend (from front-end-spec.md)

**Components**:
- shadcn/ui Table, Card, Select
- TanStack Query for data fetching
- Recharts for visualization

**Existing Pages**:
- `/analytics/dashboard` - pattern to follow
- `/cogs` - similar data structure

---

## Compatibility Requirements

- [ ] Existing APIs remain unchanged
- [ ] Database schema changes are additive only (no migrations on existing tables)
- [ ] UI follows existing design patterns (shadcn/ui + Tailwind)
- [ ] Performance: <500ms response time for p95
- [ ] No breaking changes to existing analytics

---

## Risk Mitigation

**Primary Risk**: Missing cost breakdown in `weekly_payout_summary`
**Mitigation**: Use `wb_finance_raw` for detailed breakdown, fallback to aggregates

**Secondary Risk**: Performance with large SKU counts
**Mitigation**: Pagination, Redis caching (1 hour TTL), limit default 100

**Rollback Plan**: Feature flag `FEATURE_UNIT_ECONOMICS=false` to disable

---

## Definition of Done

- [ ] All 4 stories completed with acceptance criteria met
- [ ] Backend API responds in <500ms for 1000 SKUs
- [ ] Frontend renders waterfall chart correctly
- [ ] Export to CSV/Excel functional
- [ ] Unit tests coverage >80%
- [ ] E2E tests for critical flows
- [ ] Documentation updated (API docs, user guide)
- [ ] No regression in existing analytics

---

## Dependencies

| Dependency | Status | Notes |
|------------|--------|-------|
| Epic 4 (COGS) | âœ… Done | COGS data required for calculations |
| Epic 3 (Dashboard) | âœ… Done | Page layout patterns |
| Backend `weekly_payout_summary` | âœ… Available | Base data source |
| Backend `wb_finance_raw` | âœ… Available | Detailed breakdown |

---

## UX/UI Expert Sections

> **Note**: The following sections require UX/UI expert input before implementation.

### Required UX Deliverables

1. **Story 5.2**: Page layout wireframes
2. **Story 5.3**: Waterfall chart design specification
3. **Color palette** for profitability status
4. **Mobile responsive** breakpoints
5. **Empty states** and loading skeletons
6. **Interaction patterns** (hover, click, drill-down)

### Design Questions for UX Expert

- [ ] Waterfall vs Stacked Bar vs Pie chart for cost breakdown?
- [ ] Table-first or chart-first layout?
- [ ] Inline expandable rows or separate detail modal?
- [ ] Color scheme for 12 cost categories?
- [ ] How to handle products without COGS?

---

## Related Documentation

### Backend Request
- **Request #53**: [`docs/request-backend/53-unit-economics-api-endpoint.md`](../request-backend/53-unit-economics-api-endpoint.md)

### Source Documents
- **Source PRD**: `../our_service_full_analytics/phase_one/PAGE_03_UNIT_ECONOMICS.md`
- **API Plan**: `../our_service_full_analytics/phase_one/API_INTEGRATION_PLAN.md`
- **Competitive Analysis**: `../our_service_full_analytics/phase_one/01_COMPETITIVE_SYNTHESIS.md`

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-09 | 1.0 | Initial epic creation | Sarah (PO) |

---

**Next Steps**:
1. Review stories 5.1-5.4
2. UX Expert to provide design specifications
3. Backend dev to start Story 5.1
4. Frontend dev to prepare page structure (Story 5.2)

---

## QA Results

### Review Date: 2025-12-13

### Reviewed By: Quinn (Test Architect)

### Epic Structure Assessment

**Overall Status**: âœ… **WELL-STRUCTURED**

The epic overview document is comprehensive and follows best practices:

1. **Business Value**: Clearly articulated with ROI example (+7% margin = +700Kâ‚½/month)
2. **Technical Architecture**: Complete data flow diagram from `weekly_payout_summary` â†’ API â†’ Frontend
3. **API Contract**: Fully specified with request/response examples
4. **Stories Breakdown**: Logical progression (API â†’ Page â†’ Visualization â†’ Testing)
5. **Dependencies**: Clearly identified (Epic 3, 4 as prerequisites)
6. **Risk Mitigation**: Addressed with feature flag rollback plan

### Implementation Validation

| Component | Status | Notes |
|-----------|--------|-------|
| Backend API (Request #53) | âœ… Implemented | Epic 27 complete |
| Frontend Types | âœ… Complete | `src/types/unit-economics.ts` - comprehensive |
| API Hook | âœ… Complete | `src/hooks/useUnitEconomics.ts` - TanStack Query |
| Page Component | âœ… Complete | `/analytics/unit-economics/page.tsx` |
| Waterfall Chart | âœ… Complete | `UnitEconomicsWaterfall.tsx` |
| Summary Cards | âœ… Complete | `UnitEconomicsSummaryCards.tsx` |
| Data Table | âœ… Complete | `UnitEconomicsTable.tsx` |
| Loading/Empty States | âœ… Complete | Proper UX states |
| CSV Export | âœ… Complete | Inline implementation |

### Compliance Check

- Epic Structure: âœ… Follows BMad template
- Technical Alignment: âœ… Matches CLAUDE.md architecture
- API Contract: âœ… Consistent with Request #53
- Component Library: âœ… Uses shadcn/ui + Tailwind

### Observations

1. **Epic Status**: Should be updated from "Draft" to "In Progress" or "Done"
2. **Cost Categories**: 9 of 12 implemented (as planned for MVP)
3. **Profitability Classification**: Fully implemented with 5 levels

### Gate Status

Gate: **PASS** â†’ `docs/qa/gates/5.0-unit-economics-epic.yml`

### Recommended Status

âœ… Ready for Done (Epic overview validated, implementation verified)
