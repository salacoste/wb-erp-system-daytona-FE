# Story 5.1: Unit Economics API Integration (Frontend)

## Status
✅ Ready for QA (Frontend Integration Complete)

**Backend Request**: [`docs/request-backend/53-unit-economics-api-endpoint.md`](../request-backend/53-unit-economics-api-endpoint.md)
**Backend Status**: ✅ IMPLEMENTED

---

## Story

**As a** frontend developer,
**I want** to integrate with the Unit Economics API endpoint,
**so that** I can display waterfall charts and comparison tables for sellers.

> **Note**: Backend implementation details are in Request #53. This story covers frontend integration work that can begin once backend is ready.

---

## Acceptance Criteria

### Frontend Integration Requirements

1. **TypeScript Types**: Create types matching API response contract
2. **API Client Function**: Add `getUnitEconomics()` to API client
3. **TanStack Query Hook**: Create `useUnitEconomics()` hook with:
   - Query parameters: `week`, `viewBy`, `sortBy`, `sortOrder`, `limit`
   - Caching: `staleTime: 5 min`
   - Error handling
4. **Loading States**: Hook returns `isLoading`, `isError`, `error`
5. **Data Transformation**: Transform API response for chart components (if needed)

### Integration Testing

6. **Mock API**: MSW handlers for unit economics endpoint
7. **Hook Tests**: Test `useUnitEconomics` with various parameters
8. **Error Handling**: Test 400, 401, 403, 404, 500 responses

### Blocked Until

9. ⏳ Backend implements Request #53
10. ⏳ Backend provides test data / staging environment

---

## Tasks / Subtasks

### TypeScript Types (AC: 1)

- [ ] Create types file `src/types/unit-economics.ts`
  - [ ] `UnitEconomicsResponse` - full API response
  - [ ] `UnitEconomicsSummary` - summary object
  - [ ] `UnitEconomicsData` - single SKU data
  - [ ] `CostsPct` - cost percentages object
  - [ ] `CostsRub` - absolute costs object
  - [ ] `ProfitabilityStatus` - enum type
  - [ ] `UnitEconomicsQueryParams` - query parameters

### API Client (AC: 2)

- [ ] Add function to `src/lib/api.ts`
  ```typescript
  export async function getUnitEconomics(
    params: UnitEconomicsQueryParams
  ): Promise<UnitEconomicsResponse>
  ```
- [ ] Handle query parameter serialization
- [ ] Include proper headers (Auth, X-Cabinet-Id)

### TanStack Query Hook (AC: 3, 4)

- [ ] Create `src/hooks/useUnitEconomics.ts`
  - [ ] Implement `useUnitEconomics(options)` hook
  - [ ] Query key: `['unit-economics', week, viewBy, sortBy, sortOrder]`
  - [ ] `staleTime: 5 * 60 * 1000` (5 minutes)
  - [ ] `enabled: !!week` (don't fetch without week)
  - [ ] Return `{ data, isLoading, isError, error, refetch }`

### Data Transformation (AC: 5)

- [ ] Create `src/lib/unit-economics-utils.ts` (if needed)
  - [ ] `transformToWaterfallData()` - for chart
  - [ ] `formatCostPercentage()` - formatting helper
  - [ ] `getProfitabilityColor()` - status to color mapping

### MSW Mock Handlers (AC: 6)

- [ ] Create `src/mocks/handlers/unit-economics.ts`
  - [ ] Handler for successful response
  - [ ] Handler for error responses (400, 401, 403, 404, 500)
- [ ] Add to `src/mocks/handlers/index.ts`

### Tests (AC: 7, 8)

- [ ] Create `src/hooks/__tests__/useUnitEconomics.test.ts`
  - [ ] Test successful data fetch
  - [ ] Test with different parameters
  - [ ] Test error handling
  - [ ] Test loading states
  - [ ] Test caching behavior

---

## Dev Notes

### API Contract Reference

Full API specification is in **Request #53**: [`docs/request-backend/53-unit-economics-api-endpoint.md`](../request-backend/53-unit-economics-api-endpoint.md)

### TypeScript Types

```typescript
// src/types/unit-economics.ts

export type ProfitabilityStatus =
  | 'excellent'
  | 'good'
  | 'warning'
  | 'critical'
  | 'loss';

export interface CostsPct {
  cogs: number;
  commission: number;
  logistics_delivery: number;
  logistics_return: number;
  storage: number;
  paid_acceptance: number;
  penalties: number;
  other_deductions: number;
  advertising: number;
}

export interface CostsRub {
  cogs: number;
  commission: number;
  logistics_delivery: number;
  logistics_return: number;
  storage: number;
  paid_acceptance: number;
  penalties: number;
  other_deductions: number;
  advertising: number;
}

export interface UnitEconomicsData {
  sku_id: string;
  product_name: string;
  category: string;
  brand: string;
  revenue: number;
  costs_pct: CostsPct;
  costs_rub: CostsRub;
  total_costs_pct: number;
  net_margin_pct: number;
  net_profit: number;
  profitability_status: ProfitabilityStatus;
  insights?: string[];
}

export interface UnitEconomicsSummary {
  total_revenue: number;
  avg_cogs_pct: number;
  avg_wb_fees_pct: number;
  avg_net_margin_pct: number;
  sku_count: number;
  profitable_sku_count: number;
  loss_making_sku_count: number;
}

export interface UnitEconomicsResponse {
  meta: {
    week: string;
    cabinet_id: string;
    view_by: string;
    generated_at: string;
  };
  summary: UnitEconomicsSummary;
  data: UnitEconomicsData[];
}

export interface UnitEconomicsQueryParams {
  week: string;
  view_by?: 'sku' | 'category' | 'brand' | 'total';
  sort_by?: 'revenue' | 'net_margin_pct' | 'cogs_pct';
  sort_order?: 'asc' | 'desc';
  limit?: number;
}
```

### Hook Implementation

```typescript
// src/hooks/useUnitEconomics.ts
import { useQuery } from '@tanstack/react-query';
import { apiClient } from '@/lib/api';
import type { UnitEconomicsResponse, UnitEconomicsQueryParams } from '@/types/unit-economics';

export function useUnitEconomics(params: UnitEconomicsQueryParams) {
  return useQuery<UnitEconomicsResponse>({
    queryKey: ['unit-economics', params.week, params.view_by, params.sort_by, params.sort_order],
    queryFn: async () => {
      const searchParams = new URLSearchParams({
        week: params.week,
        ...(params.view_by && { view_by: params.view_by }),
        ...(params.sort_by && { sort_by: params.sort_by }),
        ...(params.sort_order && { sort_order: params.sort_order }),
        ...(params.limit && { limit: String(params.limit) }),
      });
      return apiClient.get(`/v1/analytics/unit-economics?${searchParams}`);
    },
    enabled: !!params.week,
    staleTime: 5 * 60 * 1000, // 5 minutes
    gcTime: 30 * 60 * 1000, // 30 minutes
  });
}
```

### Profitability Color Mapping

```typescript
// src/lib/unit-economics-utils.ts

export function getProfitabilityColor(status: ProfitabilityStatus): string {
  const colors: Record<ProfitabilityStatus, string> = {
    excellent: '#22C55E', // green-500
    good: '#84CC16',      // lime-500
    warning: '#EAB308',   // yellow-500
    critical: '#F97316',  // orange-500
    loss: '#EF4444',      // red-500
  };
  return colors[status];
}

export function getProfitabilityLabel(status: ProfitabilityStatus): string {
  const labels: Record<ProfitabilityStatus, string> = {
    excellent: 'Отлично',
    good: 'Хорошо',
    warning: 'Внимание',
    critical: 'Критично',
    loss: 'Убыток',
  };
  return labels[status];
}
```

### Relevant Source Tree (Frontend)

```
src/
├── types/
│   └── unit-economics.ts          ← NEW
├── hooks/
│   ├── useAnalytics.ts            ← Existing pattern
│   └── useUnitEconomics.ts        ← NEW
├── lib/
│   ├── api.ts                     ← Add getUnitEconomics
│   └── unit-economics-utils.ts    ← NEW
└── mocks/
    └── handlers/
        └── unit-economics.ts      ← NEW (for testing)
```

### Testing with MSW

```typescript
// src/mocks/handlers/unit-economics.ts
import { rest } from 'msw';

export const unitEconomicsHandlers = [
  rest.get('/v1/analytics/unit-economics', (req, res, ctx) => {
    const week = req.url.searchParams.get('week');

    if (!week) {
      return res(
        ctx.status(400),
        ctx.json({ error: { code: 'VALIDATION_ERROR', message: 'Week required' } })
      );
    }

    return res(
      ctx.json({
        meta: { week, cabinet_id: 'test-cabinet', view_by: 'sku', generated_at: new Date().toISOString() },
        summary: {
          total_revenue: 1500000,
          avg_cogs_pct: 35.2,
          avg_wb_fees_pct: 44.8,
          avg_net_margin_pct: 20.0,
          sku_count: 85,
          profitable_sku_count: 72,
          loss_making_sku_count: 13,
        },
        data: [
          {
            sku_id: '12345',
            product_name: 'Test Product',
            category: 'Test Category',
            brand: 'Test Brand',
            revenue: 100000,
            costs_pct: { cogs: 30, commission: 15, logistics_delivery: 8, logistics_return: 2, storage: 3, paid_acceptance: 1.5, penalties: 0.5, other_deductions: 1, advertising: 0 },
            costs_rub: { cogs: 30000, commission: 15000, logistics_delivery: 8000, logistics_return: 2000, storage: 3000, paid_acceptance: 1500, penalties: 500, other_deductions: 1000, advertising: 0 },
            total_costs_pct: 61,
            net_margin_pct: 39,
            net_profit: 39000,
            profitability_status: 'excellent',
          },
        ],
      })
    );
  }),
];
```

---

## Definition of Done

### Frontend (This Story)
- [ ] TypeScript types created and exported
- [ ] `useUnitEconomics` hook implemented
- [ ] API client function added
- [ ] MSW mock handlers created
- [ ] Unit tests for hook pass
- [ ] Types match API contract from Request #53

### Backend (Request #53) - Tracked Separately
- [ ] ⏳ Backend implements endpoint
- [ ] ⏳ Backend provides staging environment
- [ ] ⏳ Integration tested with real API

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-09 | 1.0 | Initial story creation | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used
_(To be populated by dev agent)_

### Debug Log References
_(To be populated by dev agent)_

### Completion Notes List
_(To be populated by dev agent)_

### File List
_(To be populated by dev agent)_

---

## QA Results

### Review Date: 2025-12-13

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall**: Implementation quality is HIGH. Types are comprehensive, hook follows TanStack Query best practices, utilities are well-documented with extensive helper functions.

**Strengths**:
- Types exceed spec requirements with additional UI helper types (`ProfitabilityStatusConfig`, `WaterfallDataPoint`)
- Hook implementation includes prefetch and invalidation helpers
- Utils library is comprehensive (389 lines) with formatting, analysis, and chart transformation functions
- Proper error handling in hook with retry logic

**Gaps Identified**:
- No unit tests for `useUnitEconomics` hook
- No MSW mock handlers created
- Story tasks remain unchecked despite complete implementation

### Requirements Traceability

| AC | Requirement | Status | Evidence |
|----|-------------|--------|----------|
| AC-1 | TypeScript Types | ✅ PASS | `src/types/unit-economics.ts` (247 lines) |
| AC-2 | API Client Function | ✅ PASS | Implemented via hook `fetchUnitEconomics()` |
| AC-3 | TanStack Query Hook | ✅ PASS | `src/hooks/useUnitEconomics.ts` with caching |
| AC-4 | Loading States | ✅ PASS | `isLoading`, `error` returned from hook |
| AC-5 | Data Transformation | ✅ PASS | `src/lib/unit-economics-utils.ts` (389 lines) |
| AC-6 | MSW Mock Handlers | ❌ MISSING | No files in `src/mocks/` |
| AC-7 | Hook Tests | ❌ MISSING | No test files found |
| AC-8 | Error Handling Tests | ❌ MISSING | No tests for 400/401/403/404/500 |
| AC-9 | Backend Implements #53 | ✅ PASS | Request #53 marked IMPLEMENTED 2025-12-09 |
| AC-10 | Backend Test Data | ✅ PASS | Backend available |

### Compliance Check

- Coding Standards: ✅ TypeScript strict, proper JSDoc comments
- Project Structure: ✅ Correct file locations
- Testing Strategy: ⚠️ No tests (AC 6-8 not met)
- All ACs Met: ❌ 7/10 ACs complete (70%)

### Improvements Checklist

- [x] TypeScript types created and match API contract
- [x] Hook implemented with proper caching (staleTime: 5min, gcTime: 30min)
- [x] Utilities created with waterfall transformation
- [x] Prefetch and invalidation helpers added
- [ ] **Create MSW handlers** for unit economics endpoint
- [ ] **Add hook unit tests** with @testing-library/react
- [ ] **Test error scenarios** (400, 401, 403, 404, 500)
- [ ] Update story task checkboxes to reflect actual progress

### Security Review

✅ No security concerns. API client uses existing auth headers (`Authorization`, `X-Cabinet-Id`).

### Performance Considerations

✅ Good caching strategy:
- `staleTime: 5 min` - reduces API calls
- `gcTime: 30 min` - memory efficient
- `retry: 2` with exponential backoff
- `enabled: !!params.week` prevents unnecessary fetches

### Files Reviewed

| File | Lines | Status |
|------|-------|--------|
| `src/types/unit-economics.ts` | 247 | ✅ Complete |
| `src/hooks/useUnitEconomics.ts` | 128 | ✅ Complete |
| `src/lib/unit-economics-utils.ts` | 389 | ✅ Complete |

### Gate Status

Gate: **PASS** → `docs/qa/gates/5.1-unit-economics-backend-api.yml`

**Updated 2025-12-13**: All acceptance criteria met after dev added tests.

### Test Artifacts Added

| Artifact | Status | Details |
|----------|--------|---------|
| MSW Handlers | ✅ Added | `src/mocks/handlers/unit-economics.ts` |
| Hook Tests | ✅ Added | `src/hooks/__tests__/useUnitEconomics.test.ts` |
| Test Count | ✅ 16 tests | All passing |
| Test Utils | ✅ Added | `src/test/test-utils.tsx`, `src/test/setup.ts` |

### Updated AC Status

All 10 ACs now complete: AC 6-8 (tests) ✅ PASS

### Recommended Status

✅ **Ready for Done** - All acceptance criteria met with 16 tests passing.
