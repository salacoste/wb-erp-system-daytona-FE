# Story 7.4: Liquidity Trends Chart & Integration Testing

## Status
Draft

---

## Story

**As a** seller,
**I want** to see how my inventory liquidity has changed over time and have confidence the feature works correctly,
**so that** I can track my optimization progress and trust the data.

---

## Acceptance Criteria

### Historical Trends Chart

1. **90-Day Trend Chart**: Stacked area chart showing liquidity distribution over time
2. **Data Points**: Weekly snapshots of 4 categories
3. **Hover Tooltips**: Show exact percentages for each date
4. **Insights Section**: Auto-generated insights (improvements/warnings)
5. **Time Period Selector**: 30/60/90 days options

### Integration Testing

6. **Frontend-Backend Integration**: API calls work correctly
7. **Data Accuracy**: Displayed values match backend calculations
8. **Liquidity Classification**: Categories calculated correctly
9. **Calculations**: Turnover days, frozen capital accurate
10. **Error Handling**: All error scenarios handled gracefully

### End-to-End Testing

11. **Happy Path**: User views liquidity page with data
12. **Category Filter**: Card clicks filter table correctly
13. **Table Sorting**: All sortable columns work
14. **Liquidation Planner**: Modal opens with correct data
15. **Search**: Search by SKU/name works

### Performance Testing

16. **Response Time**: Page loads in <3s with 100 SKUs
17. **Large Dataset**: Page handles 500 SKUs without issues
18. **Chart Performance**: Trend chart renders smoothly

### Edge Case Testing

19. **Zero Sales**: Products with no recent sales (turnover = 999)
20. **No Stock**: Products with stock_qty = 0
21. **No COGS**: Products without cost data
22. **New Products**: Products with <30 days history

---

## Tasks / Subtasks

### Trends Chart

- [ ] Create trend chart component
  - [ ] Create `src/components/custom/LiquidityTrendChart.tsx`
  - [ ] Stacked area chart (4 categories)
  - [ ] Time period selector
  - [ ] Hover tooltips with percentages
  - [ ] Responsive sizing

- [ ] Create insights section
  - [ ] Auto-generated insights from API
  - [ ] Improvement/warning icons
  - [ ] Formatted messages

### Unit Tests

- [ ] Test `useLiquidity` hook
  - [ ] Successful data fetch
  - [ ] Different category filters
  - [ ] Error handling
  - [ ] Caching behavior

- [ ] Test `useLiquidityTrends` hook
  - [ ] Successful data fetch
  - [ ] Different periods
  - [ ] Error handling

- [ ] Test helper functions
  - [ ] `getLiquidityStatusColor()`
  - [ ] `getLiquidityStatusLabel()`
  - [ ] `formatTurnoverDays()`
  - [ ] All 12 helper functions

- [ ] Test components
  - [ ] `LiquidityDistributionChart` - renders pie chart and cards
  - [ ] `LiquidityTable` - renders columns, sorts
  - [ ] `LiquidationPlannerModal` - renders scenarios
  - [ ] `LiquidityTrendChart` - renders stacked area chart

### Integration Tests

- [ ] API endpoint with MSW
  - [ ] GET with default parameters
  - [ ] GET with category_filter variations
  - [ ] GET trends endpoint
  - [ ] Error responses (401, 403, 404, 500, 503)

### E2E Tests (Playwright)

- [ ] Happy path test
  ```typescript
  test('Liquidity page displays data', async ({ page }) => {
    await page.goto('/analytics/liquidity');
    await expect(page.locator('h1')).toContainText('Ð›Ð¸ÐºÐ²Ð¸Ð´Ð½Ð¾ÑÑ‚ÑŒ');
    await expect(page.locator('[data-testid="distribution-chart"]')).toBeVisible();
    await expect(page.locator('table tbody tr')).toHaveCount(greaterThan(0));
  });
  ```

- [ ] Category filter test
  ```typescript
  test('Clicking illiquid card filters table', async ({ page }) => {
    await page.goto('/analytics/liquidity');
    await page.click('[data-testid="card-illiquid"]');
    // All visible rows should have illiquid status
    const rows = page.locator('table tbody tr');
    for (const row of await rows.all()) {
      await expect(row.locator('[data-testid="status-icon"]')).toHaveText('ðŸ”´');
    }
  });
  ```

- [ ] Liquidation planner test
  ```typescript
  test('Clicking Discount button opens liquidation planner', async ({ page }) => {
    await page.goto('/analytics/liquidity');
    // Filter to illiquid products
    await page.click('[data-testid="card-illiquid"]');
    // Click discount button on first row
    await page.click('table tbody tr:first-child [data-testid="action-button"]');
    await expect(page.locator('[data-testid="liquidation-modal"]')).toBeVisible();
    // Should show 3 scenarios
    await expect(page.locator('[data-testid="scenario-card"]')).toHaveCount(3);
  });
  ```

- [ ] Trend chart test
  ```typescript
  test('Trend chart displays 90-day history', async ({ page }) => {
    await page.goto('/analytics/liquidity');
    await expect(page.locator('[data-testid="trend-chart"]')).toBeVisible();
    // Should show insights
    await expect(page.locator('[data-testid="trend-insights"]')).toBeVisible();
  });
  ```

### Edge Case Tests

- [ ] Zero sales handling
  ```typescript
  test('Products with no sales show "ÐÐµÑ‚ Ð¿Ñ€Ð¾Ð´Ð°Ð¶"', async ({ page }) => {
    // Mock product with turnover = 999
    await page.goto('/analytics/liquidity');
    const zeroSalesRow = page.locator('tr:has-text("No Sales Product")');
    await expect(zeroSalesRow.locator('[data-testid="turnover-days"]'))
      .toContainText('ÐÐµÑ‚ Ð¿Ñ€Ð¾Ð´Ð°Ð¶');
  });
  ```

- [ ] No COGS handling
  ```typescript
  test('Products without COGS show dash for stock value', async ({ page }) => {
    // Mock product without COGS
    await page.goto('/analytics/liquidity');
    const noCOGSRow = page.locator('tr:has-text("No COGS Product")');
    await expect(noCOGSRow.locator('[data-testid="stock-value"]'))
      .toContainText('â€”');
  });
  ```

### Performance Tests

- [ ] Page load time
  ```typescript
  test('Page loads within 3 seconds', async ({ page }) => {
    const start = Date.now();
    await page.goto('/analytics/liquidity');
    await page.waitForSelector('table tbody tr');
    const loadTime = Date.now() - start;
    expect(loadTime).toBeLessThan(3000);
  });
  ```

- [ ] Large dataset
  ```typescript
  test('Page handles 500 SKUs', async ({ page }) => {
    // Mock 500 SKUs
    await page.goto('/analytics/liquidity');
    await page.waitForSelector('table tbody tr');
    // Should render without crashing
    await expect(page.locator('[data-testid="pagination"]')).toBeVisible();
  });
  ```

### Accessibility Tests

- [ ] Axe accessibility audit
- [ ] Keyboard navigation
- [ ] Screen reader compatibility

---

## Dev Notes

### Trend Chart Structure

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Ð”Ð¸Ð½Ð°Ð¼Ð¸ÐºÐ° Ð»Ð¸ÐºÐ²Ð¸Ð´Ð½Ð¾ÑÑ‚Ð¸                               [30Ð´] [60Ð´] [90Ð´]       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚ 100% â”¤                                                                       â”‚
â”‚      â”‚ â–  Ð’Ñ‹ÑÐ¾ÐºÐ¾Ð»Ð¸ÐºÐ²Ð¸Ð´Ð½Ñ‹Ð¹  â–  Ð¡Ñ€ÐµÐ´Ð½ÑÑ  â–  ÐÐ¸Ð·ÐºÐ°Ñ  â–  ÐÐµÐ»Ð¸ÐºÐ²Ð¸Ð´                  â”‚
â”‚      â”‚                                                                       â”‚
â”‚  80% â”¤ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ         â”‚
â”‚      â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â† Ð’Ñ‹   â”‚
â”‚  60% â”¤ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ         â”‚
â”‚      â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ         â”‚
â”‚  40% â”¤ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ         â”‚
â”‚      â”‚ â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘                         â”‚
â”‚  20% â”¤ â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘                                   â”‚
â”‚      â”‚ â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’                                                 â”‚
â”‚   0% â”¤ â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“                                                           â”‚
â”‚      â””â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬     â”‚
â”‚       90Ð´ Ð½Ð°Ð·Ð°Ð´ 75Ð´      60Ð´      45Ð´      30Ð´      15Ð´      Ð¡ÐµÐ³Ð¾Ð´Ð½Ñ        â”‚
â”‚                                                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ðŸ“ˆ ÐÐ½Ð°Ð»Ð¸Ñ‚Ð¸ÐºÐ°:                                                               â”‚
â”‚ âœ… Ð”Ð¾Ð»Ñ Ð½ÐµÐ»Ð¸ÐºÐ²Ð¸Ð´Ð¾Ð² ÑÐ½Ð¸Ð·Ð¸Ð»Ð°ÑÑŒ Ñ 7% Ð´Ð¾ 2.7% (Ð¾Ñ‚Ð»Ð¸Ñ‡Ð½Ñ‹Ð¹ Ð¿Ñ€Ð¾Ð³Ñ€ÐµÑÑ!)             â”‚
â”‚ âœ… Ð’Ñ‹ÑÐ¾ÐºÐ¾Ð»Ð¸ÐºÐ²Ð¸Ð´Ð½Ñ‹Ñ… Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð² ÑÑ‚Ð°Ð»Ð¾ Ð±Ð¾Ð»ÑŒÑˆÐµ: 58% â†’ 65.2%                       â”‚
â”‚ â†’ ÐŸÑ€Ð¾Ð´Ð¾Ð»Ð¶Ð°Ð¹Ñ‚Ðµ Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸ÑŽ! Ð’Ð°Ñˆ Ð¿Ð¾Ñ€Ñ‚Ñ„ÐµÐ»ÑŒ ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑÑ Ð·Ð´Ð¾Ñ€Ð¾Ð²ÐµÐµ.               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### File Structure

```
src/components/custom/
â”œâ”€â”€ LiquidityTrendChart.tsx      â† Stacked area chart
â””â”€â”€ LiquidityInsights.tsx        â† Auto-generated insights

src/mocks/fixtures/
â””â”€â”€ liquidity.json               â† Test fixture data
```

### Test Data Fixture

```typescript
// src/mocks/fixtures/liquidity.json
{
  "summary": {
    "total_inventory_value": 1000000,
    "total_sku_count": 85,
    "frozen_capital": 27000,
    "frozen_capital_pct": 2.7,
    "avg_turnover_days": 38,
    "distribution": {
      "highly_liquid": { "count": 48, "value": 652000, "pct": 65.2, "avg_turnover_days": 22 },
      "medium_liquid": { "count": 22, "value": 243000, "pct": 24.3, "avg_turnover_days": 45 },
      "low_liquid": { "count": 10, "value": 78000, "pct": 7.8, "avg_turnover_days": 73 },
      "illiquid": { "count": 5, "value": 27000, "pct": 2.7, "avg_turnover_days": 145 }
    },
    "benchmarks": {
      "your_avg_turnover": 38,
      "target_avg_turnover": 45,
      "industry_avg_turnover": 52,
      "highly_liquid_pct": 65.2,
      "target_highly_liquid_pct": 50,
      "illiquid_pct": 2.7,
      "target_illiquid_pct": 5,
      "overall_status": "excellent"
    }
  },
  "data": [
    {
      "sku_id": "22222",
      "product_name": "Device Old",
      "stock_value": 18000,
      "turnover_days": 145,
      "liquidity_category": "illiquid",
      "action_type": "LIQUIDATE",
      "liquidation_scenarios": [
        { "target_days": 30, "suggested_discount_pct": 40, "expected_profit": 14400 },
        { "target_days": 60, "suggested_discount_pct": 25, "expected_profit": 22500 },
        { "target_days": 90, "suggested_discount_pct": 15, "expected_profit": 27900 }
      ]
    },
    {
      "sku_id": "12345",
      "product_name": "Widget Pro",
      "stock_value": 54000,
      "turnover_days": 22,
      "liquidity_category": "highly_liquid",
      "action_type": "MAXIMIZE",
      "liquidation_scenarios": null
    }
  ]
}
```

---

## UX/UI Expert Sections

> **âš ï¸ REQUIRES UX/UI EXPERT INPUT BEFORE IMPLEMENTATION**

### ðŸ“ˆ Trend Chart Design

**Required from UX Expert**:

#### Chart Type
- [ ] Stacked area vs stacked bar?
- [ ] Color palette for 4 categories
- [ ] Line smoothing (curved vs straight)

#### Interactions
- [ ] Hover tooltip design
- [ ] Time period selector style (tabs, buttons, dropdown?)
- [ ] Animation on data change

#### Chart Size
- [ ] Height for different screen sizes
- [ ] Minimum/maximum width

---

### ðŸ’¡ Insights Section Design

**Required from UX Expert**:

- [ ] Card vs inline display?
- [ ] Icon styles for improvement/warning
- [ ] Typography for insight messages
- [ ] Maximum number of insights to show

---

## Definition of Done

- [ ] Trend chart displays 90-day history
- [ ] Time period selector works (30/60/90)
- [ ] Insights section displays auto-generated insights
- [ ] All unit tests pass (>80% coverage)
- [ ] Integration tests pass
- [ ] E2E tests pass on Chrome, Firefox, Safari
- [ ] Edge case tests pass
- [ ] Performance tests pass (<3s load)
- [ ] Accessibility audit passes
- [ ] Test results documented
- [ ] CI pipeline updated

---

## Related Documentation

- **Epic Overview**: `7.0.liquidity-analysis-epic.md`
- **API Story**: `7.1.liquidity-api-integration.md`
- **Page Story**: `7.2.liquidity-page-structure.md`
- **Table Story**: `7.3.liquidity-table-liquidation-planner.md`
- **Backend Request**: `docs/request-backend/55-liquidity-api-endpoint.md`

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-09 | 1.0 | Initial story creation | Sarah (PO) |

---

## Dev Agent Record

_(To be populated by dev agent)_

---

## QA Results
_(To be populated by QA)_
