# Story 3.5: Financial Summary View

## Status
✅ **COMPLETE** (2025-11-24)

**Implementation Summary:**
- ✅ 3 files created (hook, 2 components)
- ✅ 1 page created (`/analytics`)
- ✅ All 9 acceptance criteria met
- ✅ Week selector with available weeks
- ✅ Complete financial summary (15+ metrics organized in 4 groups)
- ✅ Period comparison (side-by-side two-week comparison)
- ✅ Navigation cards to detailed analytics (SKU, Brand, Category, Time Period)
- ✅ Loading states, error handling, retry functionality
- ✅ Responsive design with accessibility support

---

## Completion Details (2025-11-24)

### Files Created
1. **`src/hooks/useFinancialSummary.ts`** (175 lines) - Financial summary hooks
   - `useFinancialSummary(week)` - Single week summary
   - `useFinancialSummaryComparison(week1, week2)` - Two-week comparison
   - `useAvailableWeeks()` - Available weeks list
   - Helper functions: `getCurrentIsoWeek`, `formatWeekDisplay`, `formatWeekWithDateRange`, `calculateChange`

2. **`src/components/custom/WeekSelector.tsx`** (131 lines) - Week selection components
   - `WeekSelector` - Single week dropdown selector
   - `WeekComparisonSelector` - Two-week comparison selector
   - Loading/error states with accessibility

3. **`src/components/custom/FinancialSummaryTable.tsx`** (273 lines) - Financial metrics table
   - 4 metric groups: Revenue, Expenses, Adjustments, Payout Summary
   - 15+ financial metrics displayed
   - Comparison mode with change indicators (trend arrows, percentages)
   - Color-coded changes (green/red/gray)

4. **`src/app/(dashboard)/analytics/page.tsx`** (257 lines) - Main analytics hub page

### Files Updated
1. **`src/hooks/useExpenses.ts`** - Added `weekOverride` parameter for custom week selection
2. **`src/components/custom/ExpenseChart.tsx`** - Added `weekOverride` prop to display chart for selected week

### Features Implemented
- ✅ Week selector dropdown (all available weeks from backend)
- ✅ Complete financial summary table (all 15+ metrics)
- ✅ 4 organized metric groups: Revenue, Expenses, Adjustments, Payout
- ✅ Period comparison toggle (side-by-side two weeks)
- ✅ Change indicators (percentage, trend arrows, color coding)
- ✅ Expense breakdown chart for selected week
- ✅ Navigation cards to 4 detailed analytics views
- ✅ Loading skeletons for data fetching
- ✅ Error alerts with retry functionality
- ✅ Empty state handling
- ✅ Responsive grid layout (mobile/tablet/desktop)
- ✅ Accessibility (ARIA labels, keyboard navigation, screen reader support)

### Metric Groups

**Revenue Metrics (3):**
- Вайлдберриз реализовал Товар (Пр) - Total gross revenue
- К перечислению за товар - Payment to seller for goods
- Выручка доставки продавца - DBS delivery revenue

**Expense Breakdown (8):**
- Логистика - Logistics cost
- Хранение - Storage cost
- Платная приёмка - Paid acceptance cost
- Штрафы - Penalties
- Эквайринг - Acquiring fee
- Комиссия продаж - Sales commission
- Комиссия лояльности - Loyalty fee
- Удержание баллов лояльности - Loyalty points withheld

**Adjustments (3):**
- Компенсация лояльности - Loyalty compensation
- Корректировка комиссии WB - WB commission adjustment
- Прочие корректировки - Other adjustments

**Payout Summary (1):**
- Итого к оплате - Total payout amount (highlighted)

### Acceptance Criteria Status
1. ✅ Financial summary page displays with overview of financial data
2. ✅ Key metrics are displayed in organized format (4 groups, 15+ metrics)
3. ✅ Basic filtering capabilities available (week selection, comparison mode)
4. ✅ Data formatted according to visualization standards (Intl.NumberFormat RUB)
5. ✅ Summary loads from backend API endpoints (`/v1/analytics/weekly/finance-summary`)
6. ✅ Loading and error states properly handled (Skeleton, Alert, Retry button)
7. ✅ User can navigate to detailed views (4 navigation cards with icons)
8. ✅ Summary is responsive and accessible (grid layout, ARIA labels, keyboard nav)
9. ✅ Export functionality out of scope for MVP (confirmed)

### Navigation Integration
- Route: `/analytics` (main analytics hub)
- Links from: Dashboard sidebar, other analytics pages
- Links to: `/analytics/sku`, `/analytics/brand`, `/analytics/category`, `/analytics/time-period`
- URL params: `?week=YYYY-Www` propagates selected week to detail pages

### Testing Status
- ✅ TypeScript compilation: No errors
- ✅ ESLint: No errors
- ⏳ Unit tests: Pending (future enhancement)
- ⏳ E2E tests: Pending (future enhancement)

---

## Story

**As a** financial director,  
**I want** to view a comprehensive financial summary with key metrics,  
**so that** I can analyze the overall financial position.

## Acceptance Criteria

1. Financial summary page/section displays with overview of financial data
2. Key metrics are displayed in organized format
3. Basic filtering capabilities are available (by time period, category if applicable)
4. Data is formatted according to visualization standards
5. Summary loads from backend API endpoints
6. Loading and error states are properly handled
7. User can navigate to detailed views from summary
8. Summary is responsive and accessible
9. Export functionality is out of scope for MVP

## Tasks / Subtasks

- [ ] Create financial summary page route (AC: 1)
  - [ ] Create `src/app/(dashboard)/analytics/page.tsx` or separate summary route
  - [ ] Set up page layout and structure
- [ ] Create FinancialSummary component (AC: 1, 2, 4)
  - [ ] Create `src/components/custom/FinancialSummary.tsx`
  - [ ] Display key financial metrics in organized format
  - [ ] Use table or card layout for metrics
  - [ ] Format all values according to standards (currency, percentages, dates)
  - [ ] Use shadcn/ui Table or Card components
- [ ] Implement basic filtering (AC: 3)
  - [ ] Add time period filter (weeks, months)
  - [ ] Add category filter if applicable
  - [ ] Use shadcn/ui Select component for filters
  - [ ] Update data based on filter selection
- [ ] Create financial summary data hook (AC: 5)
  - [ ] Create `src/hooks/useFinancialSummary.ts`
  - [ ] Use TanStack Query to fetch summary data
  - [ ] Call GET /api/financial/summary endpoint
  - [ ] Handle filter parameters in query
  - [ ] Handle caching and refetching
- [ ] Implement data formatting (AC: 4)
  - [ ] Format currency using Intl.NumberFormat
  - [ ] Format percentages using Intl.NumberFormat
  - [ ] Format dates as DD.MM.YYYY or ISO weeks
  - [ ] Use utility functions from `src/lib/utils.ts`
- [ ] Implement loading and error states (AC: 6)
  - [ ] Show skeleton loaders while data is fetching
  - [ ] Use shadcn/ui Skeleton component
  - [ ] Display error message in Russian
  - [ ] Show retry option
- [ ] Add navigation to detailed views (AC: 7)
  - [ ] Add links to margin analysis views
  - [ ] Add links to detailed analytics
  - [ ] Use Next.js Link component
  - [ ] Use shadcn/ui Button components
- [ ] Ensure responsiveness and accessibility (AC: 8)
  - [ ] Make summary responsive (desktop, tablet, mobile)
  - [ ] Ensure keyboard navigation
  - [ ] Ensure screen reader compatibility
  - [ ] Follow WCAG AA standards
- [ ] Add unit tests (AC: all)
  - [ ] Test FinancialSummary component rendering
  - [ ] Test data formatting
  - [ ] Test filtering functionality
  - [ ] Test API integration with MSW
  - [ ] Test loading and error states
  - [ ] Test navigation links
  - [ ] Test responsive behavior

## Dev Notes

### Relevant Source Tree Info

**File Locations:**
- Financial summary page: `src/app/(dashboard)/analytics/page.tsx` or `src/app/(dashboard)/summary/page.tsx`
- Financial summary component: `src/components/custom/FinancialSummary.tsx`
- Summary data hook: `src/hooks/useFinancialSummary.ts`
- Formatting utilities: `src/lib/utils.ts`
- API client: `src/lib/api.ts`
- Types: `src/types/api.ts` (FinancialSummary type)

**Route Structure:**
```
src/app/
├── (dashboard)/
│   ├── analytics/
│   │   └── page.tsx  # Financial summary or analytics overview
```

### API Integration

**Financial Summary Endpoint:**
- Endpoint: `GET /api/financial/summary?period=weeks|months&category=all|{category}`
- Headers: Authorization (JWT), X-Cabinet-Id (cabinet ID)
- Response: `{ data: { metrics: {...}, breakdown: [...], totals: {...} }, message?: string }`
- Filter parameters: period (weeks/months), category (optional)
- Caching: Stale time 30 seconds, cache time 5 minutes

### Component Requirements

**From front-end-spec.md:**
- Use shadcn/ui Table for tabular data
- Use shadcn/ui Card for metric displays
- Use shadcn/ui Select for filters
- Organize metrics in logical groups
- Show totals and subtotals clearly

**Data Formatting (from PRD FR22-FR24):**
- Currency: `Intl.NumberFormat('ru-RU', { style: 'currency', currency: 'RUB' })`
- Percentages: `Intl.NumberFormat('ru-RU', { style: 'percent' })`
- Dates: `DD.MM.YYYY` or `YYYY-Www`

### State Management

**Data Fetching:**
- Use TanStack Query for server state
- Query key: `['financial', 'summary', filters]`
- Include filter parameters in query key for proper caching
- Stale time: 30 seconds
- Refetch on filter change

**Filter State:**
- Use React state for filter values
- Update query when filters change
- Persist filter preferences in URL query params (optional)

### Testing

**Testing Standards:**
- Test file: `src/components/custom/FinancialSummary.test.tsx`
- Test component rendering with sample data
- Test data formatting (currency, percentages, dates)
- Test filtering functionality
- Test API integration with MSW
- Test loading and error states
- Test navigation links
- Test responsive behavior
- Test accessibility

### Important Notes

- Depends on Story 3.1 (Dashboard Layout) and Story 1.5 (API Client)
- Can be developed in parallel with Stories 3.2, 3.3, 3.4
- Export functionality is explicitly out of scope for MVP (AC: 9)
- Filtering should be basic for MVP (time period, category if applicable)
- Summary should provide overview with links to detailed views
- Data formatting must follow PRD requirements exactly
- Follow WCAG AA accessibility standards

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-20 | 1.0 | Initial story creation | John (PM) |

## Dev Agent Record

### Agent Model Used
_(To be populated by dev agent)_

### Debug Log References
_(To be populated by dev agent)_

### Completion Notes List
_(To be populated by dev agent)_

### File List
_(To be populated by dev agent)_

## QA Results

### Review Date: 2025-01-20

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall Assessment:** Implementation is complete and well-structured. All 9 acceptance criteria are met. Code follows project patterns, uses proper TypeScript types, and implements responsive design with accessibility support. Comprehensive test coverage has been added (43 tests total).

**Strengths:**
- ✅ Clean component architecture with proper separation of concerns
- ✅ Proper use of TanStack Query for data fetching and caching
- ✅ Comprehensive error handling with retry functionality
- ✅ Good accessibility support (ARIA labels, keyboard navigation)
- ✅ Responsive design implementation
- ✅ Proper data formatting using Intl.NumberFormat
- ✅ TypeScript types are well-defined
- ✅ Comprehensive test coverage (43 tests)

### Refactoring Performed

No refactoring was needed. Code quality was already high.

### Compliance Check

- Coding Standards: ✅ Code follows TypeScript and React best practices
- Project Structure: ✅ Files organized correctly in components/custom and hooks
- Testing Strategy: ✅ Comprehensive test coverage (43 tests: 10 for FinancialSummaryTable, 8 for WeekSelector, 25 for hooks)
- All ACs Met: ✅ All 9 acceptance criteria fully implemented

### Improvements Checklist

- [x] Add unit tests for FinancialSummaryTable component
  - [x] Test table rendering with single week data
  - [x] Test comparison mode (two columns)
  - [x] Test currency formatting
  - [x] Test change indicators (trend arrows, percentages, colors)
  - [x] Test empty/null value handling
- [x] Add unit tests for WeekSelector components
  - [x] Test week selection functionality
  - [x] Test loading states
  - [x] Test error states
  - [x] Test accessibility (keyboard navigation, ARIA labels)
- [x] Add integration tests for useFinancialSummary hooks
  - [x] Test useFinancialSummary with API mock
  - [x] Test useFinancialSummaryComparison with API mock
  - [x] Test useAvailableWeeks with API mock
  - [x] Test error handling (404, 400, network errors)
  - [x] Test query caching and refetching

### Security Review

✅ **PASS** - Uses existing API client with proper authentication headers (JWT, X-Cabinet-Id). No security vulnerabilities identified.

### Performance Considerations

✅ **PASS** - Uses TanStack Query with appropriate stale time (30s) and cache time (5min). Efficient data fetching with proper caching strategy.

### Files Reviewed

- `src/components/custom/FinancialSummaryTable.tsx` (273 lines)
- `src/components/custom/WeekSelector.tsx` (131 lines)
- `src/hooks/useFinancialSummary.ts` (175 lines)
- `src/app/(dashboard)/analytics/page.tsx` (257 lines)

### Gate Status

Gate: PASS → docs/qa/gates/3.5-financial-summary-view.yml

**Reason:** All acceptance criteria met. Comprehensive test coverage added (43 tests total: 10 for FinancialSummaryTable, 8 for WeekSelector, 25 for useFinancialSummary hooks). Quality score: 100/100.

### Files Modified During Review

- `src/components/custom/FinancialSummaryTable.test.tsx` - Created (10 unit tests)
- `src/components/custom/WeekSelector.test.tsx` - Created (8 unit tests)
- `src/hooks/useFinancialSummary.test.tsx` - Created (25 integration tests)

### Recommended Status

✅ **Ready for Done** - All tests passing, comprehensive coverage added, gate upgraded to PASS.

