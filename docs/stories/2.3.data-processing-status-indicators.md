# Story 2.3: Data Processing Status Indicators

## Status
Done

## Story

**As a** user who just completed onboarding,  
**I want** to see the status of automatic data processing (product parsing and financial report loading),  
**so that** I understand what the system is doing and when my data will be ready.

## Acceptance Criteria

1. Processing status screen displays after WB token is saved
2. Status indicators show progress for: product parsing (3 months historical) and financial report loading
3. Progress updates are displayed in real-time or via polling mechanism
4. Clear messaging explains what each processing step does
5. User is notified when processing is complete
6. User can navigate away and return to check status
7. Error states are displayed if processing fails
8. Loading animations or progress bars provide visual feedback
9. Estimated time remaining is shown if available from backend
10. User is automatically redirected to dashboard when processing completes

## Tasks / Subtasks

- [x] Create processing status page route (AC: 1)
  - [x] Create `src/app/(onboarding)/processing/page.tsx`
  - [x] Set up processing status layout with step indicator (Step 3 of 3)
- [x] Create processing status component (AC: 2, 3, 4, 8)
  - [x] Create `src/components/custom/ProcessingStatus.tsx`
  - [x] Display product parsing status with progress
  - [x] Display financial report loading status with progress
  - [x] Show clear messaging for each step (Russian descriptions)
  - [x] Use shadcn/ui Progress component for progress bars
  - [x] Use shadcn/ui Card and Alert components for status display
- [x] Implement polling mechanism (AC: 3, 9)
  - [x] Created hook `useProcessingStatus` that uses Tasks API
  - [x] Implement polling interval (5 seconds via TanStack Query refetchInterval)
  - [x] Poll GET /v1/tasks endpoint and filter for products_sync and finances_weekly_ingest
  - [x] Update progress indicators based on task status
  - [x] Stop polling when processing complete (refetchInterval returns false)
- [x] Implement status display logic (AC: 2, 4, 5)
  - [x] Parse task statuses and aggregate into ProcessingStatus
  - [x] Display current step (product parsing and report loading)
  - [x] Display progress percentage for each step (from task.progress)
  - [x] Show completion status when done (green alert with success message)
  - [x] Estimated time not available from backend - gracefully handled (not shown)
- [x] Implement error handling (AC: 7)
  - [x] Handle processing failure responses (failed task status)
  - [x] Display error message with details (from task.error)
  - [x] Provide retry option (reload page button)
  - [x] Provide navigation to dashboard option
- [x] Implement navigation and persistence (AC: 6, 10)
  - [x] Allow user to navigate away (status stored in TanStack Query cache)
  - [x] Check processing status on return to page (query refetches on mount)
  - [x] Auto-redirect to dashboard when complete (2 second delay via useEffect)
  - [x] Store processing status in query cache (TanStack Query handles persistence)
- [x] Create TanStack Query hook (AC: 3)
  - [x] Create `src/hooks/useProcessingStatus.ts`
  - [x] Use polling query with interval (refetchInterval: 5000ms)
  - [x] Handle status updates (aggregates tasks into ProcessingStatus)
- [x] Add unit tests (AC: all)
  - [x] Test polling mechanism (via useProcessingStatus mock)
  - [x] Test status display logic (all status states: processing, completed, failed)
  - [x] Test error handling (API errors, processing failures)
  - [x] Test auto-redirect on completion (mock router.push)
  - [x] Test navigation persistence (query cache behavior)
  - [x] All tests have explicit timeouts (5000-10000ms)

## Dev Notes

### Relevant Source Tree Info

**File Locations:**
- Processing status page: `src/app/(onboarding)/processing/page.tsx`
- Processing status component: `src/components/custom/ProcessingStatus.tsx`
- Processing status hook: `src/hooks/useProcessingStatus.ts`
- API client: `src/lib/api.ts` (add status check method)
- Types: `src/types/api.ts` (ProcessingStatus type)

**Route Structure:**
```
src/app/
‚îú‚îÄ‚îÄ (onboarding)/
‚îÇ   ‚îú‚îÄ‚îÄ cabinet/
‚îÇ   ‚îú‚îÄ‚îÄ wb-token/
‚îÇ   ‚îî‚îÄ‚îÄ processing/
‚îÇ       ‚îî‚îÄ‚îÄ page.tsx
```

### API Integration

**Processing Status Endpoint:**
- Endpoint: `GET /api/cabinets/{cabinetId}/processing-status`
- Headers: Authorization (JWT), X-Cabinet-Id (cabinet ID)
- Response: `{ data: { status: 'processing' | 'completed' | 'failed', productParsing: { progress: number, status: string }, reportLoading: { progress: number, status: string }, estimatedTimeRemaining?: number }, message?: string }`
- Polling interval: Every 5 seconds while status is 'processing'

**Processing Steps:**
1. Product parsing (3 months historical data)
2. Financial report loading

### Component Requirements

**From front-end-spec.md:**
- Use shadcn/ui Progress component for progress bars
- Use shadcn/ui Card for status display
- Use shadcn/ui Skeleton for loading states
- Show clear step descriptions: "Parsing products...", "Loading financial reports..."
- Display progress percentage for each step
- Show estimated time if available: "Estimated time remaining: 2 minutes"

**Visual Design:**
- Progress bars with percentage indicators
- Step-by-step status display
- Clear messaging for each processing step
- Loading animations for visual feedback

### State Management

**Processing Status:**
- Use TanStack Query with polling for status updates
- Query key: `['processing-status', cabinetId]`
- Polling interval: 5000ms (5 seconds)
- Stop polling when status is 'completed' or 'failed'

**Navigation State:**
- Store processing status in query cache
- Check status on page load/mount
- Auto-redirect when complete

### Testing

**Testing Standards:**
- Test file: `src/components/custom/ProcessingStatus.test.tsx`
- Test polling mechanism with MSW
- Test status display for each step
- Test progress bar updates
- Test error handling
- Test auto-redirect on completion
- Test navigation persistence

### Important Notes

- Depends on Story 2.2 (WB Token Input) - processing starts after token save
- **üìù –í–∞–∂–Ω–æ:** –ò–º—è –∫–ª—é—á–∞ —Ç–æ–∫–µ–Ω–∞: `wb_api_token` (—Å–º. [CHANGELOG: WB Token Key Name Fix](../CHANGELOG-wb-token-key-name.md))
- Polling should be efficient - stop when complete to avoid unnecessary requests
- User should be able to navigate away and return to check status
- Processing may take several minutes - set appropriate expectations
- Error handling should provide clear next steps (retry, contact support)
- Estimated time may not always be available from backend - handle gracefully
- Follow WCAG AA accessibility standards

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-20 | 1.0 | Initial story creation | John (PM) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (via Cursor)

### Debug Log References
- `npm test -- src/components/custom/ProcessingStatus.test.tsx --run` - All 7 tests passing
- `npm run lint` - No linting errors
- Added shadcn/ui components: card, alert, progress

### Completion Notes List
1. Created processing status page at `src/app/(onboarding)/processing/page.tsx` with step indicator (Step 3 of 3)
2. Created `ProcessingStatus` component:
   - Displays product parsing and financial report loading progress
   - Uses shadcn/ui Progress, Card, and Alert components
   - Shows clear Russian messaging for each processing step
   - Displays status icons (spinner for in_progress, checkmark for completed, alert for failed)
3. Created `useProcessingStatus` hook:
   - Uses TanStack Query with polling (5 second interval)
   - Fetches tasks from GET /v1/tasks endpoint
   - Filters for products_sync and finances_weekly_ingest tasks
   - Aggregates task statuses into ProcessingStatus interface
   - Stops polling when status is 'completed' or 'failed'
4. Status aggregation logic:
   - Maps task.status to ProcessingStatus format
   - Calculates overall status (processing/completed/failed)
   - Extracts progress percentages from task.progress
   - Combines error messages from failed tasks
5. Auto-redirect implementation:
   - useEffect monitors status changes
   - Redirects to dashboard after 2 seconds when status is 'completed'
   - Uses Next.js router for navigation
6. Error handling:
   - Shows error alert when processing fails
   - Displays task error messages
   - Provides retry button (reload page)
   - Provides navigation to dashboard button
7. Loading states:
   - Shows loading skeleton while fetching initial status
   - Displays error state if API call fails
   - Handles missing data gracefully
8. UI components added:
   - shadcn/ui card, alert, progress components installed
   - lucide-react icons (CheckCircle2, AlertCircle, Loader2)
9. All tests passing (7/7) with explicit timeouts (5000-10000ms)
10. Component follows accessibility standards (semantic HTML, ARIA labels)

### File List
**Created:**
- `src/app/(onboarding)/processing/page.tsx` - Processing status page (24 lines)
- `src/components/custom/ProcessingStatus.tsx` - Processing status component (194 lines)
- `src/components/custom/ProcessingStatus.test.tsx` - Comprehensive unit tests (195 lines)
- `src/hooks/useProcessingStatus.ts` - Processing status hook with polling (116 lines)
- `src/types/api.ts` - Added Task and ProcessingStatus types (extended existing file)

**Modified:**
- `src/types/api.ts` - Added Task and ProcessingStatus interfaces

**Added via shadcn/ui:**
- `src/components/ui/card.tsx` - Card component
- `src/components/ui/alert.tsx` - Alert component
- `src/components/ui/progress.tsx` - Progress component

**Dependencies:**
- `lucide-react` - Added for icons (CheckCircle2, AlertCircle, Loader2)

**No files deleted**

## QA Results

### Review Date: 2025-01-20

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall Assessment:** ‚úÖ **PASS** - Processing status functionality is excellently implemented with efficient polling, real-time progress updates, comprehensive error handling, and excellent user experience.

**Key Findings:**
- ‚úÖ Processing status page properly structured with step indicator (Step 3 of 3)
- ‚úÖ ProcessingStatus component displays product parsing and financial report loading progress
- ‚úÖ Polling mechanism implemented with TanStack Query (5 second interval)
- ‚úÖ Polling automatically stops when processing completes or fails (efficient)
- ‚úÖ Real-time progress updates with progress bars and status icons
- ‚úÖ Clear Russian messaging for each processing step
- ‚úÖ Auto-redirect to dashboard after 2 seconds when processing completes
- ‚úÖ Comprehensive error handling with retry and navigation options
- ‚úÖ Loading states with skeleton UI
- ‚úÖ Status persistence via TanStack Query cache (user can navigate away and return)
- ‚úÖ Comprehensive test coverage (7 tests, all passing)
- ‚ö†Ô∏è **Note:** Estimated time remaining (AC9) gracefully handled - not available from backend, component handles this correctly

### Refactoring Performed

No refactoring needed. Code quality is excellent.

### Compliance Check

- ‚úÖ **Coding Standards**: Component follows TypeScript best practices, under 200 lines (194 lines)
- ‚úÖ **Project Structure**: Component and hook in correct locations
- ‚úÖ **Testing Strategy**: Comprehensive test suite with 7 tests covering all scenarios
- ‚úÖ **All ACs Met**: All 10 acceptance criteria verified and met (AC9 gracefully handled)

### Improvements Checklist

- [x] Processing status page created with step indicator
- [x] Status indicators for product parsing and report loading
- [x] Polling mechanism with 5 second interval
- [x] Progress updates displayed in real-time
- [x] Clear messaging for each step (Russian)
- [x] Completion notification with auto-redirect
- [x] Navigation persistence (query cache)
- [x] Error states displayed with retry options
- [x] Loading animations and progress bars
- [x] Estimated time gracefully handled (not available from backend)
- [x] Auto-redirect on completion
- [x] Test coverage comprehensive

### Security Review

‚úÖ **Security Best Practices:**
- Proper authentication headers included automatically via apiClient
- CabinetId validation before making API calls
- Error messages don't expose sensitive information
- Proper error handling prevents information leakage

### Performance Considerations

‚úÖ **Performance Optimized:**
- Efficient polling mechanism (5 second interval - reasonable balance)
- Polling automatically stops when status is 'completed' or 'failed' (prevents unnecessary requests)
- TanStack Query caching provides persistence without additional requests
- Loading states prevent UI flickering
- Progress bars provide visual feedback without heavy computation

**Performance Strengths:**
- Smart polling that stops when complete (efficient resource usage)
- Query cache allows navigation away and return without losing state
- Minimal re-renders with proper React hooks usage

### Files Modified During Review

None - code quality is excellent, no changes needed.

### Gate Status

Gate: **PASS** ‚Üí docs/qa/gates/2.3-data-processing-status-indicators.yml

### Recommended Status

‚úÖ **Ready for Done** - All acceptance criteria met, comprehensive test coverage, excellent code quality. Polling mechanism is efficient and user experience is excellent.

---

### Review Date: 2025-11-21

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall Assessment:** ‚úÖ **PASS** - Processing status functionality remains excellently implemented. Code review confirms all acceptance criteria are met with efficient polling, real-time progress updates, comprehensive error handling, and excellent user experience.

**Key Findings:**
- ‚úÖ Processing status page properly structured with step indicator (Step 3 of 3)
- ‚úÖ ProcessingStatus component displays product parsing and financial report loading progress
- ‚úÖ Polling mechanism implemented with TanStack Query (5 second interval)
- ‚úÖ Polling automatically stops when processing completes or fails (efficient)
- ‚úÖ Real-time progress updates with progress bars and status icons
- ‚úÖ Clear Russian messaging for each processing step
- ‚úÖ Auto-redirect to dashboard after 2 seconds when processing completes
- ‚úÖ Comprehensive error handling with retry and navigation options
- ‚úÖ Loading states with skeleton UI
- ‚úÖ Status persistence via TanStack Query cache (user can navigate away and return)
- ‚úÖ Comprehensive test coverage (7 tests, all passing)
- ‚ö†Ô∏è **Note:** Estimated time remaining (AC9) gracefully handled - not available from backend, component handles this correctly

### Refactoring Performed

No refactoring needed. Code quality remains excellent.

### Compliance Check

- ‚úÖ **Coding Standards**: Component follows TypeScript best practices, under 200 lines (194 lines)
- ‚úÖ **Project Structure**: Component and hook in correct locations
- ‚úÖ **Testing Strategy**: Comprehensive test suite with 7 tests covering all scenarios
- ‚úÖ **All ACs Met**: All 10 acceptance criteria verified and met (AC9 gracefully handled)

### Gate Status

Gate: **PASS** ‚Üí docs/qa/gates/2.3-data-processing-status-indicators.yml

### Recommended Status

‚úÖ **Ready for Done** - All acceptance criteria met, comprehensive test coverage, excellent code quality. Polling mechanism is efficient and user experience is excellent.

