# Story 5.4: Unit Economics Integration & Testing

## Status
Draft

---

## Story

**As a** QA engineer,
**I want** comprehensive test coverage for the Unit Economics feature,
**so that** we can ensure the feature works correctly and prevent regressions.

---

## Acceptance Criteria

### Integration Testing

1. **Frontend-Backend Integration**: API calls work correctly with real backend
2. **Data Accuracy**: Displayed values match backend calculations
3. **Error Handling**: Frontend handles all error scenarios gracefully
4. **Caching**: Data is cached appropriately (TanStack Query)
5. **Authentication**: Unauthorized requests are handled

### End-to-End Testing

6. **Happy Path**: User can view unit economics for a week
7. **Week Selection**: Changing week updates data correctly
8. **View Toggle**: Switching SKU/Category/Brand views works
9. **Sorting**: Table sorting works for all sortable columns
10. **Chart Interaction**: Waterfall chart tooltips work

### Performance Testing

11. **Response Time**: Page loads in <3s with 100 SKUs
12. **Large Dataset**: Page handles 500 SKUs without crashing
13. **Memory**: No memory leaks during navigation

### Accessibility Testing

14. **WCAG AA**: Page passes accessibility audit
15. **Keyboard Navigation**: All features accessible via keyboard
16. **Screen Reader**: Chart data accessible to screen readers

### Cross-Browser Testing

17. **Chrome**: All features work
18. **Firefox**: All features work
19. **Safari**: All features work
20. **Edge**: All features work

---

## Tasks / Subtasks

### Backend Integration Tests

- [ ] Test API endpoint with real database (AC: 1, 2)
  - [ ] Create test fixtures in test database
  - [ ] Test GET `/v1/analytics/unit-economics?week=2025-W47`
  - [ ] Verify response structure matches contract
  - [ ] Verify calculations are accurate

- [ ] Test error scenarios (AC: 3)
  - [ ] Test 401 (unauthorized)
  - [ ] Test 403 (wrong cabinet)
  - [ ] Test 400 (invalid week format)
  - [ ] Test 404 (no data for week)

### Frontend Unit Tests

- [ ] Test data fetching hook (AC: 4, 5)
  - [ ] Test `useUnitEconomics` with MSW mock
  - [ ] Test caching behavior
  - [ ] Test refetch on parameter change
  - [ ] Test error state handling

- [ ] Test components (AC: 6-10)
  - [ ] Test `UnitEconomicsPage` renders
  - [ ] Test `UnitEconomicsSummary` with data
  - [ ] Test `UnitEconomicsTable` sorting
  - [ ] Test `WaterfallChart` rendering

### E2E Tests (Playwright)

- [ ] Write happy path tests (AC: 6-10)
  ```typescript
  test('Unit Economics page displays data', async ({ page }) => {
    await page.goto('/analytics/unit-economics');
    await expect(page.locator('h1')).toContainText('Unit-экономика');
    await expect(page.locator('[data-testid="summary-cards"]')).toBeVisible();
    await expect(page.locator('table tbody tr')).toHaveCount(greaterThan(0));
  });

  test('Week selector changes data', async ({ page }) => {
    await page.goto('/analytics/unit-economics');
    await page.click('[data-testid="week-selector"]');
    await page.click('text=W46');
    await expect(page.locator('[data-testid="week-display"]')).toContainText('W46');
  });
  ```

- [ ] Write error handling tests (AC: 3)
  ```typescript
  test('Shows error message on API failure', async ({ page }) => {
    await page.route('**/unit-economics**', (route) =>
      route.fulfill({ status: 500 })
    );
    await page.goto('/analytics/unit-economics');
    await expect(page.locator('[data-testid="error-message"]')).toBeVisible();
  });
  ```

### Performance Tests

- [ ] Measure page load time (AC: 11)
  - [ ] Use Playwright metrics API
  - [ ] Assert: LCP < 2.5s, FID < 100ms, CLS < 0.1
  - [ ] Log performance to CI metrics

- [ ] Test large dataset (AC: 12)
  - [ ] Create fixture with 500 SKUs
  - [ ] Verify page renders without timeout
  - [ ] Verify scroll performance

- [ ] Memory leak detection (AC: 13)
  - [ ] Use Chrome DevTools Protocol
  - [ ] Navigate away and back multiple times
  - [ ] Assert memory doesn't grow unbounded

### Accessibility Tests

- [ ] Run automated accessibility audit (AC: 14)
  ```typescript
  test('Page passes accessibility audit', async ({ page }) => {
    await page.goto('/analytics/unit-economics');
    const accessibilityScanResults = await new AxeBuilder({ page }).analyze();
    expect(accessibilityScanResults.violations).toEqual([]);
  });
  ```

- [ ] Manual keyboard navigation test (AC: 15)
  - [ ] Tab through all interactive elements
  - [ ] Test week selector with keyboard
  - [ ] Test table sorting with keyboard
  - [ ] Test chart with keyboard

- [ ] Screen reader test (AC: 16)
  - [ ] Test with VoiceOver (macOS)
  - [ ] Test with NVDA (Windows) if available
  - [ ] Verify chart data is announced

### Cross-Browser Tests

- [ ] Run tests on all browsers (AC: 17-20)
  - [ ] Configure Playwright for multiple browsers
  - [ ] Run full E2E suite on Chrome, Firefox, Safari, Edge
  - [ ] Document any browser-specific issues

---

## Dev Notes

### Test File Structure

```
tests/
├── unit/
│   ├── hooks/
│   │   └── useUnitEconomics.test.ts
│   └── components/
│       ├── UnitEconomicsPage.test.tsx
│       ├── UnitEconomicsSummary.test.tsx
│       ├── UnitEconomicsTable.test.tsx
│       └── WaterfallChart.test.tsx
├── integration/
│   └── unit-economics.integration.test.ts
├── e2e/
│   ├── unit-economics.spec.ts
│   └── unit-economics-a11y.spec.ts
└── fixtures/
    └── unit-economics-data.json
```

### Test Data Fixtures

```typescript
// tests/fixtures/unit-economics-data.json
{
  "summary": {
    "total_revenue": 1500000,
    "avg_cogs_pct": 35.2,
    "avg_wb_fees_pct": 44.8,
    "avg_net_margin_pct": 20.0,
    "sku_count": 85,
    "profitable_sku_count": 72,
    "loss_making_sku_count": 13
  },
  "data": [
    {
      "sku_id": "12345",
      "product_name": "Widget Pro",
      "revenue": 100000,
      "costs_pct": {
        "cogs": 30.0,
        "commission": 15.0,
        "logistics_delivery": 8.0,
        "logistics_return": 2.0,
        "storage": 3.0,
        "paid_acceptance": 1.5,
        "penalties": 0.5,
        "other_deductions": 1.0
      },
      "net_margin_pct": 39.0,
      "profitability_status": "excellent"
    },
    {
      "sku_id": "67890",
      "product_name": "Loss Product",
      "revenue": 50000,
      "costs_pct": {
        "cogs": 60.0,
        "commission": 20.0,
        "logistics_delivery": 15.0,
        "logistics_return": 10.0,
        "storage": 5.0,
        "paid_acceptance": 2.0,
        "penalties": 3.0,
        "other_deductions": 2.0
      },
      "net_margin_pct": -17.0,
      "profitability_status": "loss"
    }
  ]
}
```

### MSW Handlers

```typescript
// tests/mocks/handlers.ts
import { rest } from 'msw';
import unitEconomicsData from '../fixtures/unit-economics-data.json';

export const unitEconomicsHandlers = [
  rest.get('/v1/analytics/unit-economics', (req, res, ctx) => {
    const week = req.url.searchParams.get('week');
    if (!week) {
      return res(ctx.status(400), ctx.json({ error: 'Week required' }));
    }
    return res(ctx.json(unitEconomicsData));
  }),
];
```

### Playwright Configuration

```typescript
// playwright.config.ts
export default defineConfig({
  projects: [
    { name: 'chromium', use: { ...devices['Desktop Chrome'] } },
    { name: 'firefox', use: { ...devices['Desktop Firefox'] } },
    { name: 'webkit', use: { ...devices['Desktop Safari'] } },
    { name: 'edge', use: { channel: 'msedge' } },
  ],
  webServer: {
    command: 'npm run dev',
    port: 3100,
  },
});
```

### Performance Metrics Collection

```typescript
// tests/e2e/unit-economics-performance.spec.ts
test('Page performance metrics', async ({ page }) => {
  await page.goto('/analytics/unit-economics');

  const metrics = await page.evaluate(() => ({
    lcp: performance.getEntriesByType('largest-contentful-paint')[0]?.startTime,
    fid: performance.getEntriesByType('first-input')[0]?.processingStart,
    cls: performance.getEntriesByType('layout-shift')
      .reduce((sum, e) => sum + e.value, 0),
  }));

  expect(metrics.lcp).toBeLessThan(2500);
  expect(metrics.cls).toBeLessThan(0.1);

  // Log to CI
  console.log('Performance metrics:', metrics);
});
```

---

## Test Coverage Requirements

| Area | Target | Method |
|------|--------|--------|
| Unit Economics Service (Backend) | >80% | Jest |
| Frontend Components | >70% | React Testing Library |
| API Integration | 100% of endpoints | Supertest |
| E2E Happy Paths | 100% | Playwright |
| Accessibility | WCAG AA | axe-core |

---

## Definition of Done

- [ ] All unit tests pass (>80% coverage for new code)
- [ ] Integration tests pass
- [ ] E2E tests pass on all 4 browsers
- [ ] Performance tests pass (LCP <2.5s)
- [ ] Accessibility audit passes (0 violations)
- [ ] No memory leaks detected
- [ ] Test results documented
- [ ] CI pipeline updated with new tests

---

## Related Documentation

- **Epic Overview**: `5.0.unit-economics-epic.md`
- **API Story**: `5.1.unit-economics-backend-api.md`
- **Page Story**: `5.2.unit-economics-page-structure.md`
- **Chart Story**: `5.3.cost-breakdown-visualization.md`

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-09 | 1.0 | Initial story creation | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used
_(To be populated by dev agent)_

### Completion Notes List
_(To be populated by dev agent)_

### File List
_(To be populated by dev agent)_

---

## QA Results

### Review Date: 2025-12-13

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall**: Story **NOT IMPLEMENTED**. Status is "Draft" and no test files exist.

**Findings**:
- Story status: Draft (not started)
- No unit tests for Unit Economics components/hooks
- No E2E tests for Unit Economics page
- No MSW handlers for unit-economics API
- Project has established test patterns (50+ existing test files) that should be followed

### Evidence Search

| Search | Result |
|--------|--------|
| `tests/**/*unit-economics*` | No files found |
| `src/**/*unit-economics*.test.ts*` | No files found |
| `e2e/*unit-economics*.spec.ts` | No files found |
| `mocks/*unit-economics*` | No files found |

**Existing Test Patterns** (for reference):
- Unit tests: `src/hooks/__tests__/*.test.ts`
- Component tests: `src/components/custom/__tests__/*.test.tsx`
- E2E tests: `e2e/*.spec.ts`
- MSW mocks: Pattern exists in project

### Requirements Traceability

| AC | Requirement | Status | Notes |
|----|-------------|--------|-------|
| AC-1 | Frontend-Backend Integration | ❌ NOT STARTED | |
| AC-2 | Data Accuracy Tests | ❌ NOT STARTED | |
| AC-3 | Error Handling Tests | ❌ NOT STARTED | |
| AC-4 | Caching Tests | ❌ NOT STARTED | |
| AC-5 | Authentication Tests | ❌ NOT STARTED | |
| AC-6-10 | E2E Happy Path | ❌ NOT STARTED | |
| AC-11-13 | Performance Tests | ❌ NOT STARTED | |
| AC-14-16 | Accessibility Tests | ❌ NOT STARTED | |
| AC-17-20 | Cross-Browser Tests | ❌ NOT STARTED | |

### Compliance Check

- Coding Standards: N/A (not implemented)
- Project Structure: N/A
- Testing Strategy: ❌ No tests exist
- All ACs Met: ❌ 0/20 ACs complete

### Required Test Files (Based on Story Spec)

```
tests/
├── unit/
│   ├── hooks/
│   │   └── useUnitEconomics.test.ts
│   └── components/
│       ├── UnitEconomicsSummaryCards.test.tsx
│       ├── UnitEconomicsTable.test.tsx
│       └── UnitEconomicsWaterfall.test.tsx
├── e2e/
│   ├── unit-economics.spec.ts
│   └── unit-economics-a11y.spec.ts
└── mocks/
    └── handlers/
        └── unit-economics.ts
```

### Improvements Checklist

- [ ] Create MSW handlers for `/v1/analytics/unit-economics`
- [ ] Create `useUnitEconomics.test.ts` hook tests
- [ ] Create component tests for Summary/Table/Waterfall
- [ ] Create E2E happy path tests
- [ ] Create E2E error handling tests
- [ ] Run accessibility audit
- [ ] Create performance tests
- [ ] Configure cross-browser test runs
- [ ] Update CI pipeline

### Gate Status

Gate: **FAIL** → `docs/qa/gates/5.4-unit-economics-integration-testing.yml`

**Reason**: Story is in Draft status. No test implementation exists. All 20 ACs are NOT STARTED.

### Recommended Status

❌ **Not Ready** - Implementation Required

**Priority Actions**:
1. Update story status to "In Progress"
2. Create MSW mock handlers
3. Create hook unit tests
4. Create E2E happy path test
5. Run accessibility audit
