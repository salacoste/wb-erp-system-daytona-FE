# Story 3.3: Expense Breakdown Visualization

## Status
Done

## Story

**As a** business owner,  
**I want** to see a breakdown of expenses visualized on the dashboard,  
**so that** I can understand where my money is being spent.

## Acceptance Criteria

1. Expense breakdown chart/graph displays on dashboard
2. Visualization shows different expense categories
3. Chart uses appropriate visualization type (bar chart, pie chart, or other as per design)
4. Values are formatted as currency (RUB) using Intl.NumberFormat
5. Chart is interactive (tooltips on hover showing details)
6. Data loads from backend API endpoint
7. Loading state is shown during data fetch
8. Error handling displays message if data unavailable
9. Chart is responsive and maintains readability
10. Color coding follows established patterns (Green/Red/Blue)

## Tasks / Subtasks

- [x] Select and install charting library (AC: 1, 3, 5)
  - [x] Research charting libraries (Recharts, Chart.js, etc.)
  - [x] Install selected library (recommend Recharts for React)
  - [x] Configure library with project setup
- [x] Create ExpenseChart component (AC: 1, 2, 3, 4, 5, 9, 10)
  - [x] Create `src/components/custom/ExpenseChart.tsx`
  - [x] Implement chart visualization (bar or pie chart)
  - [x] Display expense categories with values
  - [x] Format values as currency (RUB)
  - [x] Add interactive tooltips on hover
  - [x] Make chart responsive
  - [x] Apply color coding (Green/Red/Blue patterns)
- [x] Create expense data hook (AC: 6)
  - [x] Create `src/hooks/useExpenses.ts` or extend `useDashboard.ts`
  - [x] Use TanStack Query to fetch expense data
  - [x] Call GET /api/dashboard/expenses endpoint
  - [x] Handle caching and refetching
- [x] Integrate chart into dashboard (AC: 1)
  - [x] Add ExpenseChart to dashboard page
  - [x] Position chart appropriately on dashboard
  - [x] Ensure proper spacing and layout
- [x] Implement loading states (AC: 7)
  - [x] Show skeleton loader while data is fetching
  - [x] Use shadcn/ui Skeleton component
  - [x] Display loading state for chart area
- [x] Implement error handling (AC: 8)
  - [x] Handle API errors gracefully
  - [x] Display error message in Russian
  - [x] Show retry option
  - [x] Display fallback message if no expense data
- [x] Implement tooltip interactivity (AC: 5)
  - [x] Show expense category name on hover
  - [x] Show formatted currency value on hover
  - [x] Show percentage of total if applicable
  - [x] Use charting library's tooltip feature
- [x] Add unit tests (AC: all)
  - [x] Test ExpenseChart component rendering
  - [x] Test currency formatting in chart
  - [x] Test API integration with MSW
  - [x] Test loading states
  - [x] Test error handling
  - [x] Test tooltip interactivity
  - [x] Test responsive behavior

## Dev Notes

### Relevant Source Tree Info

**File Locations:**
- Expense chart component: `src/components/custom/ExpenseChart.tsx`
- Expense data hook: `src/hooks/useExpenses.ts` or `useDashboard.ts`
- Dashboard page: `src/app/(dashboard)/dashboard/page.tsx`
- Formatting utilities: `src/lib/utils.ts`
- API client: `src/lib/api.ts`
- Types: `src/types/api.ts` (ExpenseData type)

**Component Structure:**
```
src/components/custom/
├── ExpenseChart.tsx      # Expense breakdown chart component
```

### API Integration

**Expense Breakdown Endpoint:**
- Endpoint: `GET /v1/analytics/weekly/finance-summary` (via `available-weeks` → `finance-summary`)
- Headers: Authorization (JWT), X-Cabinet-Id (cabinet ID)
- Response: `{ summary_total: {...}, summary_rus: {...}, summary_eaeu: {...}, meta: {...} }`
- Caching: Stale time 30 seconds, cache time 5 minutes
- **Story 2.7:** Endpoint `available-weeks` теперь использует `weekly_payout_total` вместо `imports` (задеплоено)
- **Документация:** См. `docs/API-DATA-VERIFICATION-REPORT.md` для деталей проверки корректности получения данных

### Component Requirements

**From front-end-spec.md:**
- Chart type: Bar chart or pie chart (to be determined based on data structure)
- Interactive tooltips showing category name and amount
- Color coding: Use established color patterns
- Responsive: Chart adapts to container size
- Accessibility: Chart should have text alternatives

**Currency Formatting (from PRD FR22):**
- Format: `Intl.NumberFormat('ru-RU', { style: 'currency', currency: 'RUB' })`
- Display in tooltips and chart labels

### Charting Library

**Recommended: Recharts**
- React-native charting library
- Good TypeScript support
- Responsive by default
- Accessible options available
- Easy to customize colors

**Alternative: Chart.js with react-chartjs-2**
- More features but larger bundle size
- Good for complex visualizations

### State Management

**Data Fetching:**
- Use TanStack Query for server state
- Query key: `['dashboard', 'expenses']` or include in `['dashboard', 'metrics']`
- Stale time: 30 seconds
- Refetch on window focus: true

### Testing

**Testing Standards:**
- Test file: `src/components/custom/ExpenseChart.test.tsx`
- Test chart rendering with sample data
- Test currency formatting in tooltips
- Test API integration with MSW
- Test loading states
- Test error handling
- Test tooltip interactivity (if testable)
- Test responsive behavior

### Important Notes

- Depends on Story 3.1 (Dashboard Layout) and Story 1.5 (API Client)
- Can be developed in parallel with Stories 3.2, 3.4
- Chart type (bar vs pie) should be determined based on data structure and UX best practices
- Tooltips are important for showing detailed information
- Chart should be accessible (text alternatives, keyboard navigation if possible)
- Color coding must follow established patterns (Green/Red/Blue)
- Follow WCAG AA accessibility standards

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-20 | 1.0 | Initial story creation | John (PM) |
| 2025-11-22 | 1.1 | Enhancement: Expanded expense categories from 4 to 9 based on SDK → DB mapping table. Added support for: Платная приёмка, Корректировка комиссии WB, Удержание баллов лояльности, Эквайринг, Комиссия продаж | Dev Agent (Claude) |
| 2025-11-22 | 1.2 | Backend fix (Request #06): Added missing fields acquiring_fee_total and commission_sales_total. Updated category name: "Корректировка комиссии WB" → "Прочие комиссии WB" (now contains only commission_other, NOT commission_sales). Removed DEBUG logging. | Dev Agent (Claude) |
| 2025-11-22 | 1.3 | UI Enhancement: Removed zero-value filtering. Always display all 9 expense categories for consistency, even when amounts are zero. This provides better visual consistency across different weeks and explicitly shows zero expenses. Added sorting: non-zero values displayed first (left to right), then zero values. | Dev Agent (Claude) |
| 2025-11-22 | 1.4 | Mobile Enhancement: Optimized chart margins for small screens (<640px). Removed horizontal margins (left/right) and reduced Y-axis width (80→60px) on mobile to maximize chart width and improve readability on small devices. Chart now uses full available width on mobile screens. | Dev Agent (Claude) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (via Cursor)

### Debug Log References
- All tests passing: `npm test -- src/components/custom/ExpenseChart.test.tsx --run`
- All tests passing: `npm test -- src/hooks/useExpenses.test.ts --run`
- No linter errors in implemented files

### Completion Notes List
- ✅ Recharts library installed and configured (v3.4.1)
- ✅ ExpenseChart component created with full functionality:
  - Bar chart visualization with responsive container
  - Custom tooltips showing category, amount, and percentage
  - Loading state with Skeleton component
  - Error handling with retry button
  - Empty state message for no data
  - Color-coded bars using established palette
- ✅ useExpenses hook implemented:
  - Fetches data from `/v1/analytics/weekly/finance-summary` endpoint
  - Extracts all 9 expense categories from SDK → DB mapping:
    - Логистика (logistics_cost)
    - Хранение (storage_cost)
    - Платная приёмка (paid_acceptance_cost)
    - Штрафы (penalties)
    - Прочие комиссии WB (wb_commission_adj) - **only commission_other** (Request #06)
    - Комиссия лояльности (loyalty_fee)
    - Удержание баллов лояльности (loyalty_points_withheld)
    - Эквайринг (acquiring_fee) - **Request #06 backend fix**
    - Комиссия продаж (commission_sales) - **Request #06 backend fix**
  - Calculates percentages automatically
  - Always displays all 9 categories (including zero values for consistency)
  - Smart sorting: non-zero expenses first (left to right), then zero expenses
  - Handles errors gracefully
  - Configured with proper caching (staleTime: 30s, gcTime: 5min)
- ✅ Chart integrated into dashboard page
- ✅ Comprehensive unit tests added:
  - ExpenseChart.test.tsx: 6 tests covering all states and interactions
  - useExpenses.test.ts: 9 tests covering data fetching, transformation, and error handling
- ✅ All acceptance criteria met and tested

### File List
**Created:**
- `src/components/custom/ExpenseChart.tsx` (147 lines)
- `src/hooks/useExpenses.ts` (170 lines)
- `src/components/custom/ExpenseChart.test.tsx` (175 lines)
- `src/hooks/useExpenses.test.tsx` (237 lines)

**Modified:**
- `src/app/(dashboard)/dashboard/page.tsx` (added ExpenseChart component)
- `src/hooks/useDashboard.ts` (extended FinanceSummary interface with all expense fields)
- `package.json` (added recharts dependency)

## QA Results

### Review Date: 2025-11-21

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall Assessment:** ✅ **PASS** - Expense breakdown visualization is excellently implemented with BarChart displaying expense categories, proper currency formatting, interactive tooltips with percentages, color coding, comprehensive loading/error/empty states, and responsive design. All 10 acceptance criteria met.

**Key Findings:**
- ✅ Expense breakdown chart displays on dashboard (BarChart using Recharts)
- ✅ Visualization shows all 9 expense categories from SDK → DB mapping:
  - Логистика, Хранение, Платная приёмка, Штрафы, **Прочие комиссии WB** (commission_other only), Комиссия лояльности, Удержание баллов лояльности, **Эквайринг** (Request #06), **Комиссия продаж** (Request #06)
- ✅ Chart uses appropriate visualization type: Bar chart (Recharts BarChart)
- ✅ Values formatted as currency (RUB): formatCurrency used in tooltip and YAxis
- ✅ Chart is interactive: Custom tooltip showing category, formatted currency amount, and percentage
- ✅ Data loads from backend API: Uses existing endpoints (`/v1/analytics/weekly/available-weeks` and `/v1/analytics/weekly/finance-summary`)
- ✅ Loading state: Skeleton loader shown during data fetch
- ✅ Error handling: Error messages in Russian with retry button
- ✅ Chart is responsive: ResponsiveContainer ensures chart adapts to screen size
- ✅ Color coding: Expanded color palette with 9 colors (Blue #2196F3, Green #4CAF50, Orange #FF9800, Red #E53935, Purple #9C27B0, Cyan #00BCD4, Deep Orange #FF5722, Amber #FFC107, Deep Purple #673AB7)
- ✅ Comprehensive test coverage: 15 tests (6 component, 9 hook) covering all states and edge cases

**Implementation Highlights:**
- **Smart Data Handling**: Uses `summary_total` with fallback to `summary_rus`, handles both `_total` and non-`_total` field variants
- **Zero-Value Filtering**: Filters out zero-value expenses to reduce chart complexity and improve readability
- **Percentage Calculation**: Automatically calculates percentages for each expense category
- **Graceful Degradation**: Handles empty weeks array gracefully (normal state, not error)
- **Error Isolation**: Failed API calls return empty data without breaking the component

### Refactoring Performed

No refactoring needed. Code quality is excellent.

### Compliance Check

- ✅ **Coding Standards**: All components follow TypeScript best practices, ExpenseChart 136 lines (under 200), useExpenses hook 149 lines (under 200)
- ✅ **Project Structure**: Components in correct locations, follows established patterns (MetricCard, TrendGraph)
- ✅ **Testing Strategy**: Comprehensive test suite with 15 tests covering all scenarios (loading, error, empty, data states, API integration, data transformation, percentage calculation)
- ✅ **All ACs Met**: All 10 acceptance criteria verified and met
- ✅ **Design Patterns**: Follows front-end-spec.md design patterns (Recharts BarChart, proper currency formatting, interactive tooltips, color coding)

### Improvements Checklist

- [x] ExpenseChart component created with BarChart displaying expense categories
- [x] Interactive tooltips with formatted currency values and percentages
- [x] Currency formatting using Intl.NumberFormat with 'ru-RU' locale and 'RUB' currency
- [x] Color coding following established patterns (Blue, Green, Red, Orange, Purple)
- [x] Loading states with skeleton loaders
- [x] Error states with Russian messages and retry option
- [x] Empty state with informative message
- [x] Responsive design using ResponsiveContainer
- [x] Zero-value expenses filtered out
- [x] Comprehensive unit tests (15 tests, all passing)

### Security Review

✅ **Security Best Practices:**
- API calls use centralized API client (`apiClient`) which automatically includes authentication headers (JWT, X-Cabinet-Id)
- Component only displays read-only financial data
- No user input or sensitive operations
- Proper error handling prevents information leakage

**Security Strengths:**
- All API calls go through authenticated API client
- Error messages are user-friendly (Russian) without exposing technical details
- No sensitive data exposed in client-side code

### Performance Considerations

✅ **Performance Optimized:**
- TanStack Query caching: 30s stale time, 5min cache time (appropriate for expense data)
- Responsive chart rendering: ResponsiveContainer ensures chart adapts without unnecessary re-renders
- Zero-value filtering: Reduces chart complexity by filtering out expenses with zero values
- Efficient data transformation: Percentage calculation done once during data fetch

**Performance Strengths:**
- Smart caching strategy balances freshness with performance
- Window focus refetch provides good UX without excessive API calls
- Loading states prevent unnecessary re-renders
- Filtered data reduces chart rendering complexity

### Accessibility Review

⚠️ **Minor Enhancement Opportunity:**
- Chart has visual representation and tooltips
- **Recommendation**: Consider adding `aria-label` or `aria-describedby` to chart container for better screen reader support
- Keyboard navigation not implemented (optional enhancement per Story notes)

**Note:** This is a minor enhancement and does not block the story. The chart is functional and accessible via mouse/touch interactions.

### Files Modified During Review

None - code quality is excellent, no changes needed.

### Gate Status

Gate: **PASS** → docs/qa/gates/3.3-expense-breakdown-visualization.yml

### Recommended Status

✅ **Ready for Done** - All 10 acceptance criteria met, comprehensive test coverage (15 tests), excellent code quality. Expense breakdown chart properly displays expense categories with currency formatting, interactive tooltips, color coding, responsive design, and proper error handling. Implementation uses existing API endpoints efficiently with smart data handling and zero-value filtering.

