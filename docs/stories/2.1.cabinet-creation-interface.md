# Story 2.1: Cabinet Creation Interface

## Status
Done

## Story

**As a** new user,  
**I want** to create my first cabinet during onboarding,  
**so that** I can organize my Wildberries business data.

## Acceptance Criteria

1. Cabinet creation form displays with required fields (cabinet name at minimum)
2. Form validates input before submission
3. Cabinet creation API endpoint is called with proper request format
4. Created cabinet ID is stored in user context/state
5. Success message displays upon successful cabinet creation
6. User is guided to next step in onboarding flow
7. Error messages display clearly for creation failures
8. Loading state is shown during API call
9. Form prevents multiple submissions while processing

## Tasks / Subtasks

- [x] Create cabinet creation page route (AC: 1)
  - [x] Create `src/app/(onboarding)/cabinet/page.tsx`
  - [x] Set up onboarding layout/wizard structure with step indicator
- [x] Create cabinet creation form component (AC: 1, 2)
  - [x] Create `src/components/custom/CabinetCreationForm.tsx`
  - [x] Add cabinet name input field
  - [x] Use React Hook Form for form state
  - [x] Use shadcn/ui Form, Input, Button components
- [x] Implement form validation (AC: 2)
  - [x] Validate cabinet name (required, min 2, max 100 characters)
  - [x] Show real-time validation feedback (onBlur mode)
  - [x] Prevent submission with invalid data
- [x] Integrate with cabinet creation API (AC: 3, 4, 5)
  - [x] API endpoint function exists in `src/lib/api.ts` (createCabinet)
  - [x] Service function `handleCreateCabinet` in `src/services/cabinets.service.ts`
  - [x] Calls POST /v1/cabinets endpoint via apiClient
  - [x] Handles successful response with cabinet ID and newToken
  - [x] Stores cabinet ID in auth store (Zustand) via setCabinetId
  - [x] Updates JWT token in auth store (critical for cabinet access)
- [x] Implement success flow (AC: 5, 6)
  - [x] Display success message/toast (Russian)
  - [x] Navigate to next onboarding step (WB token input)
  - [x] Use Next.js router for navigation
- [x] Implement error handling (AC: 7)
  - [x] Handle API errors (validation, server errors)
  - [x] Display user-friendly error messages in Russian
  - [x] Special handling for token refresh errors
- [x] Implement loading and submission states (AC: 8, 9)
  - [x] Show loading state ("Создание...") during API call
  - [x] Disable form submission button during processing
  - [x] Prevent multiple form submissions (disabled state)
- [x] Update auth store with cabinet support (AC: 4)
  - [x] cabinetId already in auth store state
  - [x] setCabinetId method exists in store
  - [x] Persist cabinet ID in storage (via Zustand persist)
- [x] Add unit tests (AC: all)
  - [x] Test form validation (min length, required)
  - [x] Test API integration (handleCreateCabinet call)
  - [x] Test cabinet ID storage in auth store (via service)
  - [x] Test error handling
  - [x] Test navigation flow
  - [x] Test loading states
  - [x] All tests have explicit timeouts (5000-10000ms)

## Dev Notes

### Relevant Source Tree Info

**File Locations:**
- Cabinet creation page: `src/app/(onboarding)/cabinet/page.tsx`
- Cabinet form component: `src/components/custom/CabinetCreationForm.tsx`
- Auth store: `src/stores/authStore.ts` (add cabinetId support)
- API client: `src/lib/api.ts` (add cabinet API methods)
- Types: `src/types/api.ts` (Cabinet type)

**Route Structure (from front-end-architecture.md):**
```
src/app/
├── (onboarding)/     # Onboarding route group
│   ├── cabinet/
│   │   └── page.tsx
│   ├── wb-token/
│   │   └── page.tsx
│   └── processing/
│       └── page.tsx
```

### API Integration

**Cabinet Creation Endpoint:**
- Endpoint: `POST /api/cabinets`
- Request body: `{ name: string, description?: string }`
- Response: `{ data: { id: string, name: string, userId: string }, message?: string }`
- Error responses: 400 (validation), 401 (unauthorized), 500 (server error)

**Cabinet ID Storage:**
- Store in auth store: `cabinetId: string | null`
- Persist in localStorage (via Zustand persist middleware)
- Include in X-Cabinet-Id header for all subsequent API requests

### Component Requirements

**From front-end-spec.md:**
- Use shadcn/ui Form components
- Use shadcn/ui Input for cabinet name
- Use shadcn/ui Button (Primary variant, red #E53935)
- Use shadcn/ui Toast for success/error messages
- Form should be part of onboarding wizard flow
- Show progress indicator (step 1 of 3, etc.)

**Form Validation:**
- Cabinet name: Required, minimum 2 characters, maximum 100 characters
- Real-time validation feedback
- Submit button disabled until valid

### State Management

**Auth Store Updates:**
```typescript
// Add to authStore.ts
interface AuthState {
  // ... existing fields
  cabinetId: string | null
  setCabinetId: (id: string) => void
}
```

**Form State:**
- React Hook Form for local form state
- TanStack Query mutation for API call

### Testing

**Testing Standards:**
- Test file: `src/components/custom/CabinetCreationForm.test.tsx`
- Test form validation (name requirements)
- Test API integration with MSW
- Test cabinet ID storage in auth store
- Test error handling
- Test navigation to next step
- Test loading states

### Important Notes

- Depends on Epic 1 complete (authentication required)
- Cabinet ID must be stored and available for all subsequent API calls
- This is step 1 of onboarding flow - user must complete before proceeding
- Error messages should be in Russian for UI
- Form should be accessible (keyboard navigation, screen readers)
- Follow WCAG AA accessibility standards

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-20 | 1.0 | Initial story creation | John (PM) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (via Cursor)

### Debug Log References
- `npm test -- src/components/custom/CabinetCreationForm.test.tsx --run` - All 7 tests passing
- `npm run lint` - No linting errors

### Completion Notes List
1. Created onboarding cabinet page at `src/app/(onboarding)/cabinet/page.tsx` with step indicator
2. CabinetCreationForm component already existed and meets all requirements
3. Form validation implemented with Zod schema (min 2, max 100 characters)
4. API integration via `handleCreateCabinet` service function which:
   - Calls `createCabinet` API function (uses new apiClient from Story 1.5)
   - Automatically updates JWT token in auth store (critical requirement)
   - Sets cabinetId in auth store for subsequent API calls
5. Success flow: toast notification + navigation to `/onboarding/wb-token`
6. Error handling: user-friendly Russian messages with special token error handling
7. Loading states: button shows "Создание..." and is disabled during submission
8. Auth store already had cabinetId support from previous stories
9. All tests passing (7/7) with explicit timeouts (5000-10000ms)
10. Component follows accessibility standards (aria-required, aria-invalid, aria-busy)

### File List
**Created:**
- `src/app/(onboarding)/cabinet/page.tsx` - Onboarding cabinet creation page (28 lines)

**Modified:**
- `src/components/custom/CabinetCreationForm.test.tsx` - Added explicit timeouts to all tests

**Verified (already existed and working):**
- `src/components/custom/CabinetCreationForm.tsx` - Form component (116 lines)
- `src/services/cabinets.service.ts` - Cabinet creation service with token refresh
- `src/stores/authStore.ts` - Already has cabinetId support
- `src/lib/api.ts` - Already has createCabinet function

**No files deleted**

## QA Results

### Review Date: 2025-01-20

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall Assessment:** ✅ **PASS** - Cabinet creation functionality is excellently implemented with critical token refresh handling, proper cabinet ID storage, and comprehensive error handling.

**Key Findings:**
- ✅ Cabinet creation form properly structured with React Hook Form and Zod validation
- ✅ Form validation enforces min 2, max 100 characters for cabinet name
- ✅ Service layer (`handleCreateCabinet`) properly handles critical token refresh
- ✅ JWT token automatically updated in auth store after cabinet creation (critical requirement)
- ✅ Cabinet ID stored in auth store and persisted via Zustand
- ✅ Success flow with toast notification and navigation to next onboarding step
- ✅ Comprehensive error handling including token refresh failure scenarios
- ✅ Loading states and disabled button during submission
- ✅ Comprehensive test coverage (7 tests, all passing)
- ✅ Onboarding page with step indicator (Step 1 of 3)

### Refactoring Performed

No refactoring needed. Code quality is excellent.

### Compliance Check

- ✅ **Coding Standards**: Component follows TypeScript best practices, under 200 lines (116 lines)
- ✅ **Project Structure**: Component and service in correct locations
- ✅ **Testing Strategy**: Comprehensive test suite with 7 tests covering all scenarios
- ✅ **All ACs Met**: All 9 acceptance criteria verified and met

### Improvements Checklist

- [x] Form validation implemented correctly (Zod schema)
- [x] API integration with proper token refresh handling
- [x] Cabinet ID storage in auth store
- [x] JWT token update after cabinet creation (critical)
- [x] Loading states and disabled states
- [x] Success flow with redirect
- [x] Error messages in Russian for UI
- [x] Test coverage comprehensive
- [x] Onboarding page structure with step indicator

### Security Review

✅ **Security Best Practices:**
- Authentication required (token checked in service)
- JWT token automatically refreshed after cabinet creation (critical for cabinet access)
- Cabinet ID securely stored in auth store with persistence
- Error messages don't expose sensitive information
- Proper error handling for token refresh failures

**Critical Security Feature:**
- ⚠️ **Token Refresh After Cabinet Creation**: The service layer (`handleCreateCabinet`) correctly updates the JWT token in the auth store after cabinet creation. This is critical because the backend returns a new token that must be used for subsequent API calls to access the created cabinet. The implementation properly handles this with error handling if token update fails.

### Performance Considerations

✅ **Performance Optimized:**
- Client-side validation reduces unnecessary API calls
- Form validation is efficient (onBlur mode)
- Loading states prevent multiple submissions
- TanStack Query handles caching and retries

### Files Modified During Review

None - code quality is excellent, no changes needed.

### Gate Status

Gate: **PASS** → docs/qa/gates/2.1-cabinet-creation-interface.yml

### Recommended Status

✅ **Ready for Done** - All acceptance criteria met, comprehensive test coverage, excellent code quality. Critical token refresh handling properly implemented.

---

### Review Date: 2025-11-21

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall Assessment:** ✅ **PASS** - Cabinet creation functionality remains excellently implemented. Code review confirms all acceptance criteria are met with proper token refresh handling, comprehensive error handling, and full test coverage.

**Key Findings:**
- ✅ Cabinet creation form properly structured with React Hook Form and Zod validation
- ✅ Form validation enforces min 2, max 100 characters for cabinet name
- ✅ Service layer (`handleCreateCabinet`) properly handles critical token refresh
- ✅ JWT token automatically updated in auth store after cabinet creation (critical requirement)
- ✅ Cabinet ID stored in auth store and persisted via Zustand
- ✅ Success flow with toast notification and navigation to next onboarding step
- ✅ Comprehensive error handling including token refresh failure scenarios
- ✅ Loading states and disabled button during submission
- ✅ Comprehensive test coverage (7 tests, all passing)
- ✅ Onboarding page with step indicator (Step 1 of 3)

### Refactoring Performed

No refactoring needed. Code quality remains excellent.

### Compliance Check

- ✅ **Coding Standards**: Component follows TypeScript best practices, under 200 lines (116 lines)
- ✅ **Project Structure**: Component and service in correct locations
- ✅ **Testing Strategy**: Comprehensive test suite with 7 tests covering all scenarios
- ✅ **All ACs Met**: All 9 acceptance criteria verified and met

### Gate Status

Gate: **PASS** → docs/qa/gates/2.1-cabinet-creation-interface.yml

### Recommended Status

✅ **Ready for Done** - All acceptance criteria met, comprehensive test coverage, excellent code quality. Critical token refresh handling properly implemented.

