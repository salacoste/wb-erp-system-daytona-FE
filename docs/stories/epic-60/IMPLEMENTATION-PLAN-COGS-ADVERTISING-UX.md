# План реализации: UX улучшения для Margin и Advertising

## Краткий обзор

### Проблемы
На основе анализа ответов бэкенда выявлены две UX-проблемы:

1. **Margin % = null** - Не является багом, но требует улучшения UX
   - Причина: `weekly_margin_fact` пуста, COGS не назначены для товаров
   - Текущее поведение: Показывается "—" без объяснения
   - Требуемое поведение: Информативное сообщение с призывом к действию

2. **Advertising = 0 ₽** - Не является багом, но требует улучшения UX
   - Причина: Данные за выбранный период (2025-W47) отсутствуют
   - Доступный диапазон: 2025-12-01 to 2026-01-28
   - Текущее поведение: Показывается "0 ₽" без контекста
   - Требуемое поведение: Пояснение отсутствия данных с указанием доступного диапазона

### Решения
- **CogsMissingState компонент** - Информативное состояние при отсутствии COGS
- **AdvertisingEmptyState компонент** - Пустое состояние для advertising данных
- **Интеграция** - Обновление существующих компонентов для использования новых состояний

---

## Задачи

### Задача 1: CogsMissingState компонент (P0)

**Приоритет:** Критический (P0)
**Срок:** Неделя 1
**Зависимости:** Нет

**Описание:**
Создать компонент для отображения состояния отсутствия COGS с уровнями критичности и возможностью перехода к управлению COGS.

**Спецификация:**

**Уровни критичности:**
- **Critical (0%)** - Нет COGS для всех товаров
  - Цвет: Red (#EF4444)
  - Иконка: Alert/Warning
  - Сообщение: "Для расчета маржи необходимо назначить себестоимость для товаров"

- **Warning (1-49%)** - COGS назначены для менее половины товаров
  - Цвет: Yellow (#F59E0B)
  - Иконка: Info
  - Сообщение: "Назначена себестоимость для X% товаров. Рекомендуется указать для всех товаров"

- **Info (50-99%)** - COGS назначены для большинства товаров
  - Цвет: Blue (#3B82F6)
  - Иконка: CheckCircle
  - Сообщение: "Назначена себестоимость для X% товаров. Для точного расчета укажите для всех товаров"

**Функциональность:**
- Отображать процент товаров с назначенными COGS
- Кнопка "Перейти к управлению COGS" → `/products/cogs`
- Иконка в зависимости от уровня критичности
- Адаптивный дизайн (mobile/desktop)

**Файлы:**
- Создать: `src/components/custom/CogsMissingState.tsx`
- Создать: `src/components/custom/__tests__/CogsMissingState.test.tsx`
- Обновить: `src/lib/routes.ts` (добавить константу `/products/cogs` если отсутствует)

**API Integration:**
- Использовать данные из `useDashboardMetricsWithPeriod` или `useProducts`
- Расчет процента: `(products_with_cogs / total_products) * 100`

**Acceptance Criteria:**
- [ ] Компонент отображает корректный уровень критичности
- [ ] Кнопка переходит на страницу управления COGS
- [ ] Сообщение информативно и соответствует уровню критичности
- [ ] Адаптивный дизайн работает корректно
- [ ] Unit tests покрывают все уровни критичности

---

### Задача 2: AdvertisingEmptyState компонент (P1)

**Приоритет:** Высокий (P1)
**Срок:** Неделя 1-2
**Зависимости:** Нет

**Описание:**
Создать компонент для отображения состояния отсутствия advertising данных за выбранный период с указанием доступного диапазона.

**Спецификация:**

**Состояния:**
1. **Нет данных за период**
   - Сообщение: "Нет данных о рекламе за выбранный период"
   - Подсказка: "Доступны данные за период с {available_start} по {available_end}"

2. **Predefined ranges**
   - Quick select кнопки: 7, 14, 30 дней
   - При клике → запрос данных за выбранный диапазон

3. **Доступный диапазон**
   - Формат: "ДД.ММ.ГГГГ"
   - Вычисляется на основе доступных данных от бэкенда

**Функциональность:**
- Отображать сообщение об отсутствии данных
- Показывать доступный диапазон данных
- Quick select кнопки для predefined ranges
- Интеграция с `DashboardPeriodSelector` для обновления периода

**Файлы:**
- Создать: `src/components/custom/AdvertisingEmptyState.tsx`
- Создать: `src/components/custom/__tests__/AdvertisingEmptyState.test.tsx`
- Обновить: `src/lib/date-utils.ts` (добавить форматирование available range)

**API Integration:**
- Использовать `useAdvertisingDashboardWidget` или `useAdvertising`
- Извлекать `available_start` и `available_end` из ответа бэкенда

**Acceptance Criteria:**
- [ ] Компонент показывает корректное сообщение при отсутствии данных
- [ ] Доступный диапазон отображается в формате ДД.ММ.ГГГГ
- [ ] Quick select кнопки обновляют период данных
- [ ] Адаптивный дизайн работает корректно
- [ ] Unit tests покрывают все сценарии

---

### Задача 3: Интеграция компонентов (P1)

**Приоритет:** Высокий (P1)
**Срок:** Неделя 2
**Зависимости:** Задача 1, Задача 2

**Описание:**
Интегрировать новые компоненты в существующие элементы UI для улучшения UX.

**Файлы для изменения:**

1. **MetricCardEnhanced**
   - Путь: `src/components/custom/MetricCardEnhanced.tsx`
   - Изменения:
     - Проверять `cogs_total === null` или `margin_pct === null`
     - Показывать `CogsMissingState` вместо "—"
     - Добавить проп `showCogsWarning?: boolean`

2. **AdvertisingDashboardWidget**
   - Путь: `src/components/custom/AdvertisingDashboardWidget.tsx`
   - Изменения:
     - Проверять `spend === 0` или отсутствие данных
     - Показывать `AdvertisingEmptyState` вместо нулевых значений
     - Добавить логику для определения доступного диапазона

3. **Логика обновления Margin %**
   - Путь: `src/lib/margin-helpers.ts` (или создать новый)
   - Изменения:
     - Добавить функцию `shouldShowCogsWarning(metrics)`
     - Проверять `cogs_total === null` для показа warning
     - Учесть граничные случаи (частичные данные, периоды)

**Acceptance Criteria:**
- [ ] MetricCardEnhanced показывает CogsMissingState при отсутствии COGS
- [ ] AdvertisingDashboardWidget показывает AdvertisingEmptyState при отсутствии данных
- [ ] Логика корректно обрабатывает `null` и `0` значения
- [ ] UI обновляется без задержек
- [ ] Обновленные tests покрывают новые сценарии

---

## Критерии принятия

### Функциональные требования
- [ ] Все компоненты созданы и соответствуют спецификации
- [ ] Интеграция в существующие компоненты завершена
- [ ] Логика обработки null/0 значений реализована
- [ ] Переходы между экранами работают корректно

### Тестирование
- [ ] Unit tests написаны для всех новых компонентов
- [ ] Integration tests для обновленных компонентов
- [ ] Manual testing на реальных данных
- [ ] Accessibility testing (WCAG 2.1 AA)

### UX/UI
- [ ] Сообщения информативны и понятны пользователю
- [ ] Цветовая схема соответствует уровням критичности
- [ ] Адаптивный дизайн работает на всех устройствах
- [ ] Анимации и переходы плавные

### Документация
- [ ] Story документация обновлена
- [ ] API интеграция задокументирована
- [ ] Комментарии в коде добавлены

---

## Риски

### Риск 1: Несоответствие данных бэкенда
**Описание:** Бэкенд может изменить формат ответа или добавить новые поля
**Вероятность:** Средняя
**Влияние:** Высокое
**Митигация:**
- Использовать TypeScript strict typing
- Добавить validation схемы для ответов бэкенда
- Написать resilient код с fallback значениями

### Риск 2: Сложность определения уровня критичности
**Описание:** Логика определения Critical/Warning/Info может быть сложной
**Вероятность:** Низкая
**Влияние:** Среднее
**Митигация:**
- Создать утилитарные функции с четкой логикой
- Добавить unit tests для всех граничных случаев
- Использовать конфигурируемые пороги (config object)

### Риск 3: Проблемы с таймзонами и периодами
**Описание:** Advertising данные могут иметь разные таймзоны
**Вероятность:** Средняя
**Влияние:** Среднее
**Митигация:**
- Использовать `Europe/Moscow` таймзону consistently
- Добавить форматирование дат через `date-utils.ts`
- Тестировать на граничных периодах (конец/начало недели)

---

## Следующие шаги

### Неделя 1
1. Создать `CogsMissingState` компонент с unit tests
2. Создать `AdvertisingEmptyState` компонент с unit tests
3. Code review и merge feature branches

### Неделя 2
1. Интегрировать компоненты в `MetricCardEnhanced` и `AdvertisingDashboardWidget`
2. Обновить логику обработки margin % и advertising данных
3. Написать integration tests

### Неделя 3
1. Manual testing на реальных данных
2. Accessibility testing и исправления
3. Документация и final review

---

## Дополнительные улучшения (Future Enhancements)

### P2 - Неделя 3-4
- [ ] Добавить анимации для переходов между состояниями
- [ ] Создать tooltips для объяснения метрик
- [ ] Добавить export данных в CSV/Excel
- [ ] Создатьguided tour для новых пользователей

### P3 - Неделя 5+
- [ ] Добавить персонализированные рекомендации на основе patterns
- [ ] Создать dashboard templates для разных user personas
- [ ] Добавить machine learning predictions для margin trends

---

**Дата создания:** 2026-01-30
**Автор:** Claude Code (SuperClaude)
**Epic:** Epic 60 - FE Dashboard UX Improvements
**Статус:** Draft - Ready for Review
