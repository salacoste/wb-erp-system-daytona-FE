# Request #130: Документация формулы "Теоретическая прибыль"

**Дата**: 2026-02-01
**Статус**: Документация для CFO/Бизнес-владельцев
**Связанный Issue**: GitHub Issue #5

---

## Содержание

1. [Определение формулы](#1-определение-формулы)
2. [Источники данных API](#2-источники-данных-api)
3. [Что НЕ включено в расчёт](#3-что-не-включено-в-расчёт)
4. [Альтернативные метрики прибыли](#4-альтернативные-метрики-прибыли)
5. [Бизнес-интерпретация](#5-бизнес-интерпретация)
6. [Пример расчёта](#6-пример-расчёта)
7. [Рекомендации по использованию](#7-рекомендации-по-использованию)

---

## 1. Определение формулы

### 1.1 Базовая формула

```
Теоретическая прибыль = Выкупы - COGS - Рекламные затраты - Логистика - Хранение
```

### 1.2 Расшифровка компонентов

| Компонент | Описание | Что означает |
|-----------|----------|--------------|
| **Выкупы** | Выручка продавца после комиссии WB | Фактические деньги от продаж (не розничная цена для покупателя) |
| **COGS** | Cost of Goods Sold (Себестоимость) | Закупочная стоимость проданных товаров |
| **Рекламные затраты** | Расходы на продвижение | Затраты на рекламные кампании WB |
| **Логистика** | Стоимость доставки и возвратов | Расходы на логистику WB (доставка + возвраты) |
| **Хранение** | Затраты на хранение | Стоимость хранения товаров на складах WB |

### 1.3 Почему "Теоретическая"?

Название **"Теоретическая прибыль"** используется потому, что формула:

1. **Включает основные крупные расходы** - COGS, реклама, логистика, хранение
2. **НЕ включает мелкие операционные расходы** - см. раздел 3
3. **Представляет упрощённую модель** для быстрой оценки прибыльности

> **ВАЖНО**: Это НЕ чистая прибыль и НЕ операционная прибыль. Это упрощённый показатель для экспресс-анализа.

---

## 2. Источники данных API

### 2.1 TypeScript интерфейс

```typescript
interface TheoreticalProfitData {
  // Выручка (Выкупы)
  sales: number;           // wb_sales_gross_total из finance-summary

  // Себестоимость
  cogs: number;            // cogs_total из finance-summary

  // Рекламные расходы
  advertisingCost: number; // totalSpend из advertising API

  // Логистика (доставка + возвраты)
  logisticsCost: number;   // logistics_cost_total из finance-summary

  // Хранение
  storageCost: number;     // storage_cost_total из finance-summary

  // Результат
  theoreticalProfit: number; // Расчётное поле
}
```

### 2.2 Маппинг API эндпоинтов

| Компонент | API Endpoint | Поле в ответе | Тип запроса |
|-----------|--------------|---------------|-------------|
| **Выкупы** | `GET /v1/analytics/weekly/finance-summary?week=YYYY-Www` | `summary_total.wb_sales_gross_total` | По неделе |
| **COGS** | `GET /v1/analytics/weekly/finance-summary?week=YYYY-Www` | `summary_total.cogs_total` | По неделе |
| **Реклама** | `GET /v1/analytics/advertising?from=YYYY-MM-DD&to=YYYY-MM-DD` | `summary.totalSpend` | По диапазону дат |
| **Логистика** | `GET /v1/analytics/weekly/finance-summary?week=YYYY-Www` | `summary_total.logistics_cost_total` | По неделе |
| **Хранение** | `GET /v1/analytics/weekly/finance-summary?week=YYYY-Www` | `summary_total.storage_cost_total` | По неделе |

### 2.3 Пример запросов

```http
### 1. Финансовая сводка (выкупы, COGS, логистика, хранение)
GET /v1/analytics/weekly/finance-summary?week=2026-W04
Authorization: Bearer {{token}}
X-Cabinet-Id: {{cabinetId}}

### 2. Рекламные затраты
GET /v1/analytics/advertising?from=2026-01-20&to=2026-01-26
Authorization: Bearer {{token}}
X-Cabinet-Id: {{cabinetId}}
```

### 2.4 Функция расчёта

```typescript
function calculateTheoreticalProfit(data: TheoreticalProfitData): number {
  return data.sales
       - data.cogs
       - data.advertisingCost
       - data.logisticsCost
       - data.storageCost;
}
```

---

## 3. Что НЕ включено в расчёт

### 3.1 Комиссия WB

| Аспект | Объяснение |
|--------|------------|
| **Включена или нет?** | **УЖЕ ВЫЧТЕНА** из поля "Выкупы" |
| **Почему?** | Поле `wb_sales_gross` = выручка продавца ПОСЛЕ комиссии WB |
| **Розничная цена** | `sales_gross` (для покупателя) = wb_sales_gross + комиссия WB |

```
Пример:
- Покупатель заплатил: 197,083 ₽ (sales_gross)
- Комиссия WB: 65,949 ₽ (total_commission_rub)
- Выкупы (продавцу): 131,134 ₽ (wb_sales_gross) ← используется в формуле
```

### 3.2 Расходы, НЕ включённые в "Теоретическую прибыль"

| Категория | Поле API | Описание | Влияние |
|-----------|----------|----------|---------|
| **Эквайринг** | `acquiring_fee_rub` | Комиссия за платежи | ~1-2% от выручки |
| **Штрафы** | `penalties_rub` | Штрафы WB за нарушения | Переменная величина |
| **Платная приёмка** | `paid_acceptance_cost_rub` | Обработка товара на складе | Зависит от товара |
| **Программа лояльности** | `loyalty_fee_rub` | Начисленные баллы покупателям | ~0.5-1% от выручки |
| **Компенсация лояльности** | `loyalty_compensation_rub` | Возврат части баллов (уменьшает расходы) | Частичная компенсация |
| **Прочие комиссии** | `commission_rub` | Дополнительные комиссии WB | ~2-5% от выручки |
| **Прочие корректировки** | `other_adjustments_rub` | Корректировки, удержания | Нерегулярно |
| **Налоги** | - | НДС, налог на прибыль | Зависит от режима |

### 3.3 Типичная погрешность

```
Теоретическая прибыль ЗАВЫШАЕТ реальную прибыль примерно на:
- 3-8% для стандартных товаров
- 5-15% для товаров с высоким % возвратов
- 10-20% для товаров со штрафами
```

---

## 4. Альтернативные метрики прибыли

### 4.1 Сравнение метрик

| Метрика | Формула | Что включает | Когда использовать |
|---------|---------|--------------|-------------------|
| **Теоретическая прибыль** | Выкупы - COGS - Реклама - Логистика - Хранение | Основные расходы | Быстрый экспресс-анализ |
| **Gross Profit (Валовая)** | revenue_net - COGS | Только себестоимость | Анализ маржинальности товаров |
| **Operating Profit (Операционная)** | gross_profit - total_expenses | ВСЕ операционные расходы | Точный финансовый анализ |

### 4.2 Operating Profit - Полная формула

```
operating_profit_rub = gross_profit_rub - total_expenses_rub

где:
  gross_profit_rub = revenue_net_rub - cogs_rub

  total_expenses_rub = logistics_cost_rub
                     + storage_cost_rub
                     + paid_acceptance_cost_rub
                     + penalties_rub
                     + acquiring_fee_rub
                     + loyalty_fee_rub
                     + commission_rub
                     + |other_adjustments_rub|
                     - loyalty_compensation_rub
```

### 4.3 API источники для Operating Profit

```http
### Вариант 1: Cabinet Summary (агрегированные данные)
GET /v1/analytics/cabinet-summary?weeks=1
# Поля: summary.totals.operating_profit, summary.totals.operating_margin_pct

### Вариант 2: По SKU (детализация)
GET /v1/analytics/weekly/by-sku?week=2026-W04&includeCogs=true
# Поля: operating_profit_rub, operating_margin_pct, total_expenses_rub
```

### 4.4 Рекомендации по выбору метрики

| Сценарий | Рекомендуемая метрика | Почему |
|----------|----------------------|--------|
| **Быстрый обзор дашборда** | Теоретическая прибыль | Простота, наглядность |
| **Финансовый отчёт для CFO** | Operating Profit | Полнота учёта расходов |
| **Анализ маржинальности товара** | Gross Profit + Margin % | Фокус на себестоимости |
| **Сравнение товаров** | Operating Margin % | Нормализованный показатель |
| **Принятие решения о ценообразовании** | Operating Profit + все расходы | Нужна полная картина |

---

## 5. Бизнес-интерпретация

### 5.1 Что показывает "Теоретическая прибыль"

**Теоретическая прибыль** отвечает на вопрос:

> "Сколько примерно заработал бизнес, учитывая основные крупные расходы?"

### 5.2 Ограничения для принятия решений

| Решение | Подходит ли "Теор. прибыль"? | Рекомендация |
|---------|------------------------------|--------------|
| Общая оценка прибыльности недели | Да | Достаточно для экспресс-анализа |
| Сравнение товаров по прибыльности | Осторожно | Лучше использовать Operating Margin % |
| Расчёт ROI для инвестора | Нет | Использовать Operating Profit |
| Ценообразование | Нет | Использовать Price Calculator с полными расходами |
| Бюджетирование | Нет | Использовать Operating Profit + прогноз расходов |

### 5.3 Интерпретация значений

| Теор. прибыль | Интерпретация | Действие |
|---------------|---------------|----------|
| **> 20% от выкупов** | Отличная маржинальность | Масштабировать |
| **10-20% от выкупов** | Хорошая маржинальность | Поддерживать, оптимизировать |
| **5-10% от выкупов** | Средняя маржинальность | Искать пути оптимизации |
| **0-5% от выкупов** | Низкая маржинальность | Пересмотреть ценообразование/расходы |
| **< 0** | Убыточная деятельность | Срочный анализ причин |

---

## 6. Пример расчёта

### 6.1 Данные за W04 (20-26 января 2026)

| Компонент | Значение | Источник |
|-----------|----------|----------|
| Выкупы (wb_sales_gross_total) | 84,377.52 ₽ | finance-summary |
| COGS (cogs_total) | 35,818.00 ₽ | finance-summary |
| Реклама (totalSpend) | 3,728.55 ₽ | advertising |
| Логистика (logistics_cost_total) | 17,566.04 ₽ | finance-summary |
| Хранение (storage_cost_total) | 2,024.94 ₽ | finance-summary |

### 6.2 Расчёт

```
Теоретическая прибыль = 84,377.52 - 35,818.00 - 3,728.55 - 17,566.04 - 2,024.94
                      = 25,239.99 ₽
```

### 6.3 Проверка

```
Маржа теор. прибыли = 25,239.99 / 84,377.52 × 100% = 29.9%
```

### 6.4 Сравнение с Operating Profit

```
Operating Profit (из API) ≈ 22,000-24,000 ₽
Разница ≈ 1,200-3,200 ₽ (5-12%)

Причина разницы:
- Эквайринг: ~1,500 ₽
- Комиссии WB (доп.): ~500-1,000 ₽
- Прочие корректировки: ~200-500 ₽
```

---

## 7. Рекомендации по использованию

### 7.1 Для дашборда главной страницы

**Рекомендация**: Использовать "Теоретическую прибыль" с пояснением

```typescript
// UI компонент
<MetricCard
  title="Теор. прибыль"
  value={formatCurrency(theoreticalProfit)}
  tooltip="Упрощённый расчёт: Выкупы - COGS - Реклама - Логистика - Хранение.
           Не включает мелкие комиссии (~3-8% от суммы)."
/>
```

### 7.2 Для финансовых отчётов

**Рекомендация**: Использовать Operating Profit из API

```typescript
// Получение Operating Profit
const { data } = await fetch('/v1/analytics/cabinet-summary?weeks=1');
const operatingProfit = data.summary.totals.operating_profit;
const operatingMargin = data.summary.totals.operating_margin_pct;
```

### 7.3 Для сравнения периодов

**Рекомендация**: Использовать оба показателя

```typescript
interface PeriodComparison {
  period: string;
  theoreticalProfit: number;  // Для быстрого обзора
  operatingProfit: number;    // Для точного анализа
  margin: number;             // Для нормализованного сравнения
}
```

### 7.4 Рекомендуемый текст для пользователей

> **Теоретическая прибыль** - это упрощённый показатель прибыльности,
> который учитывает основные расходы (себестоимость, рекламу, логистику, хранение).
>
> Для точного финансового анализа используйте показатель **"Операционная прибыль"**,
> который включает все удержания WB (эквайринг, штрафы, комиссии, программу лояльности).
>
> Разница между показателями обычно составляет 3-8%.

---

## Связанные документы

| Документ | Содержание |
|----------|------------|
| [125-DASHBOARD-MAIN-PAGE-GUIDE.md](./125-DASHBOARD-MAIN-PAGE-GUIDE.md) | Сводное руководство по дашборду |
| [122-DASHBOARD-MAIN-PAGE-SALES-API.md](./122-DASHBOARD-MAIN-PAGE-SALES-API.md) | API для выкупов и продаж |
| [123-DASHBOARD-MAIN-PAGE-EXPENSES-API.md](./123-DASHBOARD-MAIN-PAGE-EXPENSES-API.md) | API для расходов |
| [63-operating-profit-formula-clarification.md](./63-operating-profit-formula-clarification.md) | Детали формулы Operating Profit |
| [BUSINESS-LOGIC-REFERENCE.md](../../docs/BUSINESS-LOGIC-REFERENCE.md) | Полный справочник бизнес-логики |

---

**Версия документа**: 1.0
**Дата создания**: 2026-02-01
**Автор**: Product Manager / Financial Analytics Team
