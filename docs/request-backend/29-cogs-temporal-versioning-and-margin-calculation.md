# Guide #29: COGS Temporal Versioning & Margin Calculation Logic

**Date**: 2025-11-28
**Type**: ğŸ“Š **TECHNICAL GUIDE**
**Component**: Backend API - COGS Module + Analytics Module
**Related**: Guide #24 (Margin Integration), Request #16 (COGS History), Epic 10/20

---

## Executive Summary

Ğ”Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚ Ğ¾Ğ¿Ğ¸ÑÑ‹Ğ²Ğ°ĞµÑ‚ **ĞºĞ°Ğº ÑĞ¸ÑÑ‚ĞµĞ¼Ğ° Ğ²Ñ‹Ğ±Ğ¸Ñ€Ğ°ĞµÑ‚ ÑĞµĞ±ĞµÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ (COGS) Ğ´Ğ»Ñ Ñ€Ğ°ÑÑ‡Ñ‘Ñ‚Ğ° Ğ¼Ğ°Ñ€Ğ¶Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸** Ñ ÑƒÑ‡Ñ‘Ñ‚Ğ¾Ğ¼ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ¾Ğ³Ğ¾ Ğ²ĞµÑ€ÑĞ¸Ğ¾Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ. ĞšĞ»ÑÑ‡ĞµĞ²Ğ¾Ğ¹ Ğ¼Ğ¾Ğ¼ĞµĞ½Ñ‚: ÑĞ¸ÑÑ‚ĞµĞ¼Ğ° Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ **ÑĞµÑ€ĞµĞ´Ğ¸Ğ½Ñƒ Ğ½ĞµĞ´ĞµĞ»Ğ¸ (midpoint â‰ˆ Ñ‡ĞµÑ‚Ğ²ĞµÑ€Ğ³)** Ğ´Ğ»Ñ Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ñ Ğ°ĞºÑ‚ÑƒĞ°Ğ»ÑŒĞ½Ğ¾Ğ¹ Ğ²ĞµÑ€ÑĞ¸Ğ¸ COGS.

---

## 1. ĞœĞ¾Ğ´ĞµĞ»ÑŒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… COGS

### 1.1 Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ‹ `cogs`

```sql
CREATE TABLE cogs (
  id            UUID PRIMARY KEY,
  nm_id         VARCHAR(50) NOT NULL,      -- ĞÑ€Ñ‚Ğ¸ĞºÑƒĞ» Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°
  sa_name       VARCHAR(255) NOT NULL,     -- ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°
  unit_cost_rub DECIMAL(15,2) NOT NULL,    -- Ğ¡ĞµĞ±ĞµÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ Ğ·Ğ° ĞµĞ´Ğ¸Ğ½Ğ¸Ñ†Ñƒ
  currency      VARCHAR(3) DEFAULT 'RUB',

  -- Ğ’Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ¾Ğµ Ğ²ĞµÑ€ÑĞ¸Ğ¾Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
  valid_from    TIMESTAMPTZ NOT NULL,      -- ĞĞ°Ñ‡Ğ°Ğ»Ğ¾ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ Ğ²ĞµÑ€ÑĞ¸Ğ¸
  valid_to      TIMESTAMPTZ NULL,          -- ĞšĞ¾Ğ½ĞµÑ† Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ (NULL = Ñ‚ĞµĞºÑƒÑ‰Ğ°Ñ)

  -- ĞÑƒĞ´Ğ¸Ñ‚
  source        VARCHAR(50) NOT NULL,      -- 'manual', 'import', 'system'
  created_by    VARCHAR(100) NOT NULL,
  created_at    TIMESTAMPTZ DEFAULT NOW(),
  updated_at    TIMESTAMPTZ DEFAULT NOW(),

  -- Soft delete (Story 5.3)
  is_active     BOOLEAN DEFAULT TRUE,
  deleted_at    TIMESTAMPTZ NULL,
  deleted_by    VARCHAR(100) NULL,

  -- Ğ£Ğ½Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¸Ğ½Ğ´ĞµĞºÑ: Ğ¾Ğ´Ğ½Ğ° Ğ²ĞµÑ€ÑĞ¸Ñ Ğ½Ğ° (nm_id, valid_from)
  UNIQUE(nm_id, valid_from)
);
```

### 1.2 ĞŸÑ€Ğ¸Ğ½Ñ†Ğ¸Ğ¿ Ğ²ĞµÑ€ÑĞ¸Ğ¾Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Ğ’ĞµÑ€ÑĞ¸Ğ¾Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ COGS                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  valid_to = NULL Ğ¾Ğ·Ğ½Ğ°Ñ‡Ğ°ĞµÑ‚ Ğ¢Ğ•ĞšĞ£Ğ©Ğ£Ğ® (Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½ÑƒÑ) Ğ²ĞµÑ€ÑĞ¸Ñ                         â”‚
â”‚                                                                              â”‚
â”‚  ĞŸÑ€Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğ¸ Ğ½Ğ¾Ğ²Ğ¾Ğ¹ Ğ²ĞµÑ€ÑĞ¸Ğ¸:                                                  â”‚
â”‚  1. Ğ¡Ñ‚Ğ°Ñ€Ğ°Ñ Ğ²ĞµÑ€ÑĞ¸Ñ Ğ·Ğ°ĞºÑ€Ñ‹Ğ²Ğ°ĞµÑ‚ÑÑ: valid_to = Ğ½Ğ¾Ğ²Ğ°Ñ.valid_from                  â”‚
â”‚  2. ĞĞ¾Ğ²Ğ°Ñ Ğ²ĞµÑ€ÑĞ¸Ñ ÑĞ¾Ğ·Ğ´Ğ°Ñ‘Ñ‚ÑÑ: valid_to = NULL                                 â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.3 ĞŸÑ€Ğ¸Ğ¼ĞµÑ€ Ğ²ĞµÑ€ÑĞ¸Ğ¹ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…

| nm_id | unit_cost_rub | valid_from | valid_to | is_active | ĞšĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸Ğ¹ |
|-------|---------------|------------|----------|-----------|-------------|
| 12345 | 100.00 | 2025-01-01 | 2025-03-01 | true | v1 (Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ°) |
| 12345 | 150.00 | 2025-03-01 | 2025-06-15 | true | v2 (Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ°) |
| 12345 | 180.00 | 2025-06-15 | NULL | true | v3 (Ñ‚ĞµĞºÑƒÑ‰Ğ°Ñ) |

**Ğ’Ğ°Ğ¶Ğ½Ğ¾**: Ğ’ÑĞµ Ğ²ĞµÑ€ÑĞ¸Ğ¸ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑÑÑ‚ÑÑ Ğ´Ğ»Ñ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¸. `is_active = false` Ğ¾Ğ·Ğ½Ğ°Ñ‡Ğ°ĞµÑ‚ ÑƒĞ´Ğ°Ğ»Ñ‘Ğ½Ğ½ÑƒÑ Ğ²ĞµÑ€ÑĞ¸Ñ (soft delete).

---

## 2. ĞĞ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼ Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ° COGS Ğ´Ğ»Ñ Ñ€Ğ°ÑÑ‡Ñ‘Ñ‚Ğ° Ğ¼Ğ°Ñ€Ğ¶Ğ¸

### 2.1 ĞšĞ»ÑÑ‡ĞµĞ²Ğ¾Ğ¹ Ğ¿Ñ€Ğ¸Ğ½Ñ†Ğ¸Ğ¿: Week Midpoint Strategy

```typescript
// margin-calculation.service.ts:244-249
private async lookupCogs(revenues: RevenueData[], start: Date, end: Date) {
  // Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ¡Ğ•Ğ Ğ•Ğ”Ğ˜ĞĞ£ Ğ½ĞµĞ´ĞµĞ»Ğ¸ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ¸ÑĞºĞ° COGS
  const midpoint = new Date((start.getTime() + end.getTime()) / 2);

  for (const revenue of revenues) {
    const cogs = await this.cogsService.findCogsAtDate(revenue.nmId, midpoint);
    // ...
  }
}
```

**Midpoint Ğ´Ğ»Ñ ISO-Ğ½ĞµĞ´ĞµĞ»Ğ¸ (ĞŸĞ½-Ğ’Ñ)**:
- ĞĞµĞ´ĞµĞ»Ñ: `Ğ¿Ğ¾Ğ½ĞµĞ´ĞµĞ»ÑŒĞ½Ğ¸Ğº 00:00:00` â†’ `Ğ²Ğ¾ÑĞºÑ€ĞµÑĞµĞ½ÑŒĞµ 23:59:59`
- Midpoint: `â‰ˆ Ñ‡ĞµÑ‚Ğ²ĞµÑ€Ğ³ 12:00:00` (ÑĞµÑ€ĞµĞ´Ğ¸Ğ½Ğ°)

### 2.2 SQL-Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ¿Ğ¾Ğ¸ÑĞºĞ° COGS

```typescript
// cogs.service.ts:231-248
async findCogsAtDate(nmId: string, validAt: Date): Promise<Cogs | null> {
  return this.prisma.cogs.findFirst({
    where: {
      nmId,
      isActive: true,                    // Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğµ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸
      validFrom: { lte: validAt },       // valid_from â‰¤ midpoint
      OR: [
        { validTo: null },               // Ğ¢ĞµĞºÑƒÑ‰Ğ°Ñ Ğ²ĞµÑ€ÑĞ¸Ñ
        { validTo: { gt: validAt } },    // Ğ˜Ğ»Ğ¸ Ğ²ĞµÑ€ÑĞ¸Ñ ĞµÑ‰Ñ‘ Ğ´ĞµĞ¹ÑÑ‚Ğ²ÑƒĞµÑ‚
      ],
    },
    orderBy: {
      validFrom: 'desc',                 // Ğ¡Ğ°Ğ¼Ğ°Ñ ÑĞ²ĞµĞ¶Ğ°Ñ Ğ²ĞµÑ€ÑĞ¸Ñ
    },
  });
}
```

### 2.3 Ğ’Ğ¸Ğ·ÑƒĞ°Ğ»ÑŒĞ½Ğ°Ñ ÑÑ…ĞµĞ¼Ğ° Ğ°Ğ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼Ğ°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ĞĞ›Ğ“ĞĞ Ğ˜Ğ¢Ğœ Ğ’Ğ«Ğ‘ĞĞ Ğ COGS Ğ”Ğ›Ğ¯ ĞĞ•Ğ”Ğ•Ğ›Ğ˜                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Ğ¨ĞĞ“ 1: Ğ’Ñ‹Ñ‡Ğ¸ÑĞ»Ğ¸Ñ‚ÑŒ midpoint Ğ½ĞµĞ´ĞµĞ»Ğ¸                                           â”‚
â”‚         midpoint = (monday_00:00 + sunday_23:59) / 2 â‰ˆ Ñ‡ĞµÑ‚Ğ²ĞµÑ€Ğ³ 12:00       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Ğ¨ĞĞ“ 2: ĞĞ°Ğ¹Ñ‚Ğ¸ COGS Ğ² Ğ±Ğ°Ğ·Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…                                            â”‚
â”‚         WHERE nm_id = ?                                                      â”‚
â”‚           AND is_active = true                                               â”‚
â”‚           AND valid_from <= midpoint                                         â”‚
â”‚           AND (valid_to > midpoint OR valid_to IS NULL)                     â”‚
â”‚         ORDER BY valid_from DESC                                             â”‚
â”‚         LIMIT 1                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Ğ¨ĞĞ“ 3: Ğ Ğ°ÑÑÑ‡Ğ¸Ñ‚Ğ°Ñ‚ÑŒ Ğ¼Ğ°Ñ€Ğ¶Ñƒ                                                    â”‚
â”‚         cogs_total = quantity_sold Ã— unit_cost_rub                          â”‚
â”‚         gross_profit = revenue_net - cogs_total                             â”‚
â”‚         margin_percent = (gross_profit / revenue_net) Ã— 100%                â”‚
â”‚         markup_percent = (gross_profit / cogs_total) Ã— 100%                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. Ğ¡Ñ†ĞµĞ½Ğ°Ñ€Ğ¸Ğ¸ Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ COGS

### 3.1 Ğ¡Ñ†ĞµĞ½Ğ°Ñ€Ğ¸Ğ¹ A: COGS Ğ½Ğµ Ğ¼ĞµĞ½ÑĞ»Ğ°ÑÑŒ Ğ¼Ğ½Ğ¾Ğ³Ğ¾ Ğ½ĞµĞ´ĞµĞ»ÑŒ

```
Ğ’Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ°Ñ ÑˆĞºĞ°Ğ»Ğ°:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
COGS: 100â‚½ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’
valid_from: 01.01.2025                                              valid_to: NULL

ĞĞµĞ´ĞµĞ»Ğ¸:     W40    W41    W42    W43    W44    W45    W46    W47
            â†“      â†“      â†“      â†“      â†“      â†“      â†“      â†“
COGS:      100â‚½   100â‚½   100â‚½   100â‚½   100â‚½   100â‚½   100â‚½   100â‚½
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

**Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚**: Ğ’ÑĞµ Ğ½ĞµĞ´ĞµĞ»Ğ¸ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒÑÑ‚ Ğ¾Ğ´Ğ½Ñƒ Ğ¸ Ñ‚Ñƒ Ğ¶Ğµ ÑĞµĞ±ĞµÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ 100â‚½.

---

### 3.2 Ğ¡Ñ†ĞµĞ½Ğ°Ñ€Ğ¸Ğ¹ B: COGS Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ğ»Ğ°ÑÑŒ Ğ¼ĞµĞ¶Ğ´Ñƒ Ğ½ĞµĞ´ĞµĞ»ÑĞ¼Ğ¸

```
Ğ’Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ°Ñ ÑˆĞºĞ°Ğ»Ğ°:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
COGS v1: 100â‚½ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
valid_from: 01.11, valid_to: 17.11     â”‚
                                        â†“
COGS v2: 150â‚½                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’
valid_from: 17.11.2025 (Ğ¿Ğ¾Ğ½ĞµĞ´ĞµĞ»ÑŒĞ½Ğ¸Ğº W47)                            valid_to: NULL

ĞĞµĞ´ĞµĞ»Ğ¸:  |â†â”€â”€â”€â”€â”€â”€ W46 â”€â”€â”€â”€â”€â”€â†’|â†â”€â”€â”€â”€â”€â”€ W47 â”€â”€â”€â”€â”€â”€â†’|â†â”€â”€â”€â”€â”€â”€ W48 â”€â”€â”€â”€â”€â”€â†’|
         ĞŸĞ½ 10    Ğ§Ñ‚ 13   Ğ’Ñ 16   ĞŸĞ½ 17  Ğ§Ñ‚ 20  Ğ’Ñ 23   ĞŸĞ½ 24    Ğ’Ñ 30
                   â†‘                      â†‘
              midpoint W46           midpoint W47
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

**Ğ Ğ°ÑÑ‡Ñ‘Ñ‚**:
- **W46** midpoint = 13.11 â†’ `valid_from(17.11) > midpoint` â†’ **COGS v1 (100â‚½)**
- **W47** midpoint = 20.11 â†’ `valid_from(17.11) â‰¤ midpoint` â†’ **COGS v2 (150â‚½)**
- **W48+** â†’ **COGS v2 (150â‚½)**

---

### 3.3 Ğ¡Ñ†ĞµĞ½Ğ°Ñ€Ğ¸Ğ¹ C: COGS Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ğ»Ğ°ÑÑŒ Ğ² ÑĞµÑ€ĞµĞ´Ğ¸Ğ½Ğµ Ğ½ĞµĞ´ĞµĞ»Ğ¸ (Ğ”Ğ Ñ‡ĞµÑ‚Ğ²ĞµÑ€Ğ³Ğ°)

```
COGS Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ° Ğ² ÑÑ€ĞµĞ´Ñƒ 19.11.2025 (Ğ²Ğ½ÑƒÑ‚Ñ€Ğ¸ Ğ½ĞµĞ´ĞµĞ»Ğ¸ W47)

ĞĞµĞ´ĞµĞ»Ñ W47:  ĞŸĞ½ 17   Ğ’Ñ‚ 18   Ğ¡Ñ€ 19   Ğ§Ñ‚ 20   ĞŸÑ‚ 21   Ğ¡Ğ± 22   Ğ’Ñ 23
                             â†‘       â†‘
                     valid_from   midpoint
                       (Ğ½Ğ¾Ğ²Ğ°Ñ)    (Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ°)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

**ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ°**: `valid_from(19.11) â‰¤ midpoint(20.11)` â†’ **TRUE**

**Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚**: **ĞĞĞ’ĞĞ¯ COGS Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ÑĞµÑ‚ÑÑ Ğº Ğ½ĞµĞ´ĞµĞ»Ğµ W47**

---

### 3.4 Ğ¡Ñ†ĞµĞ½Ğ°Ñ€Ğ¸Ğ¹ D: COGS Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ğ»Ğ°ÑÑŒ Ğ² ÑĞµÑ€ĞµĞ´Ğ¸Ğ½Ğµ Ğ½ĞµĞ´ĞµĞ»Ğ¸ (ĞŸĞĞ¡Ğ›Ğ• Ñ‡ĞµÑ‚Ğ²ĞµÑ€Ğ³Ğ°)

```
COGS Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ° Ğ² Ğ¿ÑÑ‚Ğ½Ğ¸Ñ†Ñƒ 21.11.2025 (Ğ²Ğ½ÑƒÑ‚Ñ€Ğ¸ Ğ½ĞµĞ´ĞµĞ»Ğ¸ W47)

ĞĞµĞ´ĞµĞ»Ñ W47:  ĞŸĞ½ 17   Ğ’Ñ‚ 18   Ğ¡Ñ€ 19   Ğ§Ñ‚ 20   ĞŸÑ‚ 21   Ğ¡Ğ± 22   Ğ’Ñ 23
                                     â†‘       â†‘
                                 midpoint  valid_from
                                (Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ°)  (Ğ½Ğ¾Ğ²Ğ°Ñ)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

**ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ°**: `valid_from(21.11) â‰¤ midpoint(20.11)` â†’ **FALSE**

**Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚**:
- **W47** Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ **Ğ¡Ğ¢ĞĞ Ğ£Ğ® COGS**
- **W48+** Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ **ĞĞĞ’Ğ£Ğ® COGS**

---

### 3.5 Ğ¡Ğ²Ğ¾Ğ´Ğ½Ğ°Ñ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° ÑÑ†ĞµĞ½Ğ°Ñ€Ğ¸ĞµĞ²

| ĞšĞ¾Ğ³Ğ´Ğ° Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ° COGS | valid_from | ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµÑ‚ÑÑ Ñ Ğ½ĞµĞ´ĞµĞ»Ğ¸ |
|---------------------|------------|----------------------|
| Ğ’ Ğ¿Ğ¾Ğ½ĞµĞ´ĞµĞ»ÑŒĞ½Ğ¸Ğº W47 | 17.11 (ĞŸĞ½) | **W47** âœ“ |
| Ğ’Ğ¾ Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¸Ğº W47 | 18.11 (Ğ’Ñ‚) | **W47** âœ“ |
| Ğ’ ÑÑ€ĞµĞ´Ñƒ W47 | 19.11 (Ğ¡Ñ€) | **W47** âœ“ |
| Ğ’ Ñ‡ĞµÑ‚Ğ²ĞµÑ€Ğ³ W47 Ğ´Ğ¾ 12:00 | 20.11 (Ğ§Ñ‚) | **W47** âœ“ |
| Ğ’ Ñ‡ĞµÑ‚Ğ²ĞµÑ€Ğ³ W47 Ğ¿Ğ¾ÑĞ»Ğµ 12:00 | 20.11 (Ğ§Ñ‚) | **W48** (Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ñ‚ Ğ¾Ñ‚ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸) |
| Ğ’ Ğ¿ÑÑ‚Ğ½Ğ¸Ñ†Ñƒ W47 | 21.11 (ĞŸÑ‚) | **W48** |
| Ğ’ ÑÑƒĞ±Ğ±Ğ¾Ñ‚Ñƒ W47 | 22.11 (Ğ¡Ğ±) | **W48** |
| Ğ’ Ğ²Ğ¾ÑĞºÑ€ĞµÑĞµĞ½ÑŒĞµ W47 | 23.11 (Ğ’Ñ) | **W48** |

---

## 4. ĞŸÑ€Ğ¸Ğ¼ĞµÑ€ Ñ Ñ€ĞµĞ°Ğ»ÑŒĞ½Ñ‹Ğ¼Ğ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸

### 4.1 Ğ˜ÑÑ…Ğ¾Ğ´Ğ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ

**Ğ¢Ğ¾Ğ²Ğ°Ñ€**: nm_id = `147205694`

**Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ COGS**:
```
v1: 500â‚½ (valid_from: 01.10.2025, valid_to: 15.11.2025)
v2: 650â‚½ (valid_from: 15.11.2025, valid_to: NULL) â† Ñ‚ĞµĞºÑƒÑ‰Ğ°Ñ
```

**ĞŸÑ€Ğ¾Ğ´Ğ°Ğ¶Ğ¸**:
| ĞĞµĞ´ĞµĞ»Ñ | ĞŸĞµÑ€Ğ¸Ğ¾Ğ´ | ĞšĞ¾Ğ»-Ğ²Ğ¾ | Ğ’Ñ‹Ñ€ÑƒÑ‡ĞºĞ° |
|--------|--------|--------|---------|
| W45 | 03-09.11 | 10 ÑˆÑ‚ | 8,000â‚½ |
| W46 | 10-16.11 | 15 ÑˆÑ‚ | 12,000â‚½ |
| W47 | 17-23.11 | 8 ÑˆÑ‚ | 6,400â‚½ |

### 4.2 Ğ Ğ°ÑÑ‡Ñ‘Ñ‚ Ğ¼Ğ°Ñ€Ğ¶Ğ¸ Ğ¿Ğ¾ Ğ½ĞµĞ´ĞµĞ»ÑĞ¼

**ĞĞµĞ´ĞµĞ»Ñ W45** (03-09.11.2025):
```
midpoint = 06.11.2025 (Ñ‡ĞµÑ‚Ğ²ĞµÑ€Ğ³)
valid_from(01.10) â‰¤ 06.11 â†’ COGS v1 = 500â‚½

cogs_total = 10 Ã— 500 = 5,000â‚½
gross_profit = 8,000 - 5,000 = 3,000â‚½
margin_percent = 3,000 / 8,000 Ã— 100% = 37.50%
```

**ĞĞµĞ´ĞµĞ»Ñ W46** (10-16.11.2025):
```
midpoint = 13.11.2025 (Ñ‡ĞµÑ‚Ğ²ĞµÑ€Ğ³)
valid_from(01.10) â‰¤ 13.11, valid_to(15.11) > 13.11 â†’ COGS v1 = 500â‚½

cogs_total = 15 Ã— 500 = 7,500â‚½
gross_profit = 12,000 - 7,500 = 4,500â‚½
margin_percent = 4,500 / 12,000 Ã— 100% = 37.50%
```

**ĞĞµĞ´ĞµĞ»Ñ W47** (17-23.11.2025):
```
midpoint = 20.11.2025 (Ñ‡ĞµÑ‚Ğ²ĞµÑ€Ğ³)
valid_from(15.11) â‰¤ 20.11, valid_to = NULL â†’ COGS v2 = 650â‚½ â† ĞĞĞ’ĞĞ¯!

cogs_total = 8 Ã— 650 = 5,200â‚½
gross_profit = 6,400 - 5,200 = 1,200â‚½
margin_percent = 1,200 / 6,400 Ã— 100% = 18.75%
```

### 4.3 Ğ˜Ñ‚Ğ¾Ğ³Ğ¾Ğ²Ğ°Ñ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ°

| ĞĞµĞ´ĞµĞ»Ñ | Midpoint | COGS Ğ²ĞµÑ€ÑĞ¸Ñ | Ğ¡ĞµĞ±ĞµÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ | ĞœĞ°Ñ€Ğ¶Ğ° |
|--------|----------|-------------|---------------|-------|
| W45 | 06.11 | v1 | 500â‚½ | **37.50%** |
| W46 | 13.11 | v1 | 500â‚½ | **37.50%** |
| W47 | 20.11 | v2 | 650â‚½ | **18.75%** |

---

## 5. ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ Ğ¿ĞµÑ€ĞµÑÑ‡Ñ‘Ñ‚ Ğ¼Ğ°Ñ€Ğ¶Ğ¸

### 5.1 ĞšĞ¾Ğ³Ğ´Ğ° Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµÑ‚ÑÑ Ğ¿ĞµÑ€ĞµÑÑ‡Ñ‘Ñ‚

Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ° Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ¿ĞµÑ€ĞµÑÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ¼Ğ°Ñ€Ğ¶Ñƒ Ğ¿Ñ€Ğ¸:

| Ğ¡Ğ¾Ğ±Ñ‹Ñ‚Ğ¸Ğµ | Ğ¢Ñ€Ğ¸Ğ³Ğ³ĞµÑ€ | Ğ—Ğ°Ñ‚Ñ€Ğ¾Ğ½ÑƒÑ‚Ñ‹Ğµ Ğ½ĞµĞ´ĞµĞ»Ğ¸ |
|---------|---------|-------------------|
| **ĞĞ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ COGS** | `POST /v1/products/:nmId/cogs` | ĞÑ‚ `valid_from` Ğ´Ğ¾ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½ĞµĞ¹ Ğ·Ğ°Ğ²ĞµÑ€ÑˆÑ‘Ğ½Ğ½Ğ¾Ğ¹ Ğ½ĞµĞ´ĞµĞ»Ğ¸ |
| **Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ COGS** | `PATCH /v1/cogs/:cogsId` | ĞÑ‚ `valid_from` Ğ´Ğ¾ `valid_to` (Ğ¸Ğ»Ğ¸ Ğ´Ğ¾ ÑĞµĞ¹Ñ‡Ğ°Ñ) |
| **Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ COGS** | `DELETE /v1/cogs/:cogsId` | ĞÑ‚ `valid_from` Ğ´Ğ¾ `valid_to` (Ğ¸Ğ»Ğ¸ Ğ´Ğ¾ ÑĞµĞ¹Ñ‡Ğ°Ñ) |
| **Bulk Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°** | `POST /v1/products/cogs/bulk` | ĞĞ³Ñ€ĞµĞ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ¿ĞµÑ€ĞµÑÑ‡Ñ‘Ñ‚ Ğ´Ğ»Ñ Ğ²ÑĞµÑ… Ğ·Ğ°Ñ‚Ñ€Ğ¾Ğ½ÑƒÑ‚Ñ‹Ñ… Ğ½ĞµĞ´ĞµĞ»ÑŒ |

### 5.2 ĞĞ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼ Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ñ Ğ·Ğ°Ñ‚Ñ€Ğ¾Ğ½ÑƒÑ‚Ñ‹Ñ… Ğ½ĞµĞ´ĞµĞ»ÑŒ

```typescript
// affected-weeks.helper.ts
function calculateAffectedWeeks(validFrom: Date): string[] {
  // 1. ĞĞ¿Ñ€ĞµĞ´ĞµĞ»Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½ÑÑ Ğ—ĞĞ’Ğ•Ğ Ğ¨ĞĞĞĞ£Ğ® Ğ½ĞµĞ´ĞµĞ»Ñ (Epic 19)
  const lastCompletedWeek = isoWeekService.getLastCompletedWeek(true);

  // 2. Ğ•ÑĞ»Ğ¸ valid_from > lastCompletedWeek â†’ Ğ¿ÑƒÑÑ‚Ğ¾Ğ¹ Ğ¼Ğ°ÑÑĞ¸Ğ²
  if (validFrom > lastCompletedWeek.end) {
    return [];
  }

  // 3. Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ½ĞµĞ´ĞµĞ»Ğ¸ Ğ¾Ñ‚ valid_from Ğ´Ğ¾ lastCompletedWeek
  const weeks: string[] = [];
  let current = validFrom;

  while (current <= lastCompletedWeek.end) {
    weeks.push(dateToIsoWeek(current));
    current.setDate(current.getDate() + 7);
  }

  return weeks;
}
```

### 5.3 Ğ’Ñ€ĞµĞ¼Ñ Ğ¿ĞµÑ€ĞµÑÑ‡Ñ‘Ñ‚Ğ°

| ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ¾Ğ² | ĞŸÑ€Ğ¸Ğ¼ĞµÑ€Ğ½Ğ¾Ğµ Ğ²Ñ€ĞµĞ¼Ñ |
|-------------------|-----------------|
| 1 Ñ‚Ğ¾Ğ²Ğ°Ñ€ | 5-30 ÑĞµĞºÑƒĞ½Ğ´ |
| 10 Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ¾Ğ² | 15-45 ÑĞµĞºÑƒĞ½Ğ´ |
| 100 Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ¾Ğ² | 45-90 ÑĞµĞºÑƒĞ½Ğ´ |
| 500 Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ¾Ğ² (bulk) | 45-60 ÑĞµĞºÑƒĞ½Ğ´ (batch) |

---

## 6. Frontend: Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ğ¸Ğ¸ Ğ¿Ğ¾ UX

### 6.1 ĞÑ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğµ Ğ²ĞµÑ€ÑĞ¸Ğ¹ COGS

```tsx
// ĞŸÑ€Ğ¸Ğ¼ĞµÑ€ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ğ° Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¸ COGS
function CogsHistoryTimeline({ history }: { history: CogsHistoryItem[] }) {
  return (
    <div className="timeline">
      {history.map((version, index) => (
        <div key={version.cogs_id} className="timeline-item">
          <div className="version-badge">
            {version.valid_to === null ? 'âœ“ Ğ¢ĞµĞºÑƒÑ‰Ğ°Ñ' : `v${history.length - index}`}
          </div>
          <div className="cost">{version.unit_cost_rub}â‚½</div>
          <div className="period">
            {formatDate(version.valid_from)} â€”
            {version.valid_to ? formatDate(version.valid_to) : 'ÑĞµĞ¹Ñ‡Ğ°Ñ'}
          </div>
          {version.affected_weeks.length > 0 && (
            <div className="affected">
              Ğ—Ğ°Ñ‚Ñ€Ğ¾Ğ½ÑƒÑ‚Ğ¾ Ğ½ĞµĞ´ĞµĞ»ÑŒ: {version.affected_weeks.length}
            </div>
          )}
        </div>
      ))}
    </div>
  );
}
```

### 6.2 ĞŸĞ¾Ğ´ÑĞºĞ°Ğ·ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ½Ğ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğ¸ COGS

```tsx
function CogsAssignmentForm() {
  const [validFrom, setValidFrom] = useState(new Date());

  // ĞĞ¿Ñ€ĞµĞ´ĞµĞ»Ğ¸Ñ‚ÑŒ, Ñ ĞºĞ°ĞºĞ¾Ğ¹ Ğ½ĞµĞ´ĞµĞ»Ğ¸ Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½Ğ¸Ñ‚ÑÑ COGS
  const effectiveWeek = useMemo(() => {
    const midpoint = getWeekMidpoint(validFrom);
    if (validFrom <= midpoint) {
      return getCurrentWeek(validFrom);
    } else {
      return getNextWeek(validFrom);
    }
  }, [validFrom]);

  return (
    <form>
      <DatePicker value={validFrom} onChange={setValidFrom} />

      <Alert variant="info">
        <AlertCircle className="h-4 w-4" />
        <span>
          Ğ¡ĞµĞ±ĞµÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½Ğ¸Ñ‚ÑÑ <strong>Ñ Ğ½ĞµĞ´ĞµĞ»Ğ¸ {effectiveWeek}</strong>
          {validFrom.getDay() >= 5 && (
            <span className="text-muted">
              {' '}(Ğ´Ğ°Ñ‚Ğ° Ğ¿Ğ¾ÑĞ»Ğµ Ñ‡ĞµÑ‚Ğ²ĞµÑ€Ğ³Ğ° â€” Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½Ğ¸Ñ‚ÑÑ ÑĞ¾ ÑĞ»ĞµĞ´ÑƒÑÑ‰ĞµĞ¹ Ğ½ĞµĞ´ĞµĞ»Ğ¸)
            </span>
          )}
        </span>
      </Alert>

      <Button type="submit">ĞĞ°Ğ·Ğ½Ğ°Ñ‡Ğ¸Ñ‚ÑŒ</Button>
    </form>
  );
}
```

### 6.3 ĞŸÑ€ĞµĞ´ÑƒĞ¿Ñ€ĞµĞ¶Ğ´ĞµĞ½Ğ¸Ğµ Ğ¾ Ğ·Ğ°Ğ´ĞµÑ€Ğ¶ĞºĞµ Ğ¿ĞµÑ€ĞµÑÑ‡Ñ‘Ñ‚Ğ°

```tsx
// ĞŸĞ¾ÑĞ»Ğµ Ğ½Ğ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ COGS
function MarginRecalculationNotice({ taskUuid, affectedWeeks }: Props) {
  return (
    <Alert>
      <Loader2 className="h-4 w-4 animate-spin" />
      <div>
        <p>ĞœĞ°Ñ€Ğ¶Ğ° Ğ¿ĞµÑ€ĞµÑÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ÑÑ Ğ´Ğ»Ñ {affectedWeeks.length} Ğ½ĞµĞ´ĞµĞ»ÑŒ...</p>
        <p className="text-muted text-sm">
          ĞĞ±Ñ‹Ñ‡Ğ½Ğ¾ Ğ·Ğ°Ğ½Ğ¸Ğ¼Ğ°ĞµÑ‚ 5-30 ÑĞµĞºÑƒĞ½Ğ´. ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚Ğµ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñƒ Ñ‡ĞµÑ€ĞµĞ· Ğ¼Ğ¸Ğ½ÑƒÑ‚Ñƒ.
        </p>
      </div>
    </Alert>
  );
}
```

---

## 7. Edge Cases Ğ¸ FAQ

### 7.1 Ğ§Ñ‚Ğ¾ ĞµÑĞ»Ğ¸ COGS Ğ½Ğµ Ğ½Ğ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ°?

- `missing_data_reason: "COGS_NOT_ASSIGNED"`
- `margin_pct: null`
- `cogs: null`

### 7.2 Ğ§Ñ‚Ğ¾ ĞµÑĞ»Ğ¸ Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ COGS Ğ·Ğ°Ğ´Ğ½Ğ¸Ğ¼ Ñ‡Ğ¸ÑĞ»Ğ¾Ğ¼?

Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ° Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ¿ĞµÑ€ĞµÑÑ‡Ğ¸Ñ‚Ğ°ĞµÑ‚ Ğ¼Ğ°Ñ€Ğ¶Ñƒ Ğ´Ğ»Ñ Ğ²ÑĞµÑ… Ğ·Ğ°Ñ‚Ñ€Ğ¾Ğ½ÑƒÑ‚Ñ‹Ñ… Ğ½ĞµĞ´ĞµĞ»ÑŒ Ğ¾Ñ‚ `valid_from` Ğ´Ğ¾ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½ĞµĞ¹ Ğ·Ğ°Ğ²ĞµÑ€ÑˆÑ‘Ğ½Ğ½Ğ¾Ğ¹ Ğ½ĞµĞ´ĞµĞ»Ğ¸.

### 7.3 Ğ§Ñ‚Ğ¾ ĞµÑĞ»Ğ¸ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ñ‚ĞµĞºÑƒÑ‰ÑƒÑ Ğ²ĞµÑ€ÑĞ¸Ñ COGS?

- ĞŸÑ€ĞµĞ´Ñ‹Ğ´ÑƒÑ‰Ğ°Ñ Ğ²ĞµÑ€ÑĞ¸Ñ ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑÑ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ¹ (`valid_to = NULL`)
- ĞœĞ°Ñ€Ğ¶Ğ° Ğ¿ĞµÑ€ĞµÑÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ÑÑ Ñ ÑƒÑ‡Ñ‘Ñ‚Ğ¾Ğ¼ Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ğ¾Ğ¹ Ğ²ĞµÑ€ÑĞ¸Ğ¸
- Ğ•ÑĞ»Ğ¸ Ğ¿Ñ€ĞµĞ´Ñ‹Ğ´ÑƒÑ‰ĞµĞ¹ Ğ²ĞµÑ€ÑĞ¸Ğ¸ Ğ½ĞµÑ‚ â†’ Ñ‚Ğ¾Ğ²Ğ°Ñ€ Ğ¾ÑÑ‚Ğ°Ñ‘Ñ‚ÑÑ Ğ±ĞµĞ· COGS

### 7.4 ĞœĞ¾Ğ¶Ğ½Ğ¾ Ğ»Ğ¸ Ğ½Ğ°Ğ·Ğ½Ğ°Ñ‡Ğ¸Ñ‚ÑŒ COGS Ğ½Ğ° Ğ±ÑƒĞ´ÑƒÑ‰ĞµĞµ?

Ğ”Ğ°, Ğ½Ğ¾ Ğ¼Ğ°Ñ€Ğ¶Ğ° Ğ±ÑƒĞ´ĞµÑ‚ Ñ€Ğ°ÑÑÑ‡Ğ¸Ñ‚Ğ°Ğ½Ğ° Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ĞºĞ¾Ğ³Ğ´Ğ°:
1. ĞĞ°ÑÑ‚ÑƒĞ¿Ğ¸Ñ‚ ÑÑ‚Ğ° Ğ´Ğ°Ñ‚Ğ°
2. ĞĞµĞ´ĞµĞ»Ñ ÑÑ‚Ğ°Ğ½ĞµÑ‚ "Ğ·Ğ°Ğ²ĞµÑ€ÑˆÑ‘Ğ½Ğ½Ğ¾Ğ¹" (Epic 19)
3. Ğ‘ÑƒĞ´ÑƒÑ‚ Ğ¿Ñ€Ğ¾Ğ´Ğ°Ğ¶Ğ¸ Ğ² ÑÑ‚Ñƒ Ğ½ĞµĞ´ĞµĞ»Ñ

### 7.5 ĞŸĞ¾Ñ‡ĞµĞ¼Ñƒ Ğ¼Ğ°Ñ€Ğ¶Ğ° Ğ¾Ğ´Ğ¸Ğ½Ğ°ĞºĞ¾Ğ²Ğ°Ñ Ğ´Ğ»Ñ W45 Ğ¸ W46, Ğ½Ğ¾ Ñ€Ğ°Ğ·Ğ½Ğ°Ñ Ğ´Ğ»Ñ W47?

ĞŸĞ¾Ñ‚Ğ¾Ğ¼Ñƒ Ñ‡Ñ‚Ğ¾ COGS Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ğ»Ğ°ÑÑŒ 15.11 (ÑÑƒĞ±Ğ±Ğ¾Ñ‚Ğ° W46). Midpoint W46 = 13.11, Ğ° `valid_from(15.11) > 13.11`, Ğ¿Ğ¾ÑÑ‚Ğ¾Ğ¼Ñƒ W46 Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ ÑÑ‚Ğ°Ñ€ÑƒÑ COGS. Midpoint W47 = 20.11, Ğ° `valid_from(15.11) â‰¤ 20.11`, Ğ¿Ğ¾ÑÑ‚Ğ¾Ğ¼Ñƒ W47 Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ Ğ½Ğ¾Ğ²ÑƒÑ COGS.

---

## 8. API Reference

### 8.1 ĞĞ°Ğ·Ğ½Ğ°Ñ‡Ğ¸Ñ‚ÑŒ COGS

```http
POST /v1/products/:nmId/cogs
Authorization: Bearer <token>
X-Cabinet-Id: <cabinet-uuid>
Content-Type: application/json

{
  "unit_cost_rub": 650.00,
  "valid_from": "2025-11-15T00:00:00Z",  // Ğ¡ ĞºĞ°ĞºĞ¾Ğ¹ Ğ´Ğ°Ñ‚Ñ‹ Ğ´ĞµĞ¹ÑÑ‚Ğ²ÑƒĞµÑ‚
  "source": "manual",
  "notes": "ĞĞ¾Ğ²Ğ°Ñ Ğ¿Ğ°Ñ€Ñ‚Ğ¸Ñ Ğ¾Ñ‚ Ğ¿Ğ¾ÑÑ‚Ğ°Ğ²Ñ‰Ğ¸ĞºĞ°"
}
```

### 8.2 ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ COGS

```http
GET /v1/cogs/history?nm_id=147205694&limit=50
Authorization: Bearer <token>
X-Cabinet-Id: <cabinet-uuid>
```

**Response**:
```json
{
  "data": [
    {
      "cogs_id": "uuid-v2",
      "unit_cost_rub": "650.00",
      "valid_from": "2025-11-15T00:00:00.000Z",
      "valid_to": null,
      "is_active": true,
      "affected_weeks": ["2025-W47"]
    },
    {
      "cogs_id": "uuid-v1",
      "unit_cost_rub": "500.00",
      "valid_from": "2025-10-01T00:00:00.000Z",
      "valid_to": "2025-11-15T00:00:00.000Z",
      "is_active": true,
      "affected_weeks": ["2025-W40", "W41", "W42", "W43", "W44", "W45", "W46"]
    }
  ],
  "meta": {
    "nm_id": "147205694",
    "current_cogs": {
      "unit_cost_rub": "650.00",
      "valid_from": "2025-11-15T00:00:00.000Z"
    },
    "total_versions": 2
  }
}
```

### 8.3 Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ COGS (Story 5.2)

```http
PATCH /v1/cogs/:cogsId
Authorization: Bearer <token>
X-Cabinet-Id: <cabinet-uuid>
Content-Type: application/json

{
  "unit_cost_rub": 680.00,  // Ğ˜ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ½Ğ°Ñ ÑÑƒĞ¼Ğ¼Ğ°
  "notes": "ĞšĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²ĞºĞ° Ğ¿Ğ¾ÑĞ»Ğµ ÑĞ²ĞµÑ€ĞºĞ¸ Ñ Ğ½Ğ°ĞºĞ»Ğ°Ğ´Ğ½Ğ¾Ğ¹"
}
```

---

## 9. Ğ¡Ğ²ÑĞ·Ğ°Ğ½Ğ½Ğ°Ñ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ñ

- **Guide #24**: [Margin & COGS Integration Guide](./24-margin-cogs-integration-guide.md) â€” Ğ¿Ğ¾Ğ»Ğ½Ğ¾Ğµ Ñ€ÑƒĞºĞ¾Ğ²Ğ¾Ğ´ÑÑ‚Ğ²Ğ¾ Ğ¿Ğ¾ Ğ¸Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ğ¸
- **Request #16**: [COGS History Data Structure](./16-cogs-history-and-margin-data-structure.md) â€” ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
- **Story 5.1**: [View COGS History](../../../docs/stories/epic-5/story-5.1-view-cogs-history.md)
- **Story 5.2**: [Edit COGS](../../../docs/stories/epic-5/story-5.2-edit-cogs.md)
- **Story 5.3**: [Delete COGS](../../../docs/stories/epic-5/story-5.3-delete-cogs.md)
- **Epic 10**: [Story 10.4 - Margin & Profit Calculation](../../../docs/stories/epic-10/story-10.4-margin-profit-calculation.md)
- **Epic 19**: [Completed Weeks Only](../../../docs/stories/epic-19/EPIC-19-OVERVIEW.md)
- **Epic 20**: [Automatic Margin Recalculation](../../../docs/stories/epic-20/EPIC-20-OVERVIEW.md)

---

## 10. Summary: ĞšĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ Ğ²Ñ‹Ğ²Ğ¾Ğ´Ñ‹

| ĞÑĞ¿ĞµĞºÑ‚ | ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ |
|--------|----------|
| **Ğ¡Ñ‚Ñ€Ğ°Ñ‚ĞµĞ³Ğ¸Ñ Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ° COGS** | Week Midpoint (â‰ˆ Ñ‡ĞµÑ‚Ğ²ĞµÑ€Ğ³ 12:00) |
| **Ğ’ĞµÑ€ÑĞ¸Ğ¾Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ** | `valid_from` / `valid_to` Ñ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸ĞµĞ¼ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¸ |
| **Ğ¢ĞµĞºÑƒÑ‰Ğ°Ñ Ğ²ĞµÑ€ÑĞ¸Ñ** | `valid_to = NULL` |
| **ĞĞ²Ñ‚Ğ¾Ğ¿ĞµÑ€ĞµÑÑ‡Ñ‘Ñ‚ Ğ¼Ğ°Ñ€Ğ¶Ğ¸** | ĞŸÑ€Ğ¸ Ğ»ÑĞ±Ğ¾Ğ¼ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¸ COGS |
| **Ğ“Ñ€Ğ°Ğ½Ğ¸Ñ‡Ğ½Ñ‹Ğ¹ ÑĞ»ÑƒÑ‡Ğ°Ğ¹** | ĞŸÑ‚-Ğ’Ñ â†’ COGS Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½Ğ¸Ñ‚ÑÑ ÑĞ¾ ÑĞ»ĞµĞ´ÑƒÑÑ‰ĞµĞ¹ Ğ½ĞµĞ´ĞµĞ»Ğ¸ |

---

**Created**: 2025-11-28
**Author**: Claude Code
**Status**: âœ… Active Guide
