# Request #22: W47 Margin Calculation - Manual Trigger Required

**–î–∞—Ç–∞:** 2025-11-25
**–°—Ç–∞—Ç—É—Å:** ‚úÖ RESOLVED
**–¢–∏–ø:** Backend Response / Explanation
**–°–≤—è–∑–∞–Ω–æ —Å:** Request #17 (COGS assigned after completed week)

---

## üìã –ü—Ä–æ–±–ª–µ–º–∞

Frontend —Å–æ–æ–±—â–∏–ª —á—Ç–æ –¥–ª—è —Ç–æ–≤–∞—Ä–æ–≤ —Å –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω–æ–π COGS –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –º–∞—Ä–∂–∞:
- –¢–æ–≤–∞—Ä 412096139 (COGS —Å 02.11) ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç "(—Ä–∞—Å—á—ë—Ç –º–∞—Ä–∂–∏...)"
- –¢–æ–≤–∞—Ä 321678606 (COGS —Å 24.11) ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç "(COGS —Å –±—É–¥—É—â–µ–π –¥–∞—Ç—ã)"

---

## üîç Root Cause Analysis

### –•—Ä–æ–Ω–æ–ª–æ–≥–∏—è —Å–æ–±—ã—Ç–∏–π:

| –í—Ä–µ–º—è | –°–æ–±—ã—Ç–∏–µ | Last Completed Week |
|-------|---------|---------------------|
| –ü–Ω 24.11 –∏–ª–∏ —Ä–∞–Ω—å—à–µ | COGS –Ω–∞–∑–Ω–∞—á–µ–Ω | W46 (10-16 –Ω–æ—è–±—Ä—è) |
| –í—Ç 25.11 –¥–æ 12:00 | –°–∏—Å—Ç–µ–º–∞ –∂–¥—ë—Ç –¥–∞–Ω–Ω—ã–µ WB | W46 |
| **–í—Ç 25.11 –ø–æ—Å–ª–µ 12:00** | **W47 —Å—Ç–∞–ª–∞ "–∑–∞–≤–µ—Ä—à—ë–Ω–Ω–æ–π"** | **W47 (17-23 –Ω–æ—è–±—Ä—è)** |

### –ü–æ—á–µ–º—É –º–∞—Ä–∂–∞ –Ω–µ —Ä–∞—Å—Å—á–∏—Ç–∞–ª–∞—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:

1. **COGS –±—ã–ª –Ω–∞–∑–Ω–∞—á–µ–Ω –≤ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ 24.11** (–∏–ª–∏ —Ä–∞–Ω—å—à–µ)
2. –í —Ç–æ—Ç –º–æ–º–µ–Ω—Ç `getLastCompletedWeek()` –≤–æ–∑–≤—Ä–∞—â–∞–ª **W46** (Epic 19 –ª–æ–≥–∏–∫–∞):
   - –ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ ‚Üí week-2 (2 –Ω–µ–¥–µ–ª–∏ –Ω–∞–∑–∞–¥)
   - –í—Ç–æ—Ä–Ω–∏–∫ –¥–æ 12:00 ‚Üí week-2
3. –î–∞—Ç—ã COGS (23.11 –∏ 24.11) –±—ã–ª–∏ **–ø–æ—Å–ª–µ –∫–æ–Ω—Ü–∞ W46** (16.11)
4. `calculateAffectedWeeks()` –≤–µ—Ä–Ω—É–ª **–ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤** ‚Üí –ø–µ—Ä–µ—Å—á—ë—Ç –ù–ï –∑–∞–ø—É—â–µ–Ω
5. –í–æ –≤—Ç–æ—Ä–Ω–∏–∫ –ø–æ—Å–ª–µ 12:00 W47 —Å—Ç–∞–ª–∞ "–∑–∞–≤–µ—Ä—à—ë–Ω–Ω–æ–π"
6. **–ù–û —Å–∏—Å—Ç–µ–º–∞ –Ω–µ –∑–Ω–∞–µ—Ç —á—Ç–æ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –º–∞—Ä–∂—É –¥–ª—è W47**

### –≠—Ç–æ –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ Epic 20

–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç –º–∞—Ä–∂—É —Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–µ–¥–µ–ª—å, –∫–æ—Ç–æ—Ä—ã–µ **—É–∂–µ –±—ã–ª–∏ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–º–∏** –≤ –º–æ–º–µ–Ω—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è COGS. –ö–æ–≥–¥–∞ –Ω–æ–≤–∞—è –Ω–µ–¥–µ–ª—è —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è "–∑–∞–≤–µ—Ä—à—ë–Ω–Ω–æ–π", –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ trigger –Ω–µ—Ç.

---

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ —Ä–∞—Å—á—ë—Ç–∞ –º–∞—Ä–∂–∏ –¥–ª—è W47:

```bash
POST /v1/tasks/enqueue
X-Cabinet-Id: f75836f7-c0bc-4b2c-823c-a1f3508cce8e
Content-Type: application/json

{
  "task_type": "weekly_margin_calculation",
  "payload": {
    "weeks": ["2025-W47"]
  },
  "priority": 1
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ó–∞–¥–∞—á–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –∑–∞ 236ms, –º–∞—Ä–∂–∞ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–∞ –¥–ª—è 17 —Ç–æ–≤–∞—Ä–æ–≤.

---

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞—Å—á—ë—Ç–∞ W47

### –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:
- **–í—Å–µ–≥–æ —Ç–æ–≤–∞—Ä–æ–≤ —Å –ø—Ä–æ–¥–∞–∂–∞–º–∏:** 17
- **–¢–æ–≤–∞—Ä–æ–≤ —Å COGS:** 6
- **–¢–æ–≤–∞—Ä–æ–≤ –±–µ–∑ COGS:** 11 (margin = 100%, —Ç.–∫. COGS = 0)

### –¢–æ–≤–∞—Ä—ã —Å COGS –∏ –º–∞—Ä–∂–æ–π:

| nmId | –ú–∞—Ä–∂–∞ | –í—ã—Ä—É—á–∫–∞ | COGS | –ù–∞–∑–≤–∞–Ω–∏–µ |
|------|-------|---------|------|----------|
| 147205694 | 91.9% | 20,137‚ÇΩ | 1,628‚ÇΩ | ll-20-bl |
| 235269056 | 68.3% | 4,990‚ÇΩ | 1,584‚ÇΩ | izo30white |
| **412096139** | **66.4%** | 11,429‚ÇΩ | 3,842‚ÇΩ | **izoblack_30** |
| 254936041 | 63.6% | 14,632‚ÇΩ | 5,328‚ÇΩ | m62-1 |
| 148191269 | 51.9% | 1,855‚ÇΩ | 893‚ÇΩ | m62-2 |
| **321678606** | **-52.3%** | 36,622‚ÇΩ | 55,770‚ÇΩ | ‚ùå –£–±—ã—Ç–æ–∫ |

---

## üî¨ –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Ç–æ–≤–∞—Ä–∞ 321678606

### –ò—Å—Ç–æ—Ä–∏—è –≤–µ—Ä—Å–∏–π COGS:

| validFrom | unitCostRub | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|-----------|-------------|-------------|
| 01.10.2025 | 444‚ÇΩ | - |
| 10.10.2025 | 224‚ÇΩ | - |
| 01.11.2025 | 988‚ÇΩ | - |
| 11.11.2025 | 991‚ÇΩ | - |
| 14.11.2025 | 990‚ÇΩ | - |
| **20.11.2025** | **995.89‚ÇΩ** | **‚Üê –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –¥–ª—è W47** |
| 23.11.2025 | 994‚ÇΩ | - |
| 24.11.2025 | 990‚ÇΩ | - |

### –ü–æ—á–µ–º—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω COGS –æ—Ç 20.11 (995.89‚ÇΩ)?

**Week Midpoint Strategy** (–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ –≤ CLAUDE.md):

```
W47: Mon 17.11 - Sun 23.11
Midpoint = (17.11 + 23.11) / 2 ‚âà Thursday 20.11.2025
```

`findCogsAtDate('321678606', '2025-11-20')` –Ω–∞—à—ë–ª COGS —Å `validFrom=2025-11-20`:
- `20.11 ‚â§ 20.11` ‚úì ‚Üí COGS –≤–∞–ª–∏–¥–µ–Ω –Ω–∞ –¥–∞—Ç—É midpoint
- –≠—Ç–æ **—Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ** —Å midpoint!

### –†–∞—Å—á—ë—Ç –º–∞—Ä–∂–∏:

```
Revenue:     36,621.85‚ÇΩ
COGS:        55,769.84‚ÇΩ (56 —à—Ç √ó 995.89‚ÇΩ)
Gross Profit: -19,147.99‚ÇΩ (–£–ë–´–¢–û–ö)
Margin:      -52.3%
```

**‚ö†Ô∏è –¢–æ–≤–∞—Ä –ø—Ä–æ–¥–∞—ë—Ç—Å—è –≤ —É–±—ã—Ç–æ–∫!** –°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å (995.89‚ÇΩ) –≤—ã—à–µ —Ü–µ–Ω—ã –ø—Ä–æ–¥–∞–∂–∏.

---

## üìù –í–∞–∂–Ω—ã–µ –≤—ã–≤–æ–¥—ã

### 1. Midpoint Strategy —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

–°–∏—Å—Ç–µ–º–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∞ COGS –æ—Ç 20.11 (995.89‚ÇΩ), –∞ **–Ω–µ** –æ—Ç 24.11 (990‚ÇΩ), –ø–æ—Ç–æ–º—É —á—Ç–æ:
- W47 midpoint = 20.11 (—á–µ—Ç–≤–µ—Ä–≥)
- COGS —Å validFrom=24.11 > midpoint ‚Üí –Ω–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫ W47
- COGS —Å validFrom=20.11 ‚â§ midpoint ‚Üí –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫ W47

### 2. –¢–æ–≤–∞—Ä 321678606 –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–∞–∑–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã

| COGS –¥–∞—Ç–∞ | vs W47 end (23.11) | –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ |
|-----------|-------------------|-------------|
| validFrom=24.11 | 24 > 23 | "(COGS —Å –±—É–¥—É—â–µ–π –¥–∞—Ç—ã)" |
| validFrom=20.11 | 20 ‚â§ 23 | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ |

Frontend –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç "(COGS —Å –±—É–¥—É—â–µ–π –¥–∞—Ç—ã)" –ø–æ—Ç–æ–º—É —á—Ç–æ **–ø–æ—Å–ª–µ–¥–Ω—è—è** –≤–µ—Ä—Å–∏—è COGS (validFrom=24.11) –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –ø–æ—Å–ª–µ W47. –ù–æ –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ –º–∞—Ä–∂–∏ —Å–∏—Å—Ç–µ–º–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **–∞–∫—Ç—É–∞–ª—å–Ω—É—é –Ω–∞ midpoint** –≤–µ—Ä—Å–∏—é.

### 3. –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ Epic 20

–ö–æ–≥–¥–∞ COGS –Ω–∞–∑–Ω–∞—á–∞–µ—Ç—Å—è –≤ –º–æ–º–µ–Ω—Ç –∫–æ–≥–¥–∞ —Ü–µ–ª–µ–≤–∞—è –Ω–µ–¥–µ–ª—è –µ—â—ë –Ω–µ "–∑–∞–≤–µ—Ä—à–µ–Ω–∞" –ø–æ Epic 19 –ª–æ–≥–∏–∫–µ, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Å—á—ë—Ç –Ω–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç. –≠—Ç–æ **by design** - —Å–º. Request #17.

---

## üîß –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –î–ª—è Frontend:

1. **–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É** ‚Äî –¥–∞–Ω–Ω—ã–µ –º–∞—Ä–∂–∏ W47 —Ç–µ–ø–µ—Ä—å –¥–æ—Å—Ç—É–ø–Ω—ã —á–µ—Ä–µ–∑ API
2. –ü—Ä–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–∏ "(—Ä–∞—Å—á—ë—Ç –º–∞—Ä–∂–∏...)" –¥–ª—è —Ç–æ–≤–∞—Ä–æ–≤ —Å COGS:
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å `calculatedAt` –≤ `weekly_margin_fact`
   - –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç ‚Üí –≤–æ–∑–º–æ–∂–Ω–æ –Ω—É–∂–µ–Ω —Ä—É—á–Ω–æ–π trigger

### –î–ª—è –±—É–¥—É—â–µ–≥–æ (Epic 23?):

–†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π cron job –∫–æ—Ç–æ—Ä—ã–π:
1. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–æ–≥–¥–∞ –Ω–æ–≤–∞—è –Ω–µ–¥–µ–ª—è —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è "–∑–∞–≤–µ—Ä—à—ë–Ω–Ω–æ–π"
2. –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç –º–∞—Ä–∂—É –¥–ª—è —Ç–æ–≤–∞—Ä–æ–≤ —Å COGS, –∑–∞—Ç—Ä–∞–≥–∏–≤–∞—é—â–∏—Ö —ç—Ç—É –Ω–µ–¥–µ–ª—é

---

## üìö –°–≤—è–∑–∞–Ω–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- **CLAUDE.md**: –†–∞–∑–¥–µ–ª "COGS Temporal Lookup - Week Midpoint Strategy"
- **docs/HOW-COGS-MARGIN-SHOULD-WORK.md**: –†–∞–∑–¥–µ–ª "üìÖ COGS Temporal Lookup"
- **docs/PRODUCTS-API-GUIDE.md**: –†–∞–∑–¥–µ–ª "Temporal Lookup - Week Midpoint Strategy"
- **Request #17**: `17-cogs-assigned-after-completed-week-recalculation.md`
- **Epic 19**: Completed weeks logic
- **Epic 20**: Automatic margin recalculation

---

## üîó API Reference

### –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ —Ä–∞—Å—á—ë—Ç–∞ –º–∞—Ä–∂–∏:

```http
POST /v1/tasks/enqueue
X-Cabinet-Id: {cabinet_id}
Content-Type: application/json

{
  "task_type": "weekly_margin_calculation",
  "payload": {
    "weeks": ["2025-W47"]  // –º–æ–∂–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ: ["2025-W46", "2025-W47"]
  },
  "priority": 1
}
```

**Response (201 Created):**
```json
{
  "task_uuid": "c7cc485d...",
  "status": "pending",
  "task_type": "weekly_margin_calculation"
}
```

**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** ~200-500ms –¥–ª—è –æ–¥–Ω–æ–π –Ω–µ–¥–µ–ª–∏.

---

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2025-11-25
**–ê–≤—Ç–æ—Ä:** Backend Team
**–°—Ç–∞—Ç—É—Å:** ‚úÖ RESOLVED
