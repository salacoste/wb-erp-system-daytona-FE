# Guide #30: SKU Analytics Data Architecture & UNKNOWN nm_id Handling

**Date**: 2025-11-28
**Type**: ðŸ“Š **TECHNICAL GUIDE**
**Component**: Backend Analytics + Frontend Display

---

## Executive Summary

Ð”Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ Ð°Ñ€Ñ…Ð¸Ñ‚ÐµÐºÑ‚ÑƒÑ€Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð´Ð»Ñ SKU-Ð°Ð½Ð°Ð»Ð¸Ñ‚Ð¸ÐºÐ¸, Ð²ÐºÐ»ÑŽÑ‡Ð°Ñ:
- ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÑƒ ÑÑ‚Ñ€Ð¾Ðº Ð±ÐµÐ· Ð°Ñ€Ñ‚Ð¸ÐºÑƒÐ»Ð° (nm_id = 'UNKNOWN')
- Ð¤Ð¾Ñ€Ð¼ÑƒÐ»Ñƒ Ð¼Ð°Ñ€Ð¶Ð¸ Ð¿Ð¾ SKU Ð¸ ÐµÑ‘ Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ñ
- Ð¡Ñ…ÐµÐ¼Ñƒ Ñ€Ð°ÑÐ¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð¸Ñ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¸Ð· WB Excel

---

## SKU Margin Formula

### Ð¤Ð¾Ñ€Ð¼ÑƒÐ»Ð° Ñ€Ð°ÑÑ‡Ñ‘Ñ‚Ð°

```
ÐœÐ°Ñ€Ð¶Ð° Ð¿Ð¾ SKU = (Ð’Ñ‹Ñ€ÑƒÑ‡ÐºÐ° - Ð¡ÐµÐ±ÐµÑÑ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚ÑŒ) / Ð’Ñ‹Ñ€ÑƒÑ‡ÐºÐ° Ã— 100%
```

### Ð’Ð°Ð¶Ð½Ð¾Ðµ Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ðµ

âš ï¸ **ÐœÐ°Ñ€Ð¶Ð° Ð¿Ð¾ SKU ÐÐ• Ð²ÐºÐ»ÑŽÑ‡Ð°ÐµÑ‚ Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¾Ð½Ð½Ñ‹Ðµ Ñ€Ð°ÑÑ…Ð¾Ð´Ñ‹:**
- Ð›Ð¾Ð³Ð¸ÑÑ‚Ð¸ÐºÐ° (Ð´Ð¾ÑÑ‚Ð°Ð²ÐºÐ°, Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‚)
- Ð¥Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ Ð½Ð° ÑÐºÐ»Ð°Ð´Ðµ WB
- Ð¨Ñ‚Ñ€Ð°Ñ„Ñ‹ Ð¸ ÑƒÐ´ÐµÑ€Ð¶Ð°Ð½Ð¸Ñ
- ÐŸÐ»Ð°Ñ‚Ð½Ð°Ñ Ð¿Ñ€Ð¸Ñ‘Ð¼ÐºÐ°

**ÐžÐ¿ÐµÑ€Ð°Ñ†Ð¸Ð¾Ð½Ð½Ñ‹Ðµ Ñ€Ð°ÑÑ…Ð¾Ð´Ñ‹ Ð²Ñ‹Ñ‡Ð¸Ñ‚Ð°ÑŽÑ‚ÑÑ Ð½Ð° ÑƒÑ€Ð¾Ð²Ð½Ðµ Ð½ÐµÐ´ÐµÐ»ÑŒÐ½Ð¾Ð³Ð¾ `payout_total`**, Ð° Ð½Ðµ Ð½Ð° ÑƒÑ€Ð¾Ð²Ð½Ðµ Ð¾Ñ‚Ð´ÐµÐ»ÑŒÐ½Ñ‹Ñ… Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð².

### UI Recommendation

ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°Ñ‚ÑŒ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŽ Ð¿Ð¾ÑÑÐ½ÐµÐ½Ð¸Ðµ Ð² Info Banner:

```
Ð¤Ð¾Ñ€Ð¼ÑƒÐ»Ð° Ñ€Ð°ÑÑ‡Ñ‘Ñ‚Ð°: ÐœÐ°Ñ€Ð¶Ð° % = (Ð’Ñ‹Ñ€ÑƒÑ‡ÐºÐ° - Ð¡ÐµÐ±ÐµÑÑ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚ÑŒ) / Ð’Ñ‹Ñ€ÑƒÑ‡ÐºÐ° Ã— 100%
âš ï¸ ÐÐµ Ð²ÐºÐ»ÑŽÑ‡Ð°ÐµÑ‚ Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¾Ð½Ð½Ñ‹Ðµ Ñ€Ð°ÑÑ…Ð¾Ð´Ñ‹ (Ð»Ð¾Ð³Ð¸ÑÑ‚Ð¸ÐºÐ°, Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ, ÑˆÑ‚Ñ€Ð°Ñ„Ñ‹) â€”
   Ð¾Ð½Ð¸ Ð²Ñ‹Ñ‡Ð¸Ñ‚Ð°ÑŽÑ‚ÑÑ Ð½Ð° ÑƒÑ€Ð¾Ð²Ð½Ðµ Ð½ÐµÐ´ÐµÐ»ÑŒÐ½Ð¾Ð¹ ÑÐ²Ð¾Ð´ÐºÐ¸ payout_total
```

---

## Data Flow: WB Excel â†’ Analytics

### Ð¡Ñ…ÐµÐ¼Ð° Ñ€Ð°ÑÐ¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð¸Ñ Ð´Ð°Ð½Ð½Ñ‹Ñ…

```
                        WB Excel Report
                             â”‚
             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             â–¼               â–¼               â–¼
      qty=1 (Product)   qty=0 (Service)  qty=2 (Transport)
      nm_id = Ð°Ñ€Ñ‚Ð¸ÐºÑƒÐ»   nm_id = UNKNOWN  nm_id = UNKNOWN
             â”‚               â”‚               â”‚
             â–¼               â–¼               â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ SKU Analyticsâ”‚  â”‚ Excluded     â”‚  â”‚ Informationalâ”‚
      â”‚ âœ… Ð²ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¾  â”‚  â”‚ from SKU     â”‚  â”‚ KPI only     â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚               â”‚               â”‚
             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â–¼
                    weekly_payout_summary
                   (Ð²ÑÐµ ÑÑ‚Ñ€Ð¾ÐºÐ¸ Ð²ÐºÐ»ÑŽÑ‡ÐµÐ½Ñ‹)
```

### ÐšÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¸ ÑÑ‚Ñ€Ð¾Ðº

| qty | nm_id | Ð¢Ð¸Ð¿ Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¸ | SKU Analytics | Payout Total |
|-----|-------|--------------|---------------|--------------|
| 1 | Ð°Ñ€Ñ‚Ð¸ÐºÑƒÐ» | ÐŸÑ€Ð¾Ð´Ð°Ð¶Ð°/Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‚ Ñ‚Ð¾Ð²Ð°Ñ€Ð° | âœ… Ð’ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¾ | âœ… Ð’ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¾ |
| 0 | UNKNOWN | Ð¡ÐµÑ€Ð²Ð¸ÑÐ½Ñ‹Ðµ ÑƒÑÐ»ÑƒÐ³Ð¸ | âŒ Ð˜ÑÐºÐ»ÑŽÑ‡ÐµÐ½Ð¾ | âœ… Ð’ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¾ |
| 2 | UNKNOWN | Ð’Ð¾Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ðµ Ð¿ÐµÑ€ÐµÐ²Ð¾Ð·ÐºÐ¸ | âŒ Ð˜ÑÐºÐ»ÑŽÑ‡ÐµÐ½Ð¾ | âœ… (ÐºÐ°Ðº KPI) |

---

## UNKNOWN nm_id: Ð§Ñ‚Ð¾ ÑÑ‚Ð¾?

### Ð˜ÑÑ‚Ð¾Ñ‡Ð½Ð¸Ðº

Ð¡Ñ‚Ñ€Ð¾ÐºÐ¸ Ð±ÐµÐ· Ð°Ñ€Ñ‚Ð¸ÐºÑƒÐ»Ð° Ð¿Ð¾ÑÐ²Ð»ÑÑŽÑ‚ÑÑ Ð¿Ñ€Ð¸ Ð¸Ð¼Ð¿Ð¾Ñ€Ñ‚Ðµ WB Excel Ñ„Ð°Ð¹Ð»Ð¾Ð². ÐŸÐ°Ñ€ÑÐµÑ€ (`row-classifier.service.ts`) ÑƒÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÑ‚ `nm_id = 'UNKNOWN'` ÐºÐ¾Ð³Ð´Ð°:

```typescript
const nmId = this.extractField(row, 'nm_id', columnMapping) || 'UNKNOWN';
```

### Ð¢Ð¸Ð¿Ñ‹ ÑÐµÑ€Ð²Ð¸ÑÐ½Ñ‹Ñ… Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¹ (UNKNOWN)

| Ð¢Ð¸Ð¿ Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¸ | ÐŸÑ€Ð¸Ð¼ÐµÑ€Ð½Ð¾Ðµ ÐºÐ¾Ð»-Ð²Ð¾ | Ð¤Ð¸Ð½Ð°Ð½ÑÐ¾Ð²Ð¾Ðµ Ð²Ð»Ð¸ÑÐ½Ð¸Ðµ |
|--------------|------------------|-------------------|
| Ð’Ð¾Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ðµ Ð¸Ð·Ð´ÐµÑ€Ð¶ÐµÐº Ð¿Ð¾ Ð¿ÐµÑ€ÐµÐ²Ð¾Ð·ÐºÐµ | ~13,500 | +46,725â‚½ Ðº Ð²Ñ‹Ð¿Ð»Ð°Ñ‚Ðµ |
| Ð’Ð¾Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ðµ Ð·Ð° Ð²Ñ‹Ð´Ð°Ñ‡Ñƒ/Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‚ Ð½Ð° ÐŸÐ’Ð— | ~6,300 | Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¾Ð½Ð½Ñ‹Ð¹ KPI |
| Ð¥Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ (Ð¾Ð±Ñ‰ÐµÐµ Ð¿Ð¾ ÑÐºÐ»Ð°Ð´Ñƒ) | ~100 | -45,487â‚½ ÑƒÐ´ÐµÑ€Ð¶Ð°Ð½Ð¸Ðµ |
| Ð£Ð´ÐµÑ€Ð¶Ð°Ð½Ð¸Ñ | ~30 | ÐŸÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ð°Ñ ÑÑƒÐ¼Ð¼Ð° |
| Ð¨Ñ‚Ñ€Ð°Ñ„Ñ‹ (Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¸Ð²Ð½Ñ‹Ðµ) | ~2 | -10,000â‚½ ÑƒÐ´ÐµÑ€Ð¶Ð°Ð½Ð¸Ðµ |

### Ð’Ð°Ð¶Ð½Ð¾

- **net_for_pay = 0** Ð´Ð»Ñ Ð²ÑÐµÑ… UNKNOWN ÑÑ‚Ñ€Ð¾Ðº
- **gross = 0** Ð´Ð»Ñ Ð²ÑÐµÑ… UNKNOWN ÑÑ‚Ñ€Ð¾Ðº
- Ð¤Ð¸Ð½Ð°Ð½ÑÐ¾Ð²Ñ‹Ðµ ÑÑƒÐ¼Ð¼Ñ‹ Ð½Ð°Ñ…Ð¾Ð´ÑÑ‚ÑÑ Ð² ÑÐ¿ÐµÑ†Ð¸Ñ„Ð¸Ñ‡Ð½Ñ‹Ñ… ÐºÐ¾Ð»Ð¾Ð½ÐºÐ°Ñ… (transport_reimbursement, storage, penalties)

---

## Backend Filter Implementation

### SQL Filter Ð² by-sku endpoint

```sql
SELECT ...
FROM wb_finance_raw
WHERE cabinet_id = ${cabinetId}::uuid
  AND sale_dt >= ${dateFrom}
  AND sale_dt <= ${dateTo}
  AND nm_id != 'UNKNOWN'  -- Exclude service rows without product ID
GROUP BY nm_id, sa_name
```

### Ð“Ð´Ðµ Ñ€ÐµÐ°Ð»Ð¸Ð·Ð¾Ð²Ð°Ð½Ð¾

- **File**: `src/analytics/weekly-analytics.service.ts`
- **Method**: `getWeeklyBySkuData()`

---

## missing_cogs_flag Fix (2025-11-28)

### ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼Ð°

Ð¢Ð¾Ð²Ð°Ñ€Ñ‹ Ñ Ð¿Ñ€Ð¾Ð´Ð°Ð¶Ð°Ð¼Ð¸, Ð½Ð¾ Ð±ÐµÐ· Ð½Ð°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð½Ð¾Ð³Ð¾ COGS Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°Ð»Ð¸:
- Ð¡ÐµÐ±ÐµÑÑ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚ÑŒ: 0,00â‚½ (Ð²Ð¼ÐµÑÑ‚Ð¾ "ÐÐµ Ð½Ð°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð°")
- ÐœÐ°Ñ€Ð¶Ð°: 100% (Ð½ÐµÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾)

### ÐšÐ¾Ñ€Ð½ÐµÐ²Ð°Ñ Ð¿Ñ€Ð¸Ñ‡Ð¸Ð½Ð°

Ð’ `margin-calculation.service.ts` Ð¿Ñ€Ð¸ Ñ€Ð°ÑÑ‡Ñ‘Ñ‚Ðµ Ð¼Ð°Ñ€Ð¶Ð¸:
- `cogsUnitCostRub = null` ÐºÐ¾Ð³Ð´Ð° COGS Ð½Ðµ Ð½Ð°Ð·Ð½Ð°Ñ‡ÐµÐ½ âœ…
- `cogsRub = Decimal(0)` ÐºÐ¾Ð³Ð´Ð° COGS Ð½Ðµ Ð½Ð°Ð·Ð½Ð°Ñ‡ÐµÐ½ âŒ (NOT NULL!)

```typescript
// margin-calculation.service.ts:105-110
const cogs = cogsBySku.get(nmId) || {
  nmId,
  unitCostRub: null,        // â† NULL ÐºÐ¾Ð³Ð´Ð° Ð½ÐµÑ‚ COGS
  cogsRub: new Decimal(0),  // â† Decimal(0), NOT NULL!
  missingCogsUnits: revenue.quantitySold,
};
```

### Ð˜ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ

ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÑ‚ÑŒ `cogsUnitCostRub` (ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ Ñ€ÐµÐ°Ð»ÑŒÐ½Ð¾ NULL) Ð²Ð¼ÐµÑÑ‚Ð¾ `cogsRub`:

```typescript
// weekly-analytics.service.ts:438
// ÐÐ•ÐŸÐ ÐÐ’Ð˜Ð›Ð¬ÐÐž: cogsRub Ð²ÑÐµÐ³Ð´Ð° 0 Ð¸Ð»Ð¸ Ð±Ð¾Ð»ÑŒÑˆÐµ (Ð½Ðµ NULL)
const hasCogs = margin.cogsRub !== null; // âŒ Ð²ÑÐµÐ³Ð´Ð° true!

// ÐŸÐ ÐÐ’Ð˜Ð›Ð¬ÐÐž: cogsUnitCostRub Ñ€ÐµÐ°Ð»ÑŒÐ½Ð¾ NULL ÐºÐ¾Ð³Ð´Ð° COGS Ð½Ðµ Ð½Ð°Ð·Ð½Ð°Ñ‡ÐµÐ½
const hasCogs = margin.cogsUnitCostRub !== null; // âœ…
```

### Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° Ð¿Ð¾ÑÐ»Ðµ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ (W46)

```
Total products: 17
NULL cogs_unit_cost_rub (COGS NOT assigned): 10 â†’ missing_cogs_flag=true
HAS cogs_unit_cost_rub (COGS IS assigned): 7 â†’ missing_cogs_flag=false
```

### Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð° Ð¿Ð¾Ð²ÐµÐ´ÐµÐ½Ð¸Ñ

| Ð¡Ð¸Ñ‚ÑƒÐ°Ñ†Ð¸Ñ | cogs_unit_cost_rub | missing_cogs_flag | UI Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÑ‚ |
|----------|-------------------|-------------------|---------------|
| COGS Ð½Ð°Ð·Ð½Ð°Ñ‡ÐµÐ½ (> 0â‚½) | Ñ‡Ð¸ÑÐ»Ð¾ | `false` | Ð—Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ COGS |
| COGS Ð½Ð°Ð·Ð½Ð°Ñ‡ÐµÐ½ (= 0â‚½) | 0 | `false` | 0,00â‚½ |
| COGS Ð½Ðµ Ð½Ð°Ð·Ð½Ð°Ñ‡ÐµÐ½ | `null` | `true` | "ÐÐµ Ð½Ð°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð°" |

### Ð—Ð°Ñ‚Ñ€Ð¾Ð½ÑƒÑ‚Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹

1. **`src/analytics/weekly-analytics.service.ts:415-438`**
   - Single-week query: Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½ `cogsUnitCostRub` Ð² select
   - ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° `margin.cogsUnitCostRub !== null`

2. **`src/analytics/weekly-analytics.service.ts:1771-1775`**
   - Date range query: Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ `weeks_with_cogs > 0`
   - `weeks_with_cogs` ÑÑ‡Ð¸Ñ‚Ð°ÐµÑ‚ Ð½ÐµÐ´ÐµÐ»Ð¸ Ñ `cogs_rub > 0`

---

## Related Documentation

- [Guide #24: Margin & COGS Integration](./24-margin-cogs-integration-guide.md)
- [Guide #29: COGS Temporal Versioning](./29-cogs-temporal-versioning-and-margin-calculation.md)
- [Request #19: Margin Without COGS Fix](./19-margin-returned-without-cogs-backend.md)
- [CLAUDE.md: Row Classification Rules](../../../CLAUDE.md)

---

**Last Updated**: 2025-11-28
